<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ercan BRGR - Envanter</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e85d04">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BRGR Envanter">
<link rel="apple-touch-icon" href="icon.svg">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--orange:#e85d04;--dark:#1a1a2e;--mid:#16213e;--deep:#0f3460}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Segoe UI',Arial,sans-serif;background:#f0f2f5;min-height:100vh}
#auth-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,var(--dark) 0%,var(--deep) 100%);padding:20px}
.auth-card{background:#fff;border-radius:20px;padding:36px 28px;width:100%;max-width:380px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
.auth-logo{font-size:44px;font-weight:900;color:var(--orange);letter-spacing:3px;margin-bottom:4px}
.auth-sub{font-size:11px;color:#aaa;margin-bottom:24px;letter-spacing:1px;text-transform:uppercase}
.auth-tabs{display:flex;gap:0;margin-bottom:20px;border:2px solid #eee;border-radius:10px;overflow:hidden}
.auth-tab{flex:1;padding:10px;font-size:13px;font-weight:700;border:none;background:#f8f8f8;cursor:pointer;color:#888;transition:all 0.2s}
.auth-tab.active{background:var(--orange);color:#fff}
.auth-field{margin-bottom:14px;text-align:left}
.auth-field label{font-size:11px;font-weight:700;color:#888;text-transform:uppercase;display:block;margin-bottom:5px}
.auth-field input{width:100%;padding:13px 14px;border:2px solid #eee;border-radius:10px;font-size:15px;outline:none;transition:border-color 0.2s}
.auth-field input:focus{border-color:var(--orange)}
.auth-btn{width:100%;padding:14px;background:var(--orange);color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;transition:background 0.2s;margin-top:4px}
.auth-btn:hover{background:#c44d02}
.auth-btn:disabled{background:#ccc;cursor:not-allowed}
.auth-err{color:#e74c3c;font-size:12px;min-height:18px;margin-top:6px;text-align:center}
.auth-note{font-size:11px;color:#aaa;margin-top:12px;line-height:1.5}
#sube-screen{display:none;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,var(--dark) 0%,var(--deep) 100%);padding:20px}
.sube-card{background:#fff;border-radius:20px;padding:36px 28px;width:100%;max-width:380px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
#loading-screen{display:none;align-items:center;justify-content:center;flex-direction:column;min-height:100vh;background:radial-gradient(ellipse at 50% 60%,#1a0800 0%,#0d0d0d 55%,#000 100%);gap:0;overflow:hidden;position:relative}
.sp-fire-ring{position:absolute;width:320px;height:320px;border-radius:50%;background:radial-gradient(circle,rgba(232,57,10,0.35) 0%,rgba(255,184,0,0.15) 40%,transparent 70%);animation:fireRingPulse 2.8s ease-in-out infinite;opacity:0;animation-delay:1.2s}
.sp-fire-ring2{position:absolute;width:480px;height:480px;border-radius:50%;background:radial-gradient(circle,rgba(255,184,0,0.12) 0%,transparent 65%);animation:fireRingPulse 3.5s ease-in-out 0.6s infinite}
.sp-sparks{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1}
.sp-spark{position:absolute;width:5px;height:5px;border-radius:50%;opacity:0}
.sp-spark:nth-child(1){left:48%;top:42%;background:#FFB800;animation:sparkFly1 1.2s ease-out 1.2s forwards}
.sp-spark:nth-child(2){left:52%;top:40%;background:#E8390A;animation:sparkFly2 1s ease-out 1.4s forwards}
.sp-spark:nth-child(3){left:45%;top:44%;background:#FFB800;animation:sparkFly3 1.4s ease-out 1.1s forwards}
.sp-spark:nth-child(4){left:55%;top:43%;background:#fff176;animation:sparkFly4 1.1s ease-out 1.6s forwards}
.sp-spark:nth-child(5){left:50%;top:38%;background:#E8390A;animation:sparkFly1 1.3s ease-out 1.8s forwards}
.sp-spark:nth-child(6){left:43%;top:46%;background:#FFB800;animation:sparkFly3 0.9s ease-out 2s forwards}
.sp-spark:nth-child(7){left:57%;top:45%;background:#E8390A;animation:sparkFly2 1.2s ease-out 2.1s forwards}
.sp-spark:nth-child(8){left:49%;top:50%;background:#FFB800;animation:sparkFly4 1s ease-out 2.3s forwards}
.splash-icon{font-size:130px;line-height:1;filter:drop-shadow(0 0 30px #E8390A) drop-shadow(0 0 60px rgba(255,184,0,0.6)) drop-shadow(0 8px 24px rgba(0,0,0,0.9));animation:burgerBoom 2s cubic-bezier(0.22,1.5,0.5,1) 0.8s forwards;opacity:0;transform:scale(0) translateY(60px) rotate(-25deg);position:relative;z-index:5}
.splash-icon.landed{animation:burgerFloat 4s ease-in-out infinite!important;opacity:1!important}
.splash-logo{display:flex;flex-direction:column;align-items:center;gap:4px;position:relative;z-index:5}
.splash-brand{display:flex;gap:0;align-items:center;margin-top:14px}
.splash-brand .letter{font-size:62px;font-weight:900;color:#FFB800;letter-spacing:2px;opacity:0;transform:translateY(50px) scale(0.3) rotateX(90deg);display:inline-block;text-shadow:0 0 30px rgba(255,184,0,0.9),0 4px 24px rgba(0,0,0,1);font-style:italic;transition:none}
.splash-brand .letter.orange{color:#E8390A;text-shadow:0 0 40px #E8390A,0 0 80px rgba(232,57,10,0.7),0 4px 24px rgba(0,0,0,1)}
.splash-brand .gap{width:16px;display:inline-block}
.splash-tagline{font-size:13px;letter-spacing:7px;color:rgba(255,184,0,0.7);text-transform:uppercase;margin-top:10px;opacity:0;animation:taglineIn 1.5s ease 9s forwards;text-shadow:0 0 20px rgba(232,57,10,0.5)}
.splash-divider{display:flex;align-items:center;gap:12px;margin-top:20px;opacity:0;animation:fadeIn 1.2s ease 10s forwards}
.splash-divider-line{width:60px;height:2px;background:linear-gradient(90deg,transparent,#FFB800);box-shadow:0 0 8px #FFB800}
.splash-divider-line.right{background:linear-gradient(90deg,#E8390A,transparent)}
.splash-divider-dot{width:6px;height:6px;border-radius:50%;background:#E8390A;box-shadow:0 0 12px #E8390A,0 0 24px rgba(232,57,10,0.6)}
.splash-progress{width:200px;height:3px;background:rgba(255,255,255,0.1);border-radius:3px;margin-top:32px;overflow:hidden;opacity:0;animation:fadeIn 0.5s ease 11s forwards}
.splash-progress-bar{height:100%;width:0;background:linear-gradient(90deg,#E8390A,#FFB800,#fff);border-radius:3px;box-shadow:0 0 10px #FFB800;animation:progressFill 3s cubic-bezier(0.4,0,0.2,1) 11s forwards}
.splash-loading-text{font-size:10px;letter-spacing:4px;color:rgba(255,255,255,0.3);text-transform:uppercase;margin-top:10px;opacity:0;animation:fadeIn 0.5s ease 11.2s forwards}
@keyframes fireRingPulse{0%,100%{transform:scale(0.9);opacity:0.6}50%{transform:scale(1.15);opacity:1}}
@keyframes burgerBoom{0%{opacity:0;transform:scale(0) translateY(60px) rotate(-25deg)}50%{opacity:1;transform:scale(1.35) translateY(-20px) rotate(10deg)}75%{transform:scale(0.92) translateY(5px) rotate(-4deg)}90%{transform:scale(1.06) translateY(-4px) rotate(2deg)}100%{opacity:1;transform:scale(1) translateY(0) rotate(0deg)}}
@keyframes burgerFloat{0%,100%{transform:translateY(0) rotate(0deg)}40%{transform:translateY(-10px) rotate(3deg)}70%{transform:translateY(-5px) rotate(-2deg)}}
@keyframes letterIn{to{opacity:1;transform:translateY(0) scale(1) rotateX(0deg)}}
@keyframes fadeIn{to{opacity:1}}
@keyframes taglineIn{from{opacity:0;letter-spacing:12px}to{opacity:1;letter-spacing:7px}}
@keyframes progressFill{to{width:100%}}
@keyframes sparkFly1{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(-60px,-80px) scale(0);}}
@keyframes sparkFly2{0%{opacity:1;transform:translate(0,0) scale(1.5)}100%{opacity:0;transform:translate(50px,-100px) scale(0)}}
@keyframes sparkFly3{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(-80px,-60px) scale(0)}}
@keyframes sparkFly4{0%{opacity:1;transform:translate(0,0) scale(2)}100%{opacity:0;transform:translate(70px,-90px) scale(0)}}
#loading-screen.fade-out{animation:splashFadeOut 1s cubic-bezier(0.4,0,1,1) forwards}
@keyframes splashFadeOut{0%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(1.15) translateY(-30px)}}
#app{display:none;min-height:100vh;flex-direction:column}
#topbar{background:var(--dark);color:#fff;padding:10px 10px;display:flex;align-items:center;gap:6px;position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,0.3);flex-wrap:nowrap;overflow:hidden}
#menu-btn{background:none;border:none;color:#fff;font-size:22px;cursor:pointer;padding:4px 6px;border-radius:6px;line-height:1;flex-shrink:0}
#menu-btn:hover{background:rgba(255,255,255,0.1)}
#topbar-title{flex:1;font-size:13px;font-weight:700;color:#fff;cursor:pointer;min-width:0;overflow:hidden}
#topbar-title #product-name-display{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
#topbar-title span#topbar-sub{display:block;font-size:9px;color:var(--orange);font-weight:400;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#topbar-birim{background:rgba(255,255,255,0.1);border:none;color:#fff;padding:5px 6px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;outline:none;flex-shrink:0;max-width:72px}
#topbar-birim option{color:var(--dark);background:#fff}
.top-btn{padding:6px 10px;border-radius:8px;border:none;cursor:pointer;font-size:11px;font-weight:700;white-space:nowrap;flex-shrink:0}
.top-btn-add{background:var(--orange);color:#fff}
.top-btn-add:hover{background:#c44d02}
.top-btn-menu{background:rgba(255,255,255,0.1);color:#fff}
#topbar-user{font-size:10px;color:#ffb380;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70px;flex-shrink:0}
#sync-indicator{font-size:16px;cursor:default;transition:opacity 0.3s;flex-shrink:0}
#drawer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200}
#drawer-overlay.open{display:block}
#drawer{position:fixed;left:-280px;top:0;bottom:0;width:280px;background:var(--dark);z-index:201;transition:left 0.3s ease;display:flex;flex-direction:column;overflow:hidden}
#drawer.open{left:0}
#drawer-header{background:var(--orange);padding:20px 16px;display:flex;align-items:center;justify-content:space-between}
#drawer-header .brand{font-size:20px;font-weight:900;color:#fff;letter-spacing:2px}
#drawer-close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer}
#drawer-search{padding:12px;background:var(--mid)}
#drawer-search input{width:100%;padding:8px 12px;border-radius:8px;border:none;background:var(--deep);color:#fff;font-size:13px;outline:none}
#drawer-search input::placeholder{color:#888}
#product-list{flex:1;overflow-y:auto;padding:6px 0}
#product-list::-webkit-scrollbar{width:3px}
#product-list::-webkit-scrollbar-thumb{background:var(--orange);border-radius:3px}
.product-item{padding:12px 16px;cursor:pointer;font-size:13px;border-left:3px solid transparent;display:flex;align-items:center;gap:8px;color:#ccc;transition:all 0.15s}
.product-item:hover,.product-item.active{background:var(--deep);border-left-color:var(--orange);color:#fff}
.product-item .num{font-size:10px;color:#666;min-width:20px}
.product-item .pname{flex:1;font-size:13px}
.product-item .badge{font-size:10px;background:var(--orange);color:#fff;border-radius:10px;padding:1px 7px}
.drawer-footer{padding:12px 16px;border-top:1px solid var(--deep);display:flex;flex-direction:column;gap:8px}
.drawer-footer-info{font-size:11px;color:#666;word-break:break-all}
.drawer-btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-size:12px;font-weight:700;width:100%;text-align:center}
.drawer-btn-orange{background:var(--orange);color:#fff}
.drawer-btn-gray{background:rgba(255,255,255,0.1);color:#aaa}
.drawer-btn-red{background:#c0392b;color:#fff}
.admin-badge{background:#f39c12;color:#fff;font-size:9px;font-weight:900;padding:2px 6px;border-radius:8px;letter-spacing:1px;text-transform:uppercase}
#content{flex:1;padding:12px;overflow-x:hidden}
.stats-row{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:12px}
@media(min-width:600px){.stats-row{grid-template-columns:repeat(4,1fr)}}
.stat-card{background:#fff;border-radius:12px;padding:12px 14px;border-left:4px solid var(--orange);box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.stat-card .sl{font-size:10px;color:#999;font-weight:600;text-transform:uppercase}
.stat-card .sv{font-size:22px;font-weight:800;color:var(--dark)}
.stat-card.green{border-left-color:#2ecc71}.stat-card.green .sv{color:#27ae60}
.stat-card.red{border-left-color:#e74c3c}.stat-card.red .sv{color:#e74c3c}
.stat-card.orange .sv{color:var(--orange)}
.add-card{background:#fff;border-radius:12px;padding:16px;margin-bottom:12px;border-top:3px solid var(--orange);box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.add-card h3{font-size:14px;color:var(--dark);margin-bottom:14px;font-weight:700}
.form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(min-width:500px){.form-grid{grid-template-columns:repeat(3,1fr)}}
@media(min-width:768px){.form-grid{grid-template-columns:repeat(5,1fr)}}
.ff{display:flex;flex-direction:column;gap:4px}
.ff label{font-size:10px;font-weight:700;color:#999;text-transform:uppercase}
.ff input,.ff select{padding:10px;border:2px solid #eee;border-radius:8px;font-size:14px;outline:none;transition:border-color 0.15s;width:100%}
.ff input:focus{border-color:var(--orange)}
.ff input.calc{background:#f8f8f8;font-weight:700;border-color:#e0e0e0;cursor:default}
.ff input.fpos{background:#eafaf1;color:#27ae60;font-weight:800;border-color:#a9dfbf}
.ff input.fneg{background:#fdf2f2;color:#e74c3c;font-weight:800;border-color:#f5b7b1}
.form-actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.btn{padding:10px 18px;border-radius:8px;border:none;cursor:pointer;font-size:13px;font-weight:700;transition:all 0.15s}
.btn-primary{background:var(--orange);color:#fff}
.btn-primary:hover{background:#c44d02}
.btn-outline{background:transparent;border:2px solid var(--orange);color:var(--orange)}
.btn-outline:hover{background:var(--orange);color:#fff}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-danger{background:#e74c3c;color:#fff}
.table-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.scroll-hint{display:none;text-align:center;font-size:11px;color:#aaa;padding:6px;background:#fafafa;border-top:1px solid #f0f0f0;letter-spacing:1px}
@media(max-width:599px){.scroll-hint{display:block}tbody td input{min-width:52px}}
table{width:100%;border-collapse:collapse;font-size:12px;min-width:700px}
thead tr{background:var(--dark);color:#fff}
thead th{padding:10px 8px;text-align:center;font-size:11px;font-weight:600;white-space:nowrap;border-right:1px solid var(--deep)}
tbody tr{border-bottom:1px solid #f5f5f5;transition:background 0.1s}
tbody tr:hover{background:#fef9f5}
tbody td{padding:6px 6px;text-align:center;border-right:1px solid #f5f5f5}
tbody td input{width:100%;border:1px solid transparent;border-radius:4px;padding:5px 4px;text-align:center;font-size:12px;background:transparent;outline:none}
tbody td input:focus{border-color:var(--orange);background:#fff8f2}
td.calc{background:#f8f8f8;font-weight:700}
td.fp{background:#eafaf1;color:#27ae60;font-weight:800}
td.fn{background:#fdf2f2;color:#e74c3c;font-weight:800}
td.fz{background:#f5f5f5;color:#999;font-weight:700}
.del-btn{background:none;border:none;cursor:pointer;color:#ddd;font-size:13px;padding:3px 7px;border-radius:4px}
.del-btn:hover{color:#e74c3c;background:#fdf2f2}
.empty{text-align:center;padding:48px 20px;color:#bbb}
.empty .ico{font-size:48px;margin-bottom:12px}
.empty p{font-size:14px}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:300;align-items:center;justify-content:center;padding:20px}
.overlay.show{display:flex}
.modal{background:#fff;border-radius:16px;padding:24px;width:100%;max-width:340px;box-shadow:0 10px 40px rgba(0,0,0,0.2)}
.modal h3{font-size:16px;margin-bottom:16px;color:var(--dark)}
.modal input{width:100%;padding:12px;border:2px solid #eee;border-radius:8px;font-size:15px;outline:none;margin-bottom:14px}
.modal input:focus{border-color:var(--orange)}
.modal-actions{display:flex;gap:8px;justify-content:flex-end}
.admin-panel{background:#fff;border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.admin-panel h2{font-size:16px;color:var(--dark);margin-bottom:14px;font-weight:800;display:flex;align-items:center;gap:8px}
.sube-card-admin{border:1px solid #eee;border-radius:10px;padding:14px;margin-bottom:10px;cursor:pointer;transition:border-color 0.2s}
.sube-card-admin:hover{border-color:var(--orange)}
.sube-card-admin h3{font-size:14px;font-weight:700;color:var(--dark);margin-bottom:4px}
.sube-stats{display:flex;gap:8px;flex-wrap:wrap}
.sube-stat{background:#f8f8f8;border-radius:6px;padding:6px 10px;font-size:11px;font-weight:700;color:#555}
.sube-stat.s-green{background:#eafaf1;color:#27ae60}
.sube-stat.s-red{background:#fdf2f2;color:#e74c3c}
#bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #eee;padding:8px 16px;box-shadow:0 -2px 10px rgba(0,0,0,0.08);z-index:100}
@media(max-width:599px){#bottom-nav{display:flex;gap:8px;justify-content:center}}
#content{padding-bottom:80px}
@media(min-width:600px){#content{padding-bottom:12px}}
#install-bar{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--orange);color:#fff;padding:12px 16px;align-items:center;justify-content:space-between;z-index:500;font-size:13px;box-shadow:0 -2px 10px rgba(0,0,0,0.2)}
#install-bar.show{display:flex}
#toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:rgba(30,30,30,0.95);color:#fff;padding:10px 20px;border-radius:20px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:opacity 0.3s;pointer-events:none;white-space:nowrap}
#toast.show{opacity:1}
@media print{
  #auth-screen,#sube-screen,#loading-screen,#topbar,#drawer,#drawer-overlay,#bottom-nav,#install-bar,.add-card,.del-btn,.top-btn,.form-actions,#sync-indicator,#install-bar,select{display:none!important}
  body{background:#fff!important}
  #app{display:block!important}
  .table-card{box-shadow:none;break-inside:avoid}
  .table-scroll{overflow:visible}
  table{min-width:100%!important;font-size:10px}
  .stats-row{display:grid!important;margin-bottom:10px}
  .stat-card{border:1px solid #ddd;box-shadow:none}
  #content{padding:0!important;padding-bottom:0!important}
  .admin-panel{box-shadow:none}
  .print-only{display:block!important}
  @page{size:A4 landscape;margin:1.5cm}
}
.print-only{display:none}
</style>
</head>
<body>
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">BRGR</div>
    <div class="auth-sub">Ercan BRGR Envanter</div>
    <div id="auth-loading" style="display:none;text-align:center;padding:30px;color:var(--orange);font-size:16px">‚è≥ Y√ºkleniyor...</div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-giris" onclick="switchTab('giris')">Giri≈ü Yap</button>
      <button class="auth-tab" id="tab-kayit" onclick="switchTab('kayit')">Kayƒ±t Ol</button>
    </div>
    <div id="form-giris">
      <div class="auth-field"><label>E-posta</label><input type="email" id="giris-email" placeholder="ornek@mail.com" autocomplete="email" inputmode="email"></div>
      <div class="auth-field"><label>≈ûifre</label><input type="password" id="giris-sifre" placeholder="≈ûifreniz" autocomplete="current-password" onkeydown="if(event.key==='Enter')doGiris()"></div>
      <div class="auth-err" id="giris-err"></div>
      <button class="auth-btn" id="giris-btn" onclick="doGiris()">Giri≈ü Yap</button>
      <div style="text-align:center;margin-top:10px"><button onclick="doSifreSifirla()" style="background:none;border:none;color:var(--orange);font-size:13px;cursor:pointer;text-decoration:underline">≈ûifremi Unuttum</button></div>
      <div class="auth-note">Verileriniz buluta kaydedilir. Telefon deƒüi≈ütirseniz bile verileriniz g√ºvende.</div>
    </div>
    <div id="form-kayit" style="display:none">
      <div class="auth-field"><label>E-posta</label><input type="email" id="kayit-email" placeholder="ornek@mail.com" autocomplete="email" inputmode="email"></div>
      <div class="auth-field"><label>≈ûifre (en az 6 karakter)</label><input type="password" id="kayit-sifre" placeholder="≈ûifre belirleyin" autocomplete="new-password"></div>
      <div class="auth-field"><label>≈ûifre Tekrar</label><input type="password" id="kayit-sifre2" placeholder="≈ûifreyi tekrar girin" autocomplete="new-password" onkeydown="if(event.key==='Enter')doKayit()"></div>
      <div class="auth-err" id="kayit-err"></div>
      <button class="auth-btn" id="kayit-btn" onclick="doKayit()">Kayƒ±t Ol</button>
      <div class="auth-note">Her ≈üube kendi mail adresi ile kaydolur. Siler ve yeniden y√ºklese bile verileri kaybolmaz.</div>
    </div>
  </div>
</div>

<div id="sube-screen">
  <div class="sube-card">
    <div class="auth-logo">BRGR</div>
    <div class="auth-sub">Ercan BRGR Envanter</div>
    <div style="font-size:16px;font-weight:700;color:#333;margin-bottom:20px">≈ûubenizi Olu≈üturun</div>
    <div class="auth-field" style="text-align:left">
      <label>≈ûube Adƒ±</label>
      <input type="text" id="sube-input" placeholder="√ñrn: Kadƒ±k√∂y ≈ûubesi" style="padding:13px 14px;border:2px solid #eee;border-radius:10px;font-size:15px;outline:none;width:100%" onfocus="this.style.borderColor='#e85d04'" onblur="this.style.borderColor='#eee'" onkeydown="if(event.key==='Enter')saveSube()">
      <div style="font-size:11px;color:#aaa;margin-top:6px">Bu isim uygulamanƒ±n √ºst kƒ±smƒ±nda g√∂r√ºn√ºr</div>
    </div>
    <div class="auth-err" id="sube-err"></div>
    <button onclick="saveSube()" style="width:100%;padding:14px;background:#e85d04;color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;margin-top:8px">Ba≈üla ‚Üí</button>
  </div>
</div>

<div id="loading-screen">
  <div class="sp-fire-ring2"></div>
  <div class="sp-fire-ring"></div>
  <div class="sp-sparks">
    <div class="sp-spark"></div><div class="sp-spark"></div><div class="sp-spark"></div><div class="sp-spark"></div>
    <div class="sp-spark"></div><div class="sp-spark"></div><div class="sp-spark"></div><div class="sp-spark"></div>
  </div>
  <div class="splash-icon" id="splash-burger">üçî</div>
  <div class="splash-logo">
    <div class="splash-brand" id="splash-brand-letters"></div>
    <div class="splash-tagline">Envanter &nbsp;‚Ä¢&nbsp; Stok Takip</div>
    <div class="splash-divider">
      <div class="splash-divider-line"></div>
      <div class="splash-divider-dot"></div>
      <div class="splash-divider-line right"></div>
    </div>
  </div>
  <div class="splash-progress"><div class="splash-progress-bar"></div></div>
  <div class="splash-loading-text">Y√ºkleniyor...</div>
</div>

<div id="app">
  <div id="topbar">
    <button id="menu-btn" onclick="toggleDrawer()">&#9776;</button>
    <div id="topbar-title" onclick="openRenameModal()">
      <span id="product-name-display">√úr√ºn Se√ßin</span>
      <span id="topbar-sub" style="font-size:10px;color:#ffb380">Ada tƒ±klayarak deƒüi≈ütir</span>
    </div>
    <div id="topbar-user" title="Oturum bilgisi"></div>
    <span id="sync-indicator" title="Senkronizasyon durumu">‚òÅÔ∏è</span>
    <select id="topbar-birim" onchange="saveBirim()" title="Birim">
      <option value="Adet">Adet</option><option value="Kg">Kg</option>
      <option value="Lt">Lt</option><option value="Paket">Paket</option><option value="Kutu">Kutu</option>
    </select>
    <button class="top-btn top-btn-add" onclick="toggleAddForm()">+ Ekle</button>
    <button class="top-btn top-btn-menu" onclick="window.print()" title="Yazdƒ±r">üñ®</button>
  </div>
  <div id="drawer-overlay" onclick="closeDrawer()"></div>
  <div id="drawer">
    <div id="drawer-header">
      <div>
        <div class="brand">BRGR ENVANTERƒ∞</div>
        <div id="drawer-sube-info" style="font-size:13px;font-weight:700;color:rgba(255,255,255,0.9);margin-top:2px"></div>
        <div id="drawer-user-info" style="font-size:10px;color:rgba(255,255,255,0.55);margin-top:1px"></div>
      </div>
      <button id="drawer-close" onclick="closeDrawer()">&#10005;</button>
    </div>
    <div id="drawer-search"><input type="text" id="search-input" placeholder="√úr√ºn ara..." oninput="filterProducts()"></div>
    <div id="product-list"></div>
    <div class="drawer-footer">
      <button class="drawer-btn drawer-btn-orange" onclick="openSubeModal()">≈ûube Adƒ±nƒ± Deƒüi≈ütir</button>
      <button class="drawer-btn" style="background:#e67e22;color:#fff" onclick="setMinStok();closeDrawer()">‚ö†Ô∏è Min Stok Uyarƒ±sƒ± Ayarla</button>
      <button class="drawer-btn" style="background:#2c3e50;color:#fff" onclick="printUrunRaporu()">üìÑ PDF / Yazdƒ±r</button>
      <button class="drawer-btn" style="background:#3498db;color:#fff" onclick="openSatisModal();closeDrawer()">üìä Satƒ±≈ü Raporu Y√ºkle</button>
      <button class="drawer-btn" style="background:#c0392b;color:#fff" onclick="openSktModal();closeDrawer()">‚è∞ SKT Takibi</button>
      <button class="drawer-btn drawer-btn-red" onclick="doSignOut()">√áƒ±kƒ±≈ü Yap</button>
    </div>
  </div>
  <div id="content"><div id="skt-banner" style="display:none"></div><div id="page-content"></div></div>
  <div id="bottom-nav">
    <button class="btn btn-primary" style="flex:1" onclick="toggleAddForm()">+ G√ºn Ekle</button>
    <button class="btn" style="background:#f0f0f0;color:#333" onclick="window.print()">Yazdƒ±r</button>
  </div>
</div>

<div class="overlay" id="satis-modal">
  <div class="modal" style="max-width:560px;max-height:92vh;overflow-y:auto;padding:20px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <h3 style="margin:0;font-size:16px">üìä Satƒ±≈ü Raporu Analizi</h3>
      <button onclick="closeSatisModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#aaa;line-height:1">‚úï</button>
    </div>
    <div style="font-size:12px;color:#aaa;margin-bottom:10px">POS raporunun t√ºm metnini a≈üaƒüƒ±ya yapƒ±≈ütƒ±rƒ±n</div>
    <textarea id="satis-text" rows="9" style="width:100%;padding:10px;border:2px solid #eee;border-radius:8px;font-size:11px;font-family:monospace;resize:vertical;outline:none;margin-bottom:10px" placeholder="JOKER ALEV ALEV BU      1        370,00&#10;TASTY CHEESE BURGE      2        940,00&#10;..." onfocus="this.style.borderColor='#e85d04'" onblur="this.style.borderColor='#eee'"></textarea>
    <button onclick="analizEt()" style="width:100%;padding:12px;background:var(--orange);color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;margin-bottom:12px">Analiz Et ‚Üí</button>
    <div id="analiz-sonuc"></div>
  </div>
</div>


<div class="overlay" id="rename-modal">  <div class="modal">
    <h3>√úr√ºn Adƒ±nƒ± Deƒüi≈ütir</h3>
    <input type="text" id="rename-input" placeholder="Yeni √ºr√ºn adƒ±">
    <div class="modal-actions">
      <button class="btn btn-outline btn-sm" onclick="closeRenameModal()">ƒ∞ptal</button>
      <button class="btn btn-primary btn-sm" onclick="confirmRename()">Kaydet</button>
    </div>
  </div>
</div>

<div id="install-bar">  <span>Bu uygulamayƒ± telefona y√ºkleyin!</span>
  <div style="display:flex;gap:8px">
    <button onclick="installApp()" style="background:#fff;color:var(--orange);border:none;padding:8px 14px;border-radius:6px;font-weight:700;cursor:pointer">Y√ºkle</button>
    <button onclick="document.getElementById('install-bar').classList.remove('show')" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.5);padding:8px 10px;border-radius:6px;cursor:pointer">‚úï</button>
  </div>
</div>
<div id="toast"></div>

<div class="overlay" id="skt-modal">
  <div class="modal" style="max-width:520px;max-height:90vh;overflow-y:auto;padding:20px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <h3 style="margin:0;font-size:16px">‚è∞ SKT (Son Kullanma Tarihi) Takibi</h3>
      <button onclick="closeSktModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#999">‚úï</button>
    </div>
    <div style="background:#fff3cd;border-radius:8px;padding:10px 12px;margin-bottom:12px;font-size:12px;color:#856404">Yakla≈üan veya ge√ßmi≈ü SKT tarihli √ºr√ºnleri buraya ekleyin. 5 g√ºn kala ve son g√ºn uyarƒ± verir.</div>
    <div style="display:grid;grid-template-columns:1fr 90px 110px auto;gap:8px;margin-bottom:14px;align-items:center">
      <input type="text" id="skt-urun" placeholder="√úr√ºn adƒ±" style="padding:10px 12px;border:2px solid #eee;border-radius:8px;font-size:13px;outline:none" onfocus="this.style.borderColor='#c0392b'" onblur="this.style.borderColor='#eee'">
      <input type="text" id="skt-miktar" placeholder="Miktar" style="padding:10px 8px;border:2px solid #eee;border-radius:8px;font-size:13px;outline:none;text-align:center" onfocus="this.style.borderColor='#c0392b'" onblur="this.style.borderColor='#eee'">
      <input type="date" id="skt-tarih" style="padding:10px 8px;border:2px solid #eee;border-radius:8px;font-size:13px;outline:none" onfocus="this.style.borderColor='#c0392b'" onblur="this.style.borderColor='#eee'">
      <button onclick="addSktEntry()" style="padding:10px 14px;background:#c0392b;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer">+ Ekle</button>
    </div>
    <div id="skt-list"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
const SUPA_URL='https://gqhfxpczgxksbfybfesz.supabase.co';
const SUPA_KEY='sb_publishable_0L6Pcm4GYzaEyIQ8Dup-6A_LqT-Z-FS';
const {createClient}=supabase;
const sb=createClient(SUPA_URL,SUPA_KEY);
let currentUser=null,isAdmin=false,appData={products:[]},currentProduct=0,showAddForm=false,syncTimeout=null;
const DEFAULT_PRODUCTS=[
  {name:'Mini Et Burger',birim:'Kg'},{name:'Joker Burger',birim:'Kg'},
  {name:'Super Burger',birim:'Kg'},{name:'Tasty Burger',birim:'Kg'},
  {name:'Special',birim:'Kg'},{name:'Mini Tavuk',birim:'Kg'},
  {name:'Tavuk Burger',birim:'Kg'},{name:'Tenders',birim:'Kg'},
  {name:'Patates',birim:'Kg'},{name:'Nugget',birim:'Kg'},
  {name:'Soƒüan Halkasƒ±',birim:'Kg'},{name:'√áƒ±tƒ±r Tavuk',birim:'Kg'},
  {name:'Stick Peynir',birim:'Adet'},{name:'Karamelize Soƒüan',birim:'Kg'},
  {name:'F√ºme',birim:'Kg'},{name:'Kƒ±zartma Yaƒüƒ±',birim:'Lt'},
  {name:'80 gr Ekmek',birim:'Adet'},{name:'Mini Ekmek',birim:'Adet'},
  {name:'Kutu ƒ∞√ßecekler',birim:'Adet'},{name:'Soda Grubu',birim:'Adet'},
  {name:'1 Litrelik ƒ∞√ßecekler',birim:'Adet'},{name:'√úr√ºn 22',birim:'Adet'},
  {name:'√úr√ºn 23',birim:'Adet'},{name:'√úr√ºn 24',birim:'Adet'},{name:'√úr√ºn 25',birim:'Adet'}
];
function toast(msg,dur=2500){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),dur);}
function switchTab(tab){document.getElementById('tab-giris').classList.toggle('active',tab==='giris');document.getElementById('tab-kayit').classList.toggle('active',tab==='kayit');document.getElementById('form-giris').style.display=tab==='giris'?'':'none';document.getElementById('form-kayit').style.display=tab==='kayit'?'':'none';}
async function doGiris(){const email=document.getElementById('giris-email').value.trim(),pass=document.getElementById('giris-sifre').value,errEl=document.getElementById('giris-err'),btn=document.getElementById('giris-btn');if(!email||!pass){errEl.textContent='E-posta ve ≈üifre girin';return;}btn.disabled=true;btn.textContent='Giri≈ü yapƒ±lƒ±yor...';errEl.textContent='';const{data,error}=await sb.auth.signInWithPassword({email,password:pass});btn.disabled=false;btn.textContent='Giri≈ü Yap';if(error){let msg='Giri≈ü ba≈üarƒ±sƒ±z';if(error.message.includes('Invalid login'))msg='E-posta veya ≈üifre hatalƒ±';else if(error.message.includes('Email not confirmed'))msg='E-postanƒ±zƒ± onaylayƒ±n';errEl.textContent=msg;return;}await onSignedIn(data.user);}
async function doKayit(){const email=document.getElementById('kayit-email').value.trim(),pass=document.getElementById('kayit-sifre').value,pass2=document.getElementById('kayit-sifre2').value,errEl=document.getElementById('kayit-err'),btn=document.getElementById('kayit-btn');if(!email||!pass){errEl.textContent='E-posta ve ≈üifre girin';return;}if(pass.length<6){errEl.textContent='≈ûifre en az 6 karakter olmalƒ±';return;}if(pass!==pass2){errEl.textContent='≈ûifreler e≈üle≈ümiyor';return;}btn.disabled=true;btn.textContent='Kayƒ±t olunuyor...';errEl.textContent='';const{data,error}=await sb.auth.signUp({email,password:pass});btn.disabled=false;btn.textContent='Kayƒ±t Ol';if(error){let msg='Kayƒ±t ba≈üarƒ±sƒ±z';if(error.message.includes('already registered'))msg='Bu e-posta zaten kayƒ±tlƒ±, giri≈ü yapƒ±n';else if(error.message.includes('invalid'))msg='Ge√ßerli bir e-posta girin';errEl.textContent=msg;return;}if(data.user&&!data.session){errEl.style.color='#27ae60';errEl.textContent='Onay e-postasƒ± g√∂nderildi! Gelen kutunuzu kontrol edin.';return;}await onSignedIn(data.user);}
async function doSifreSifirla(){const email=document.getElementById('giris-email').value.trim();if(!email){document.getElementById('giris-err').textContent='√ñnce e-posta adresinizi girin';return;}const{error}=await sb.auth.resetPasswordForEmail(email,{redirectTo:'https://ercanbrgr.github.io/envanter-site'});if(error){document.getElementById('giris-err').textContent='Hata: '+error.message;return;}document.getElementById('giris-err').style.color='#27ae60';document.getElementById('giris-err').textContent='≈ûifre sƒ±fƒ±rlama linki e-postanƒ±za g√∂nderildi!';}
async function doSignOut(){if(!confirm('√áƒ±kƒ±≈ü yapmak istediƒüinize emin misiniz?'))return;await sb.auth.signOut();currentUser=null;isAdmin=false;appData={products:[]};showScreen('auth-screen');}
function showScreen(id){['auth-screen','sube-screen','loading-screen','app'].forEach(s=>{const el=document.getElementById(s);if(s==='app'){el.style.display=s===id?'flex':'none';if(s===id)el.style.flexDirection='column';}else{el.style.display=s===id?'flex':'none';}});if(id==='loading-screen')initSplashLetters();}
function initSplashLetters(){const el=document.getElementById('splash-brand-letters');if(!el||el._inited)return;el._inited=true;const letters=[{c:'E',o:false},{c:'R',o:false},{c:'C',o:false},{c:'A',o:false},{c:'N',o:false},{c:' ',gap:true},{c:'B',o:true},{c:'R',o:true},{c:'G',o:true},{c:'R',o:true}];el.innerHTML='';letters.forEach((l,i)=>{if(l.gap){const g=document.createElement('span');g.className='gap';el.appendChild(g);return;}const s=document.createElement('span');s.className='letter'+(l.o?' orange':'');s.textContent=l.c;el.appendChild(s);const delay=2800+(i*320);setTimeout(()=>{s.style.animation='letterIn 1s cubic-bezier(0.22,1.6,0.5,1) forwards';},delay);});const burger=document.getElementById('splash-burger');if(burger)setTimeout(()=>burger.classList.add('landed'),3000);}
async function onSignedIn(user){try{currentUser=user;const profil=await loadProfil();if(!profil){showScreen('sube-screen');setTimeout(()=>document.getElementById('sube-input').focus(),300);return;}isAdmin=(profil.rol==='admin');await loadAllData();loadSktData();openApp();}catch(err){showScreen('auth-screen');document.getElementById('giris-err').style.color='#e74c3c';document.getElementById('giris-err').textContent='Y√ºkleme hatasƒ±: '+err.message;}}
async function loadProfil(){const{data}=await sb.from('sube_profiller').select('*').eq('user_id',currentUser.id).single();return data;}
async function saveSube(){const sube=document.getElementById('sube-input').value.trim();if(!sube){document.getElementById('sube-err').textContent='≈ûube adƒ± girin';return;}document.getElementById('sube-err').textContent='';const{error}=await sb.from('sube_profiller').upsert({user_id:currentUser.id,sube_adi:sube});if(error){document.getElementById('sube-err').textContent='Kaydedilemedi: '+error.message;return;}await initDefaultProducts();await loadAllData();openApp();}
async function addNewProduct(){const ad=prompt('Yeni √ºr√ºn adƒ±:');if(!ad||!ad.trim())return;const birim=prompt('Birimi (Adet / Kg / Lt / Paket / Kutu):','Adet')||'Adet';const sira=appData.products.length;const{data,error}=await sb.from('urunler').insert({user_id:currentUser.id,sira,ad:ad.trim(),birim,koli:'',adet_koli:''}).select().single();if(error){toast('Eklenemedi: '+error.message,4000);return;}appData.products.push({id:data.id,sira,name:ad.trim(),birim,koli:'',adet:'',entries:[]});currentProduct=appData.products.length-1;showAddForm=false;renderSidebar();renderPage();closeDrawer();toast('√úr√ºn eklendi: '+ad.trim());}
async function openSubeModal(){const profil=await loadProfil();const yeni=prompt('Yeni ≈üube adƒ±:',profil?.sube_adi||'');if(yeni&&yeni.trim()){await sb.from('sube_profiller').upsert({user_id:currentUser.id,sube_adi:yeni.trim()});document.getElementById('topbar-user').textContent=yeni.trim();document.getElementById('drawer-sube-info').textContent=yeni.trim();toast('≈ûube adƒ± g√ºncellendi');}}
async function loadAllData(){const{data:urunler}=await sb.from('urunler').select('*').eq('user_id',currentUser.id).order('sira');const{data:girdiler}=await sb.from('gunluk_girdiler').select('*').eq('user_id',currentUser.id).order('tarih',{ascending:true});appData.products=(urunler||[]).map(u=>({id:u.id,sira:u.sira,name:u.ad,birim:u.birim||'Adet',koli:u.koli||'',adet:u.adet_koli||'',minStok:u.min_stok??null,birimFiyat:u.birim_fiyat||0,entries:(girdiler||[]).filter(g=>g.urun_sira===u.sira).map(g=>({dbId:g.id,gun:g.gun||'',tarih:g.tarih||'',acilis:g.acilis||'',gelen:g.gelen||'',gelenIade:g.gelen_iade||'',transfer:g.transfer||'',kapanis:g.kapanis||'',mallara:g.mallara_gore||'',zayi:g.zayi||'',odenmez:g.odenmez||'',not:g.gun_notu||''}))}))}
async function initDefaultProducts(){const inserts=DEFAULT_PRODUCTS.map((p,i)=>({user_id:currentUser.id,sira:i,ad:p.name,birim:p.birim,koli:'',adet_koli:''}));await sb.from('urunler').upsert(inserts,{onConflict:'user_id,sira'});}
async function openApp(){showScreen('app');const profil=await loadProfil();const subeAdi=profil?.sube_adi||currentUser.email;document.getElementById('topbar-user').textContent=subeAdi;document.getElementById('drawer-sube-info').textContent=subeAdi;document.getElementById('drawer-user-info').textContent=currentUser.email;setSyncIcon('ok');if(isAdmin){document.getElementById('topbar-user').innerHTML=subeAdi+' <span class="admin-badge">ADMƒ∞N</span>';}renderSidebar();if(isAdmin)renderAdminPanel();else renderPage();}
function setSyncIcon(state){const el=document.getElementById('sync-indicator');if(state==='ok')el.textContent='‚òÅÔ∏è';else if(state==='saving')el.textContent='üîÑ';else if(state==='err')el.textContent='‚ö†Ô∏è';}
function toggleDrawer(){document.getElementById('drawer').classList.toggle('open');document.getElementById('drawer-overlay').classList.toggle('open');}
function closeDrawer(){document.getElementById('drawer').classList.remove('open');document.getElementById('drawer-overlay').classList.remove('open');}
function renderSidebar(filter=''){const list=document.getElementById('product-list');list.innerHTML='';if(isAdmin){const div=document.createElement('div');div.className='product-item'+(currentProduct===-1?' active':'');div.innerHTML='<span class="num">‚≠ê</span><span class="pname">Admin Paneli</span>';div.onclick=()=>{currentProduct=-1;showAddForm=false;renderAdminPanel();closeDrawer();};list.appendChild(div);}appData.products.forEach((p,i)=>{if(filter&&!p.name.toLowerCase().includes(filter.toLowerCase()))return;const lastKapanis=p.entries.length?parseFloat(p.entries[p.entries.length-1].kapanis||''):null;const uyari=p.minStok!==null&&lastKapanis!==null&&lastKapanis<p.minStok;const div=document.createElement('div');div.className='product-item'+(i===currentProduct?' active':'');div.innerHTML=`<span class="num">${i+1}</span><span class="pname">${p.name}${uyari?` <span style="color:#e74c3c;font-size:10px;font-weight:700">‚ö†Ô∏è AZ</span>`:''}</span>${p.entries.length?`<span class="badge">${p.entries.length}</span>`:''}`;div.onclick=()=>{currentProduct=i;showAddForm=false;renderSidebar(document.getElementById('search-input').value);renderPage();closeDrawer();};list.appendChild(div);});}
function filterProducts(){renderSidebar(document.getElementById('search-input').value);}
function n(v){return parseFloat(String(v).replace(',','.'))||0;}
function r(v){return Math.round(v*100)/100;}
function calcEntry(e){const a=n(e.acilis),g=n(e.gelen),gi=n(e.gelenIade),t=n(e.transfer),k=n(e.kapanis),m=n(e.mallara),z=n(e.zayi),o=n(e.odenmez);const sayima=r(a+g-gi-t-k);return{sayima,fark:r(m-sayima+z+o)};}
function getStats(entries){if(!entries.length)return{last:'-',totalFark:0,posCount:0,negCount:0};let totalFark=0,posCount=0,negCount=0;entries.forEach(e=>{const{fark}=calcEntry(e);totalFark+=fark;if(fark>0)posCount++;else if(fark<0)negCount++;});const last=entries[entries.length-1];return{last:last.kapanis!==''?last.kapanis:'-',totalFark:r(totalFark),posCount,negCount};}
let selectedMonth=new Date().toISOString().slice(0,7);
function getMonthOptions(entries){const months=new Set();entries.forEach(e=>{if(e.tarih&&e.tarih.length>=7)months.add(e.tarih.slice(0,7));});return[...months].sort().reverse();}
function monthLabel(ym){if(!ym)return'T√ºm√º';const[y,m]=ym.split('-');const adlar=['','Ocak','≈ûubat','Mart','Nisan','Mayƒ±s','Haziran','Temmuz','Aƒüustos','Eyl√ºl','Ekim','Kasƒ±m','Aralƒ±k'];return adlar[parseInt(m)]+' '+y;}
function changeMonth(val){selectedMonth=val;renderPage();}
function renderPage(){if(!appData.products.length){document.getElementById('page-content').innerHTML='<div class="empty"><div class="ico">‚è≥</div><p>Veriler y√ºkleniyor...</p></div>';return;}const p=appData.products[currentProduct];if(!p)return;const birim=p.birim||'Adet';document.getElementById('product-name-display').textContent=p.name;document.getElementById('topbar-sub').textContent=`${birim} ‚Ä¢ Ada tƒ±kla deƒüi≈ütir`;const birimEl=document.getElementById('topbar-birim');if(birimEl)birimEl.value=birim;const months=getMonthOptions(p.entries);if(months.length&&!months.includes(selectedMonth))selectedMonth=months[0]||selectedMonth;const filtered=selectedMonth==='tumu'?p.entries:p.entries.filter(e=>e.tarih&&e.tarih.startsWith(selectedMonth));const stats=getStats(filtered);const fc=stats.totalFark>0?'green':stats.totalFark<0?'red':'';let monthBar=`<div style="background:#fff;border-radius:12px;padding:10px 14px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,0.06);display:flex;align-items:center;gap:10px;flex-wrap:wrap"><span style="font-size:11px;font-weight:700;color:#999;text-transform:uppercase">Ay Filtresi</span><select onchange="changeMonth(this.value)" style="padding:7px 12px;border:2px solid #eee;border-radius:8px;font-size:13px;font-weight:700;outline:none;color:#333"><option value="tumu" ${selectedMonth==='tumu'?'selected':''}>T√ºm√º</option>${months.map(m=>`<option value="${m}" ${m===selectedMonth?'selected':''}>${monthLabel(m)}</option>`).join('')}</select><span style="font-size:12px;color:#aaa">${filtered.length} giri≈ü</span></div>`;
// --- Ayƒ±n √úr√ºn√º & Top 3 ---
const topKartHtml=(()=>{const sarki=selectedMonth==='tumu'?null:selectedMonth;const urunSatis=appData.products.map(pr=>{const ents=sarki?pr.entries.filter(e=>e.tarih&&e.tarih.startsWith(sarki)):pr.entries;const toplam=ents.reduce((s,e)=>s+n(e.mallara),0);return{name:pr.name,birim:pr.birim||'Adet',toplam:r(toplam)};}).filter(x=>x.toplam>0).sort((a,b)=>b.toplam-a.toplam);if(!urunSatis.length)return '';const ayinUrunu=urunSatis[0];const madalyalar=['ü•á','ü•à','ü•â'];const top3=urunSatis.slice(0,3);const sarLabel=sarki?monthLabel(sarki):'T√ºm Zamanlar';return `<div style="background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);border-radius:16px;padding:14px 16px;margin-bottom:14px;box-shadow:0 4px 16px rgba(0,0,0,0.15)"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px"><span style="font-size:11px;font-weight:700;color:#ffb380;letter-spacing:2px;text-transform:uppercase">üèÜ ${sarLabel} En √áok Satan</span></div><div style="background:linear-gradient(135deg,#e85d04,#ff9a00);border-radius:12px;padding:12px 16px;margin-bottom:10px;display:flex;align-items:center;gap:12px"><span style="font-size:36px">üî•</span><div><div style="font-size:18px;font-weight:900;color:#fff;letter-spacing:1px">${ayinUrunu.name}</div><div style="font-size:12px;color:rgba(255,255,255,0.85);margin-top:2px">${ayinUrunu.toplam} ${ayinUrunu.birim} satƒ±ldƒ±</div></div></div><div style="display:flex;gap:8px">${top3.map((u,i)=>`<div style="flex:1;background:rgba(255,255,255,0.07);border-radius:10px;padding:8px 10px;text-align:center"><div style="font-size:18px">${madalyalar[i]}</div><div style="font-size:11px;font-weight:700;color:#fff;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${u.name}</div><div style="font-size:11px;color:#ffb380;margin-top:2px">${u.toplam} ${u.birim}</div></div>`).join('')}</div></div>`;})();
let html=monthBar+topKartHtml;if(showAddForm){const last=p.entries.length?p.entries[p.entries.length-1]:null;const nextAcilis=last&&last.kapanis!==''?last.kapanis:'';html+=`<div class="add-card" id="add-form"><h3>Yeni G√ºn Ekle</h3><div class="form-grid"><div class="ff"><label>G√ºn</label><input type="number" id="f-gun" value="${p.entries.length+1}" inputmode="numeric"></div><div class="ff"><label>Tarih</label><input type="date" id="f-tarih" value="${new Date().toISOString().split('T')[0]}"></div><div class="ff"><label>A√ßƒ±lƒ±≈ü (${birim})</label><input type="number" id="f-acilis" value="${nextAcilis}" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div><div class="ff"><label>Gelen (${birim})</label><input type="number" id="f-gelen" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div><div class="ff"><label>Gelen ƒ∞ade</label><input type="number" id="f-gelenIade" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div><div class="ff"><label>Transfer</label><input type="number" id="f-transfer" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div><div class="ff"><label>Kapanƒ±≈ü (${birim})</label><input type="number" id="f-kapanis" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div><div class="ff"><label>Sayƒ±ma G√∂re Kullanƒ±lan</label><input type="number" id="f-sayima" class="calc" readonly placeholder="Otomatik"></div><div class="ff"><label>Mallara G√∂re Satƒ±lan</label><input type="number" id="f-mallara" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div><div class="ff"><label>Zayi</label><input type="number" id="f-zayi" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div><div class="ff"><label>√ñdenmez</label><input type="number" id="f-odenmez" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div><div class="ff"><label>FARK +/-</label><input type="number" id="f-fark" class="calc" readonly placeholder="Otomatik"></div><div class="ff" style="grid-column:1/-1"><label>Not (isteƒüe baƒülƒ±)</label><input type="text" id="f-not" placeholder="√ñrn: fƒ±rƒ±n arƒ±zasƒ±, stok sayƒ±m hatasƒ±..." style="font-size:13px"></div></div><div class="form-actions"><button class="btn btn-primary" onclick="addEntry()">Kaydet</button><button class="btn btn-outline" onclick="toggleAddForm()">ƒ∞ptal</button></div></div>`;}const ayLabel=selectedMonth==='tumu'?'T√ºm√º':monthLabel(selectedMonth);html+=`<div class="stats-row"><div class="stat-card"><div class="sl">Son Kapanƒ±≈ü</div><div class="sv">${stats.last}</div></div><div class="stat-card orange"><div class="sl">${ayLabel} G√ºn</div><div class="sv">${filtered.length}</div></div><div class="stat-card ${fc}"><div class="sl">${ayLabel} Fark</div><div class="sv">${stats.totalFark>0?'+':''}${stats.totalFark}</div></div><div class="stat-card"><div class="sl">+ / - G√ºn</div><div class="sv" style="font-size:16px"><span style="color:#27ae60">+${stats.posCount}</span> / <span style="color:#e74c3c">${stats.negCount}</span></div></div></div>`;if(!p.entries.length){html+=`<div class="empty"><div class="ico">üìã</div><p>Hen√ºz giri≈ü yok.<br><strong>+ Ekle</strong> butonuna basƒ±n.</p></div>`;}else if(!filtered.length){html+=`<div class="empty"><div class="ico">üìÖ</div><p>${ayLabel} i√ßin giri≈ü yok.</p></div>`;}else{html+=renderIzeka(p);html+=renderChart(p,filtered);html+=`<div class="table-card"><div class="table-scroll"><table><thead><tr><th>#</th><th>G√ºn</th><th>Tarih</th><th>A√ßƒ±lƒ±≈ü<br>(${birim})</th><th>Gelen<br>(${birim})</th><th>G.ƒ∞ade</th><th>Transfer</th><th>Kapanƒ±≈ü<br>(${birim})</th><th>Sayƒ±ma G√∂re<br>Kullanƒ±lan</th><th>Mallara G√∂re<br>Satƒ±lan</th><th>Zayi</th><th>√ñdenmez</th><th>Not</th><th>FARK +/-</th></tr></thead><tbody>`;filtered.forEach(e=>{const idx=p.entries.indexOf(e);const{sayima,fark}=calcEntry(e);const ayKilitli=!isAdmin&&e.tarih&&e.tarih.slice(0,7)<new Date().toISOString().slice(0,7);const fc2=fark>0?'fp':fark<0?'fn':'fz';const hasData=e.acilis!==''||e.kapanis!=='';const readonly=ayKilitli?'readonly style="background:#f5f5f5;color:#aaa;cursor:not-allowed"':'';html+=`<tr${ayKilitli?' style="opacity:0.7"':''}><td>${isAdmin?`<button class="del-btn" onclick="deleteEntry(${idx})">‚úï</button>`:'üîí'}</td><td><input type="number" value="${e.gun||''}" onchange="${ayKilitli?'':` updateEntry(${idx},'gun',this.value)`}" inputmode="numeric" ${readonly}></td><td><input type="date" value="${e.tarih||''}" onchange="${ayKilitli?'':` updateEntry(${idx},'tarih',this.value)`}" style="width:130px" ${readonly}></td><td><input type="number" value="${e.acilis||''}" onchange="${ayKilitli?'':` updateEntry(${idx},'acilis',this.value)`}" step="0.01" inputmode="decimal" ${readonly}></td><td><input type="number" value="${e.gelen||''}" onchange="${ayKilitli?'':` updateEntry(${idx},'gelen',this.value)`}" step="0.01" inputmode="decimal" ${readonly}></td><td><input type="number" value="${e.gelenIade||''}" onchange="${ayKilitli?'':` updateEntry(${idx},'gelenIade',this.value)`}" step="0.01" inputmode="decimal" ${readonly}></td><td><input type="number" value="${e.transfer||''}" onchange="${ayKilitli?'':` updateEntry(${idx},'transfer',this.value)`}" step="0.01" inputmode="decimal" ${readonly}></td><td><input type="number" value="${e.kapanis||''}" onchange="${ayKilitli?'':` updateEntry(${idx},'kapanis',this.value)`}" step="0.01" inputmode="decimal" ${readonly}></td><td class="calc">${hasData?sayima:''}</td><td><input type="number" value="${e.mallara||''}" onchange="${ayKilitli?'':` updateEntry(${idx},'mallara',this.value)`}" step="0.01" inputmode="decimal" ${readonly}></td><td><input type="number" value="${e.zayi||''}" onchange="${ayKilitli?'':` updateEntry(${idx},'zayi',this.value)`}" step="0.01" inputmode="decimal" ${readonly}></td><td><input type="number" value="${e.odenmez||''}" onchange="${ayKilitli?'':` updateEntry(${idx},'odenmez',this.value)`}" step="0.01" inputmode="decimal" ${readonly}></td><td><input type="text" value="${(e.not||'').replace(/"/g,'&quot;')}" onchange="${ayKilitli?'':` updateEntry(${idx},'not',this.value)`}" placeholder="${ayKilitli?'kilitli':'not...'}" style="width:90px;font-size:11px" ${readonly}></td><td class="${fc2}">${hasData?(fark>0?'+':'')+fark:''}</td></tr>`;});html+=`</tbody></table></div><div class="scroll-hint">‚Üê kaydƒ±rƒ±n ‚Üí</div></div>`;}document.getElementById('page-content').innerHTML=html;setTimeout(()=>initChart(p,filtered),50);}
function liveCalc(){const g=id=>n(document.getElementById(id)?.value);const sayima=r(g('f-acilis')+g('f-gelen')-g('f-gelenIade')-g('f-transfer')-g('f-kapanis'));const fark=r(g('f-mallara')-sayima+g('f-zayi')+g('f-odenmez'));const se=document.getElementById('f-sayima'),fe=document.getElementById('f-fark');if(se)se.value=sayima;if(fe){fe.value=(fark>0?'+':'')+fark;fe.className='calc '+(fark>0?'fpos':fark<0?'fneg':'');}}
function scheduleSave(idx){setSyncIcon('saving');clearTimeout(syncTimeout);syncTimeout=setTimeout(()=>syncEntry(idx),800);}
async function syncEntry(idx){const p=appData.products[currentProduct];const e=p.entries[idx];const row={user_id:currentUser.id,urun_sira:p.sira,gun:e.gun||'',tarih:e.tarih||null,acilis:e.acilis||'',gelen:e.gelen||'',gelen_iade:e.gelenIade||'',transfer:e.transfer||'',kapanis:e.kapanis||'',mallara_gore:e.mallara||'',zayi:e.zayi||'',odenmez:e.odenmez||'',gun_notu:e.not||''};let res;if(e.dbId){res=await sb.from('gunluk_girdiler').update(row).eq('id',e.dbId);}else{res=await sb.from('gunluk_girdiler').insert(row).select().single();if(res.data)e.dbId=res.data.id;}if(res.error){setSyncIcon('err');toast('Kayƒ±t hatasƒ±: '+res.error.message,4000);}else{setSyncIcon('ok');}}
async function syncMinStok(sira,minStok){await sb.from('urunler').update({min_stok:minStok}).eq('user_id',currentUser.id).eq('sira',sira);}
async function setBirimFiyat(){const p=appData.products[currentProduct];if(!p)return;const mevcut=p.birimFiyat>0?p.birimFiyat:'';const val=prompt(p.name+' birim fiyatƒ± (‚Ç∫/'+p.birim+'):\nFire maliyetini TL olarak hesaplar. Bo≈ü bƒ±rakƒ±rsanƒ±z kapatƒ±lƒ±r.',mevcut);if(val===null)return;const v=val.trim()===''?0:parseFloat(val.replace(',','.'))||0;p.birimFiyat=v;await sb.from('urunler').update({birim_fiyat:v}).eq('user_id',currentUser.id).eq('sira',p.sira);renderPage();toast(v===0?'Birim fiyat kaldƒ±rƒ±ldƒ±':'Birim fiyat '+v+'\u20ba/'+p.birim+' olarak ayarland\u0131 \u2713');}
let sktData=[];
function sktGunFark(tarih){if(!tarih)return 999;const today=new Date();today.setHours(0,0,0,0);const d=new Date(tarih+'T00:00:00');return Math.round((d-today)/86400000);}
function renderSktBanner(){const el=document.getElementById('skt-banner');if(!el)return;const kritik=sktData.filter(s=>sktGunFark(s.son_tarih)<=5);if(!kritik.length){el.innerHTML='';el.style.display='none';return;}const gecmis=kritik.filter(s=>sktGunFark(s.son_tarih)<0);const bugun=kritik.filter(s=>sktGunFark(s.son_tarih)===0);const yakin=kritik.filter(s=>sktGunFark(s.son_tarih)>0);let html='<div style="background:#fff3cd;border:2px solid #ffc107;border-radius:10px;padding:10px 14px;margin:8px 0 4px;font-size:12px">';html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px"><span style="font-weight:800;color:#856404;font-size:13px">‚è∞ SKT UYARILARI ('+kritik.length+')</span><button onclick="openSktModal()" style="padding:4px 10px;background:#ffc107;color:#333;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">Y√∂net</button></div>';gecmis.forEach(s=>{html+='<div style="display:flex;align-items:center;padding:4px 0;border-bottom:1px solid #ffe8a1;gap:6px"><span style="color:#e74c3c;font-weight:700;flex:1">üíÄ '+s.urun_adi+(s.miktar?' ('+s.miktar+')':'')+'</span><span style="color:#e74c3c;font-size:10px;font-weight:700;background:#fde;padding:2px 6px;border-radius:4px">S√úRESƒ∞ GE√áTƒ∞</span></div>';});bugun.forEach(s=>{html+='<div style="display:flex;align-items:center;padding:4px 0;border-bottom:1px solid #ffe8a1;gap:6px"><span style="color:#e74c3c;font-weight:700;flex:1">üî¥ '+s.urun_adi+(s.miktar?' ('+s.miktar+')':'')+'</span><span style="color:#e74c3c;font-size:10px;font-weight:700;background:#fde;padding:2px 6px;border-radius:4px">BUG√úN SON G√úN!</span></div>';});yakin.forEach(s=>{const g=sktGunFark(s.son_tarih);const c=g<=2?'#e74c3c':'#856404';html+='<div style="display:flex;align-items:center;padding:4px 0;border-bottom:1px solid #ffe8a1;gap:6px"><span style="color:'+c+';font-weight:700;flex:1">üü° '+s.urun_adi+(s.miktar?' ('+s.miktar+')':'')+'</span><span style="color:'+c+';font-size:10px;font-weight:700">'+g+' g√ºn kaldƒ± ('+s.son_tarih+')</span></div>';});html+='</div>';el.innerHTML=html;el.style.display='block';}
async function loadSktData(){if(!currentUser)return;const{data,error}=await sb.from('skt_takip').select('*').eq('user_id',currentUser.id).order('son_tarih');if(!error)sktData=data||[];renderSktBanner();}
function openSktModal(){document.getElementById('skt-modal').classList.add('show');const d=new Date();d.setDate(d.getDate()+5);document.getElementById('skt-tarih').value=d.toISOString().slice(0,10);renderSktList();}
function closeSktModal(){document.getElementById('skt-modal').classList.remove('show');}
function renderSktList(){const list=document.getElementById('skt-list');if(!sktData.length){list.innerHTML='<div style="text-align:center;padding:20px;color:#aaa;font-size:13px">Hen√ºz kayƒ±t yok.<br>Yukarƒ±dan √ºr√ºn ekleyin.</div>';return;}let html='<div style="border:1px solid #eee;border-radius:8px;overflow:hidden">';[...sktData].sort((a,b)=>a.son_tarih.localeCompare(b.son_tarih)).forEach(s=>{const g=sktGunFark(s.son_tarih);const bgc=g<0?'#fde8e8':g===0?'#ffe8e8':g<=2?'#fff3cd':g<=5?'#fffde7':'#f9f9f9';const badge=g<0?'<span style="background:#e74c3c;color:#fff;font-size:10px;padding:2px 6px;border-radius:4px;font-weight:700">GE√áTƒ∞</span>':g===0?'<span style="background:#e74c3c;color:#fff;font-size:10px;padding:2px 6px;border-radius:4px;font-weight:700">BUG√úN!</span>':'<span style="background:'+(g<=2?'#e74c3c':g<=5?'#ffc107':'#27ae60')+';color:#fff;font-size:10px;padding:2px 6px;border-radius:4px;font-weight:700">'+g+' g√ºn</span>';html+='<div style="display:flex;align-items:center;padding:10px 12px;background:'+bgc+';border-bottom:1px solid #eee;gap:8px"><div style="flex:1"><div style="font-size:13px;font-weight:700;color:#333">'+s.urun_adi+'</div><div style="font-size:11px;color:#888">'+(s.miktar?s.miktar+' &bull; ':'')+' SKT: '+s.son_tarih+'</div></div>'+badge+'<button onclick="deleteSktEntry(\''+s.id+'\')" style="padding:4px 8px;background:#e74c3c;color:#fff;border:none;border-radius:6px;font-size:11px;cursor:pointer;font-weight:700">Sil</button></div>';});html+='</div>';list.innerHTML=html;}
async function addSktEntry(){const urunAdi=document.getElementById('skt-urun').value.trim();const tarih=document.getElementById('skt-tarih').value;const miktar=document.getElementById('skt-miktar').value.trim();if(!urunAdi||!tarih){toast('√úr√ºn adƒ± ve tarih zorunlu');return;}const{data,error}=await sb.from('skt_takip').insert({user_id:currentUser.id,urun_adi:urunAdi,son_tarih:tarih,miktar}).select().single();if(error){toast('Hata: '+error.message,4000);return;}sktData.push(data);document.getElementById('skt-urun').value='';document.getElementById('skt-miktar').value='';renderSktList();renderSktBanner();toast('SKT kaydƒ± eklendi \u2713');}
async function deleteSktEntry(id){const{error}=await sb.from('skt_takip').delete().eq('id',id);if(error){toast('Silme hatasƒ±',4000);return;}sktData=sktData.filter(s=>s.id!==id);renderSktList();renderSktBanner();toast('Silindi \u2713');}
function printUrunRaporu(){const p=appData.products[currentProduct];if(!p){toast('√ñnce bir √ºr√ºn se√ßin');return;}const doFilter=selectedMonth&&selectedMonth!=='tumu';const entries=doFilter?p.entries.filter(e=>e.tarih&&e.tarih.startsWith(selectedMonth)):p.entries;const birim=p.birim||'Adet';const stats=getStats(entries);const ayLabel=doFilter?monthLabel(selectedMonth):'T√ºm Aylar';const profil=document.getElementById('drawer-sube-info').textContent||'';const fireTL=p.birimFiyat>0&&stats.totalFark<0?'‚âà '+(Math.round(Math.abs(stats.totalFark)*p.birimFiyat*100)/100)+'‚Ç∫ kayƒ±p':'';let rows='';entries.forEach(e=>{const{sayima,fark}=calcEntry(e);const fc=fark>0?'color:#27ae60':fark<0?'color:#e74c3c':'color:#999';rows+=`<tr><td>${e.gun||''}</td><td>${e.tarih||''}</td><td>${e.acilis||''}</td><td>${e.gelen||''}</td><td>${e.kapanis||''}</td><td>${sayima}</td><td>${e.mallara||''}</td><td>${e.zayi||''}</td><td style="font-weight:800;${fc}">${e.acilis!==''||e.kapanis!==''?(fark>0?'+':'')+fark:''}</td><td style="font-size:10px;color:#888">${e.not||''}</td></tr>`;});const html=`<!DOCTYPE html><html lang="tr"><head><meta charset="UTF-8"><title>${p.name} - ${ayLabel}</title><style>body{font-family:Arial,sans-serif;font-size:11px;color:#333;margin:1cm}h1{font-size:16px;color:#e85d04;margin-bottom:4px}h2{font-size:12px;color:#666;margin-bottom:12px;font-weight:400}table{width:100%;border-collapse:collapse;margin-bottom:16px}th{background:#1a1a2e;color:#fff;padding:6px 8px;text-align:center;font-size:10px}td{padding:5px 8px;text-align:center;border-bottom:1px solid #eee}tr:nth-child(even){background:#f9f9f9}.stat-box{display:inline-block;background:#f5f5f5;padding:8px 14px;border-radius:6px;margin-right:8px;margin-bottom:10px;border-left:3px solid #e85d04}.stat-label{font-size:9px;color:#999;text-transform:uppercase}.stat-val{font-size:18px;font-weight:800;color:#1a1a2e}.footer{margin-top:16px;font-size:9px;color:#bbb;border-top:1px solid #eee;padding-top:8px}@media print{@page{size:A4 landscape;margin:1cm}}</style></head><body><h1>üì¶ ${p.name}</h1><h2>${profil} &nbsp;|&nbsp; ${ayLabel} &nbsp;|&nbsp; ${birim}</h2><div><div class="stat-box"><div class="stat-label">Toplam G√ºn</div><div class="stat-val">${entries.length}</div></div><div class="stat-box"><div class="stat-label">${ayLabel} Fark</div><div class="stat-val" style="color:${stats.totalFark>0?'#27ae60':stats.totalFark<0?'#e74c3c':'#999'}">${stats.totalFark>0?'+':''}${stats.totalFark} ${birim}</div></div><div class="stat-box"><div class="stat-label">+ / - G√ºn</div><div class="stat-val"><span style="color:#27ae60">+${stats.posCount}</span> / <span style="color:#e74c3c">${stats.negCount}</span></div></div>${fireTL?'<div class="stat-box"><div class="stat-label">Fire Maliyet</div><div class="stat-val" style="color:#e74c3c">'+fireTL+'</div></div>':''}</div><table><thead><tr><th>G√ºn</th><th>Tarih</th><th>A√ßƒ±lƒ±≈ü (${birim})</th><th>Gelen</th><th>Kapanƒ±≈ü (${birim})</th><th>Sayƒ±ma G√∂re</th><th>Mallara G√∂re</th><th>Zayi</th><th>FARK</th><th>Not</th></tr></thead><tbody>${rows}</tbody></table><div class="footer">Ercan BRGR Envanter ‚Äî ${new Date().toLocaleString('tr-TR')}</div></body></html>`;const w=window.open('','_blank','width=1000,height=700');w.document.write(html);w.document.close();setTimeout(()=>w.print(),500);}
async function setMinStok(){const p=appData.products[currentProduct];const val=prompt(`${p.name} i√ßin minimum stok uyarƒ± seviyesi (${p.birim}):\n(Kapanƒ±≈ü bu seviyenin altƒ±na d√º≈ü√ºnce uyarƒ± verir. Bo≈ü bƒ±rakƒ±rsanƒ±z uyarƒ± kapatƒ±lƒ±r)`,p.minStok??'');if(val===null)return;const v=val.trim()===''?null:parseFloat(val);p.minStok=v;await syncMinStok(p.sira,v);renderSidebar();renderPage();toast(v===null?'Uyarƒ± kapatƒ±ldƒ±':`Min stok ${v} ${p.birim} olarak ayarlandƒ± ‚úì`);}
async function syncBirim(sira,birim){await sb.from('urunler').update({birim}).eq('user_id',currentUser.id).eq('sira',sira);}
async function syncProductName(sira,ad){await sb.from('urunler').update({ad}).eq('user_id',currentUser.id).eq('sira',sira);}
function toggleAddForm(){showAddForm=!showAddForm;renderPage();if(showAddForm){setTimeout(()=>{const el=document.getElementById('add-form');if(el)el.scrollIntoView({behavior:'smooth'})},50);}}
async function addEntry(){const v=x=>document.getElementById(x)?.value||'';const p=appData.products[currentProduct];const entry={gun:v('f-gun'),tarih:v('f-tarih'),acilis:v('f-acilis'),gelen:v('f-gelen'),gelenIade:v('f-gelenIade'),transfer:v('f-transfer'),kapanis:v('f-kapanis'),mallara:v('f-mallara'),zayi:v('f-zayi'),odenmez:v('f-odenmez'),not:v('f-not')};p.entries.push(entry);showAddForm=false;renderSidebar(document.getElementById('search-input').value);renderPage();await syncEntry(p.entries.length-1);toast('Kaydedildi ‚òÅÔ∏è');}
async function updateEntry(idx,field,val){const p=appData.products[currentProduct];const e=p.entries[idx];const ay=e.tarih?e.tarih.slice(0,7):'';const buAy=new Date().toISOString().slice(0,7);if(!isAdmin&&ay&&ay<buAy){toast('üîí Ge√ßmi≈ü ay verileri deƒüi≈ütirilemez!',3000);renderPage();return;}p.entries[idx][field]=val;renderPage();scheduleSave(idx);}
async function deleteEntry(idx){if(!isAdmin){toast('‚ùå Silme yetkisi sadece adminde!',3000);return;}const p=appData.products[currentProduct];const e=p.entries[idx];const ay=e.tarih?e.tarih.slice(0,7):'';const buAy=new Date().toISOString().slice(0,7);if(ay&&ay<buAy){toast('üîí Ge√ßmi≈ü ay verileri silinemez!',3000);return;}if(!confirm(`‚ö†Ô∏è ADMƒ∞N UYARISI\n\n"${p.name}" √ºr√ºn√ºn√ºn ${e.tarih||'?'} tarihli kaydƒ± silinecek!\n\nBu i≈ülem geri alƒ±namaz. Emin misiniz?`))return;if(e.dbId){const{error}=await sb.from('gunluk_girdiler').delete().eq('id',e.dbId);if(error){toast('Silme hatasƒ±');return;}}p.entries.splice(idx,1);renderSidebar(document.getElementById('search-input').value);renderPage();toast('Silindi ‚úì');}
async function saveBirim(){const p=appData.products[currentProduct];p.birim=document.getElementById('topbar-birim').value;renderPage();await syncBirim(p.sira,p.birim);}
function openRenameModal(){document.getElementById('rename-input').value=appData.products[currentProduct].name;document.getElementById('rename-modal').classList.add('show');setTimeout(()=>document.getElementById('rename-input').focus(),100);}
function closeRenameModal(){document.getElementById('rename-modal').classList.remove('show');}
async function confirmRename(){const v=document.getElementById('rename-input').value.trim();if(v){const p=appData.products[currentProduct];p.name=v;renderSidebar();renderPage();await syncProductName(p.sira,v);toast('√úr√ºn adƒ± g√ºncellendi');}closeRenameModal();}
document.getElementById('rename-input').addEventListener('keydown',e=>{if(e.key==='Enter')confirmRename();if(e.key==='Escape')closeRenameModal();});
function exportData(){const p=appData.products[currentProduct];if(!p)return;const doFilter=selectedMonth&&selectedMonth!=='tumu';const entries=doFilter?p.entries.filter(e=>e.tarih&&e.tarih.startsWith(selectedMonth)):p.entries;if(!entries.length){toast('Bu d√∂nemde giri≈ü yok');return;}const ayLabel=doFilter?monthLabel(selectedMonth):'T√ºm_Aylar';const esc=v=>{const s=String(v??'');return(s.includes(',')||s.includes('"'))?'"'+s.replace(/"/g,'""')+'"':s;};const cols=['Gun','Tarih','Acilis','Gelen','Gelen_Iade','Transfer','Kapanis','Sayima_Gore_Kullanilan','Mallara_Gore_Satilan','Zayi','Odenmez','FARK'];let csv=cols.join(';')+'\n';entries.forEach(e=>{const{sayima,fark}=calcEntry(e);csv+=[e.gun,e.tarih,e.acilis||0,e.gelen||0,e.gelenIade||0,e.transfer||0,e.kapanis||0,sayima,e.mallara||0,e.zayi||0,e.odenmez||0,fark].map(esc).join(';')+'\n';});const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}));a.download=(p.name+'_'+ayLabel).replace(/[\s\/\\:*?"<>|]/g,'_')+'.csv';a.click();toast('Excel dosyasƒ± indirildi ‚úì');}
let adminData={profiller:[],urunler:[],girdiler:[],skt:[]},adminSecilenSube=null,adminSecilenUrun=null;
async function renderAdminPanel(){currentProduct=-1;document.getElementById('product-name-display').textContent='Admin Paneli';document.getElementById('topbar-sub').textContent='T√ºm ≈üubeler';document.getElementById('page-content').innerHTML='<div class="empty"><div class="ico">‚è≥</div><p>≈ûubeler y√ºkleniyor...</p></div>';const{data:profiller,error}=await sb.from('sube_profiller').select('*');if(error){document.getElementById('page-content').innerHTML='<div class="empty"><p>Veri y√ºklenemedi: '+error.message+'</p></div>';return;}if(!profiller||!profiller.length){document.getElementById('page-content').innerHTML='<div class="empty"><div class="ico">üè™</div><p>Hen√ºz kayƒ±tlƒ± ≈üube yok.</p></div>';return;}const{data:tumGirdiler,error:ge}=await sb.from('gunluk_girdiler').select('*');const{data:tumUrunler,error:ue}=await sb.from('urunler').select('*').order('sira');if(ge){toast('Girdiler y√ºklenemedi: '+ge.message,5000);}if(ue){toast('√úr√ºnler y√ºklenemedi: '+ue.message,5000);}adminData={profiller,urunler:tumUrunler||[],girdiler:tumGirdiler||[]};adminSecilenSube=null;adminSecilenUrun=null;const{data:tumSkt}=await sb.from('skt_takip').select('*').order('son_tarih');adminData.skt=tumSkt||[];renderAdminAnaSayfa();}
function renderAdminAnaSayfa(){
  const{profiller,urunler,girdiler}=adminData;
  // Genel istatistikler
  const bugun=new Date().toISOString().slice(0,10);
  const bugunGiris=girdiler.filter(g=>g.tarih===bugun).length;
  const buAy=new Date().toISOString().slice(0,7);
  const buAyGiris=girdiler.filter(g=>g.tarih&&g.tarih.startsWith(buAy)).length;
  // En √ßok kayƒ±p √ºr√ºnler
  const urunFarklar={};
  girdiler.forEach(g=>{
    const key=g.user_id+'_'+g.urun_sira;
    const urun=urunler.find(u=>u.user_id===g.user_id&&u.sira===g.urun_sira);
    if(!urun)return;
    const f=calcEntry({acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez}).fark;
    if(!urunFarklar[urun.ad])urunFarklar[urun.ad]=0;
    urunFarklar[urun.ad]+=f;
  });
  const topKayip=Object.entries(urunFarklar).filter(([,f])=>f<0).sort(([,a],[,b])=>a-b).slice(0,5);
  const topArtƒ±=Object.entries(urunFarklar).filter(([,f])=>f>0).sort(([,a],[,b])=>b-a).slice(0,5);
  let html=`<div class="admin-panel">
  <h2>‚≠ê Admin Paneli <span class="admin-badge">T√úM ≈ûUBELER</span></h2>
  <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
      <button onclick="renderAdminAnaSayfa()" style="padding:8px 14px;background:var(--orange);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">üè™ ≈ûubeler</button>
    <button onclick="renderAdminUrunler()" style="padding:8px 14px;background:#e67e22;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">üì¶ √úr√ºnler</button>
    <button onclick="renderAdminAylikRapor()" style="padding:8px 14px;background:var(--dark);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">üìä Aylƒ±k Rapor</button>
    <button onclick="renderAdminKarsilastirma()" style="padding:8px 14px;background:#0891b2;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">üìà Kar≈üƒ±la≈ütƒ±rma</button>
    <button onclick="adminTumExcel()" style="padding:8px 14px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">üì• Excel ƒ∞ndir</button>
    <button onclick="renderAdminYonetimi()" style="padding:8px 14px;background:#8e44ad;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">üëë Admin Y√∂netimi</button>
  </div>
  <div class="stats-row" style="margin-bottom:16px">
    <div class="stat-card orange"><div class="sl">Toplam ≈ûube</div><div class="sv">${profiller.length}</div></div>
    <div class="stat-card"><div class="sl">Bug√ºn Giri≈ü</div><div class="sv">${bugunGiris}</div></div>
    <div class="stat-card"><div class="sl">Bu Ay Giri≈ü</div><div class="sv">${buAyGiris}</div></div>
    <div class="stat-card"><div class="sl">Toplam Kayƒ±t</div><div class="sv">${girdiler.length}</div></div>
  </div>
  ${(()=>{const allSkt=adminData.skt||[];const kritik=allSkt.filter(s=>sktGunFark(s.son_tarih)<=5);if(!kritik.length)return '';let shtml='<div style="background:#fff3cd;border:2px solid #ffc107;border-radius:10px;padding:10px 14px;margin-bottom:16px"><div style="font-weight:800;color:#856404;font-size:13px;margin-bottom:8px">‚è∞ T√úM ≈ûUBLERDE SKT UYARILARI ('+kritik.length+')</div>';[...kritik].sort((a,b)=>a.son_tarih.localeCompare(b.son_tarih)).forEach(s=>{const p=adminData.profiller.find(pr=>pr.user_id===s.user_id);const g=sktGunFark(s.son_tarih);const c=g<0?'#e74c3c':g===0?'#e74c3c':g<=2?'#e67e22':'#856404';const badge=g<0?'S√úRESƒ∞ GE√áTƒ∞':g===0?'BUG√úN!':g+' g√ºn kaldƒ±';shtml+='<div style="display:flex;align-items:center;padding:5px 0;border-bottom:1px solid #ffe8a1;gap:8px"><span style="color:#aaa;font-size:11px;min-width:90px">'+(p?.sube_adi||'?')+'</span><span style="font-weight:700;color:#333;flex:1">'+s.urun_adi+(s.miktar?' ('+s.miktar+')':'')+'</span><span style="color:'+c+';font-weight:700;font-size:11px">'+badge+'</span></div>';});shtml+='</div>';return shtml;})()}`;
  // En √ßok satan √ºr√ºnler (t√ºm ≈üubeler, bu ay)
  const urunSatisAdmin={};
  girdiler.filter(g=>g.tarih&&g.tarih.startsWith(buAy)).forEach(g=>{
    const urun=urunler.find(u=>u.user_id===g.user_id&&u.sira===g.urun_sira);
    if(!urun)return;
    const ad=urun.ad;
    if(!urunSatisAdmin[ad])urunSatisAdmin[ad]=0;
    urunSatisAdmin[ad]+=n(g.mallara_gore);
  });
  const topSatan=Object.entries(urunSatisAdmin).filter(([,v])=>v>0).sort(([,a],[,b])=>b-a).slice(0,3);
  const madalyalar=['ü•á','ü•à','ü•â'];
  if(topSatan.length){
    html+=`<div style="background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);border-radius:16px;padding:14px 16px;margin-bottom:14px;box-shadow:0 4px 16px rgba(0,0,0,0.15)">
    <div style="font-size:11px;font-weight:700;color:#ffb380;letter-spacing:2px;text-transform:uppercase;margin-bottom:10px">üèÜ ${buAy.slice(5)}. Ay ‚Äî T√úM ≈ûUBELERDE EN √áOK SATAN</div>
    <div style="background:linear-gradient(135deg,#e85d04,#ff9a00);border-radius:12px;padding:12px 16px;margin-bottom:10px;display:flex;align-items:center;gap:12px">
      <span style="font-size:36px">üî•</span>
      <div><div style="font-size:18px;font-weight:900;color:#fff;letter-spacing:1px">${topSatan[0][0]}</div>
      <div style="font-size:12px;color:rgba(255,255,255,0.85);margin-top:2px">${r(topSatan[0][1])} satƒ±ldƒ± (t√ºm ≈üubeler toplam)</div></div>
    </div>
    <div style="display:flex;gap:8px">
      ${topSatan.map(([ad,val],i)=>`<div style="flex:1;background:rgba(255,255,255,0.07);border-radius:10px;padding:8px 10px;text-align:center"><div style="font-size:18px">${madalyalar[i]}</div><div style="font-size:11px;font-weight:700;color:#fff;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${ad}</div><div style="font-size:11px;color:#ffb380;margin-top:2px">${r(val)}</div></div>`).join('')}
    </div></div>`;
  }
  // Kayƒ±p/Artƒ± √∂zeti
  if(topKayip.length||topArtƒ±.length){
    html+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">
    <div style="background:#fff5f5;border:1px solid #fcc;border-radius:10px;padding:12px">
      <div style="font-size:12px;font-weight:700;color:#e74c3c;margin-bottom:8px">üìâ En √áok Kayƒ±p √úr√ºnler</div>
      ${topKayip.map(([ad,f])=>`<div style="display:flex;justify-content:space-between;font-size:12px;padding:4px 0;border-bottom:1px solid #fee"><span>${ad}</span><span style="color:#e74c3c;font-weight:700">${r(f)}</span></div>`).join('')}
    </div>
    <div style="background:#f0fff4;border:1px solid #9f9;border-radius:10px;padding:12px">
      <div style="font-size:12px;font-weight:700;color:#27ae60;margin-bottom:8px">üìà En √áok Fazla √úr√ºnler</div>
      ${topArtƒ±.map(([ad,f])=>`<div style="display:flex;justify-content:space-between;font-size:12px;padding:4px 0;border-bottom:1px solid #dfd"><span>${ad}</span><span style="color:#27ae60;font-weight:700">+${r(f)}</span></div>`).join('')}
    </div></div>`;
  }
  html+=`<div style="font-size:12px;color:#999;margin-bottom:10px">${profiller.length} ≈üube ‚Äî ≈üubeye tƒ±klayƒ±n</div>`;
  profiller.forEach(p=>{
    const pGirdiler=girdiler.filter(g=>g.user_id===p.user_id);
    const pUrunler=urunler.filter(u=>u.user_id===p.user_id);
    const buAyFark=r(pGirdiler.filter(g=>g.tarih&&g.tarih.startsWith(buAy)).reduce((s,g)=>s+calcEntry({acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez}).fark,0));
    const topFark=r(pGirdiler.reduce((s,g)=>s+calcEntry({acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez}).fark,0));
    const sonGiris=pGirdiler.filter(g=>g.tarih).sort((a,b)=>b.tarih.localeCompare(a.tarih))[0]?.tarih||'‚Äî';
    const fc=topFark>0?'s-green':topFark<0?'s-red':'';
    const fcAy=buAyFark>0?'#27ae60':buAyFark<0?'#e74c3c':'#aaa';
    html+=`<div class="sube-card-admin" onclick="adminAcSube('${p.user_id}')">
      <h3>üè™ ${p.sube_adi} <span style="font-size:11px;color:#aaa;font-weight:400">‚Üí tƒ±kla</span></h3>
      <div class="sube-stats">
        <div class="sube-stat">${pUrunler.length} √ºr√ºn</div>
        <div class="sube-stat">${pGirdiler.length} kayƒ±t</div>
        <div class="sube-stat" style="color:${fcAy}">Bu ay: ${buAyFark>0?'+':''}${buAyFark}</div>
        <div class="sube-stat ${fc}">Toplam: ${topFark>0?'+':''}${topFark}</div>
        <div class="sube-stat" style="color:#aaa">Son: ${sonGiris}</div>
      </div>
      <div style="margin-top:8px;display:flex;gap:6px" onclick="event.stopPropagation()">
        <button onclick="adminSubeAdiDegistir('${p.user_id}','${p.sube_adi.replace(/'/g,'&#39;')}')" style="padding:5px 12px;background:#3498db;color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">‚úèÔ∏è Adƒ± D√ºzenle</button>
        <button onclick="adminSubeSil('${p.user_id}','${p.sube_adi.replace(/'/g,'&#39;')}')" style="padding:5px 12px;background:#e74c3c;color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">üóëÔ∏è Sil</button>
      </div>
    </div>`;
  });
  html+=`</div>`;
  document.getElementById('page-content').innerHTML=html;
}
function adminAcSube(userId){adminSecilenSube=userId;adminSecilenUrun=null;const profil=adminData.profiller.find(p=>p.user_id===userId);const urunler=adminData.urunler.filter(u=>u.user_id===userId);const girdiler=adminData.girdiler.filter(g=>g.user_id===userId);let html=`<div class="admin-panel"><div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><button onclick="renderAdminAnaSayfa()" style="background:var(--dark);color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;font-size:13px;font-weight:700">‚Üê Geri</button><h2 style="margin:0">üè™ ${profil?.sube_adi||'≈ûube'}</h2></div><div style="font-size:12px;color:#999;margin-bottom:12px">${urunler.length} √ºr√ºn ‚Äî bir √ºr√ºne tƒ±klayarak giri≈üleri g√∂r√ºn</div>`;urunler.forEach(u=>{const uGirdiler=girdiler.filter(g=>g.urun_sira===u.sira);let toplamFark=0;uGirdiler.forEach(g=>{const e={acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez};toplamFark+=calcEntry(e).fark;});toplamFark=r(toplamFark);const fc=toplamFark>0?'s-green':toplamFark<0?'s-red':'';html+=`<div class="sube-card-admin" onclick="adminAcUrun('${userId}',${u.sira})"><h3>${u.sira+1}. ${u.ad} <span style="font-size:10px;color:#aaa">(${u.birim})</span></h3><div class="sube-stats"><div class="sube-stat">${uGirdiler.length} g√ºn</div><div class="sube-stat ${fc}">${toplamFark>0?'+':''}${toplamFark} toplam fark</div></div></div>`;});html+=`</div>`;document.getElementById('page-content').innerHTML=html;}
function renderAdminAylikRapor(){const{profiller,urunler,girdiler}=adminData;const months=[...new Set(girdiler.filter(g=>g.tarih).map(g=>g.tarih.slice(0,7)))].sort().reverse();let html=`<div class="admin-panel"><div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap"><button onclick="renderAdminAnaSayfa()" style="padding:8px 14px;background:var(--dark);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">‚Üê Geri</button><h2 style="margin:0;align-self:center">üìä Aylƒ±k Rapor</h2></div>`;if(!months.length){html+=`<div class="empty"><div class="ico">üìÖ</div><p>Hen√ºz tarihli giri≈ü yok.</p></div>`;}else{months.forEach(ay=>{const ayGirdiler=girdiler.filter(g=>g.tarih&&g.tarih.startsWith(ay));let toplamFark=0,toplamSatilan=0,toplamSayima=0;ayGirdiler.forEach(g=>{const e={acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez};const{sayima,fark}=calcEntry(e);toplamFark+=fark;toplamSatilan+=n(g.mallara_gore);toplamSayima+=sayima;});toplamFark=r(toplamFark);toplamSatilan=r(toplamSatilan);toplamSayima=r(toplamSayima);const subeSet=new Set(ayGirdiler.map(g=>g.user_id));const fc=toplamFark>0?'s-green':toplamFark<0?'s-red':'';html+=`<div class="sube-card-admin" style="cursor:default"><h3>üìÖ ${monthLabel(ay)}</h3><div class="sube-stats"><div class="sube-stat">${subeSet.size} ≈üube aktif</div><div class="sube-stat">${ayGirdiler.length} giri≈ü</div><div class="sube-stat">Satƒ±lan: ${toplamSatilan}</div><div class="sube-stat">Sayƒ±ma: ${toplamSayima}</div><div class="sube-stat ${fc}">${toplamFark>0?'+':''}${toplamFark} fark</div></div><div style="margin-top:8px"><button onclick="adminAyCSV('${ay}')" style="padding:5px 12px;background:var(--orange);color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">Excel ƒ∞ndir</button></div></div>`;});}html+=`</div>`;document.getElementById('page-content').innerHTML=html;}
function adminAyCSV(ay){const{profiller,urunler,girdiler}=adminData;const ayGirdiler=girdiler.filter(g=>g.tarih&&g.tarih.startsWith(ay));if(!ayGirdiler.length){toast('Bu ayda giri≈ü yok');return;}const esc=v=>{const s=String(v??'');return(s.includes(';')||s.includes('"'))?'"'+s.replace(/"/g,'""')+'"':s;};const cols=['Sube','Urun','Gun','Tarih','Acilis','Gelen','Gelen_Iade','Transfer','Kapanis','Sayima_Kullanilan','Mallara_Satilan','Zayi','Odenmez','FARK'];let csv=cols.join(';')+'\n';ayGirdiler.forEach(g=>{const profil=profiller.find(p=>p.user_id===g.user_id);const urun=urunler.find(u=>u.user_id===g.user_id&&u.sira===g.urun_sira);const{sayima,fark}=calcEntry({acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez});csv+=[profil?.sube_adi,urun?.ad,g.gun,g.tarih,g.acilis||0,g.gelen||0,g.gelen_iade||0,g.transfer||0,g.kapanis||0,sayima,g.mallara_gore||0,g.zayi||0,g.odenmez||0,fark].map(esc).join(';')+'\n';});const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}));a.download='Tum_Subeler_'+monthLabel(ay).replace(/\s/g,'_')+'.csv';a.click();toast('Excel indirildi ‚úì');}
function adminTumCSV(){adminTumExcel();}
function adminAyCSV(ay){adminAyExcel(ay);}
function xlsxHdr(ws,row,cols){cols.forEach((v,c)=>{const ref=XLSX.utils.encode_cell({r:row,c});ws[ref]={v,t:'s',s:{font:{bold:true,color:{rgb:'FFFFFF'},sz:11},fill:{fgColor:{rgb:'E8590C'}},alignment:{horizontal:'center',wrapText:true},border:{bottom:{style:'thin',color:{rgb:'999999'}}}}}});if(!ws['!ref']){ws['!ref']=XLSX.utils.encode_range({s:{r:0,c:0},e:{r:row,c:cols.length-1}});}return row+1;}
function xlsxRow(ws,row,vals,isTotal){vals.forEach((v,c)=>{const ref=XLSX.utils.encode_cell({r:row,c});const isNum=typeof v==='number';const isFark=c===vals.length-1;const farkColor=isNum&&isFark?(v>0?'1E8449':v<0?'C0392B':'333333'):'333333';ws[ref]={v:v??'',t:isNum?'n':'s',s:{font:{bold:isTotal||false,color:{rgb:isFark?farkColor:'333333'},sz:10},fill:{fgColor:{rgb:isTotal?'FFF3CD':row%2===0?'FFFFFF':'F9F9F9'}},alignment:{horizontal:isNum?'center':'left'}}};});if(ws['!ref']){const r=XLSX.utils.decode_range(ws['!ref']);r.e.r=Math.max(r.e.r,row);r.e.c=Math.max(r.e.c,vals.length-1);ws['!ref']=XLSX.utils.encode_range(r);}return row+1;}
function adminAyExcel(ay){
  const{profiller,urunler,girdiler}=adminData;
  const ayGirdiler=girdiler.filter(g=>g.tarih&&g.tarih.startsWith(ay));
  if(!ayGirdiler.length){toast('Bu ayda giri≈ü yok');return;}
  const wb=XLSX.utils.book_new();
  const basliklar=['≈ûube','√úr√ºn','Birim','G√ºn','Tarih','A√ßƒ±lƒ±≈ü','Gelen','G.ƒ∞ade','Transfer','Kapanƒ±≈ü','Sayƒ±ma G√∂re','Mallara G√∂re','Zayi','√ñdenmez','FARK'];
  // √ñzet sayfasƒ±
  const ozWs={};let ozRow=0;
  ozRow=xlsxHdr(ozWs,ozRow,['≈ûube','√úr√ºn','Toplam Fark','G√ºn Sayƒ±sƒ±']);
  let ozTopFark=0;
  profiller.forEach(p=>{
    const pG=ayGirdiler.filter(g=>g.user_id===p.user_id);
    if(!pG.length)return;
    urunler.filter(u=>u.user_id===p.user_id).forEach(u=>{
      const uG=pG.filter(g=>g.urun_sira===u.sira);
      if(!uG.length)return;
      const fark=r(uG.reduce((s,g)=>s+calcEntry({acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez}).fark,0));
      ozRow=xlsxRow(ozWs,ozRow,[p.sube_adi,u.ad,fark,uG.length]);
      ozTopFark+=fark;
    });
  });
  ozRow=xlsxRow(ozWs,ozRow,['','TOPLAM',r(ozTopFark),''],true);
  ozWs['!cols']=[{wch:20},{wch:22},{wch:14},{wch:10}];
  XLSX.utils.book_append_sheet(wb,ozWs,'√ñZET');
  // Her ≈üube ayrƒ± sayfa
  profiller.forEach(p=>{
    const pG=ayGirdiler.filter(g=>g.user_id===p.user_id);
    if(!pG.length)return;
    const ws={};let row=0;
    row=xlsxHdr(ws,row,basliklar);
    let topFark=0;
    pG.forEach(g=>{
      const urun=urunler.find(u=>u.user_id===p.user_id&&u.sira===g.urun_sira);
      const{sayima,fark}=calcEntry({acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez});
      topFark+=fark;
      row=xlsxRow(ws,row,[p.sube_adi,urun?.ad||'',urun?.birim||'',g.gun,g.tarih,n(g.acilis),n(g.gelen),n(g.gelen_iade),n(g.transfer),n(g.kapanis),sayima,n(g.mallara_gore),n(g.zayi),n(g.odenmez),fark]);
    });
    row=xlsxRow(ws,row,['','','','','','','','','','','','','','TOPLAM FARK',r(topFark)],true);
    ws['!cols']=basliklar.map((_,i)=>({wch:[16,22,8,6,12,10,10,8,10,10,12,12,8,10,10][i]||10}));
    const sheetName=(p.sube_adi||'Sube').slice(0,31).replace(/[\/\\?*\[\]]/g,'');
    XLSX.utils.book_append_sheet(wb,ws,sheetName);
  });
  XLSX.writeFile(wb,`BRGR_${monthLabel(ay).replace(/\s/g,'_')}.xlsx`);
  toast('Excel indirildi ‚úì');
}
function adminTumExcel(){
  const{profiller,urunler,girdiler}=adminData;
  if(!girdiler.length){toast('Veri yok');return;}
  const months=[...new Set(girdiler.filter(g=>g.tarih).map(g=>g.tarih.slice(0,7)))].sort().reverse();
  if(months.length===1){adminAyExcel(months[0]);return;}
  const wb=XLSX.utils.book_new();
  const basliklar=['≈ûube','√úr√ºn','Birim','G√ºn','Tarih','A√ßƒ±lƒ±≈ü','Gelen','G.ƒ∞ade','Transfer','Kapanƒ±≈ü','Sayƒ±ma G√∂re','Mallara G√∂re','Zayi','√ñdenmez','FARK'];
  // √ñzet sayfasƒ±
  const ozWs={};let ozRow=0;
  ozRow=xlsxHdr(ozWs,ozRow,['Ay','≈ûube Sayƒ±sƒ±','Toplam Giri≈ü','Toplam Fark']);
  months.forEach(ay=>{
    const ayG=girdiler.filter(g=>g.tarih&&g.tarih.startsWith(ay));
    const fark=r(ayG.reduce((s,g)=>s+calcEntry({acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez}).fark,0));
    const subeSet=new Set(ayG.map(g=>g.user_id));
    ozRow=xlsxRow(ozWs,ozRow,[monthLabel(ay),subeSet.size,ayG.length,fark]);
  });
  ozWs['!cols']=[{wch:16},{wch:12},{wch:14},{wch:14}];
  XLSX.utils.book_append_sheet(wb,ozWs,'√ñZET');
  // Her ay ayrƒ± sayfa
  months.slice(0,12).forEach(ay=>{
    const ayG=girdiler.filter(g=>g.tarih&&g.tarih.startsWith(ay));
    if(!ayG.length)return;
    const ws={};let row=0;
    row=xlsxHdr(ws,row,basliklar);
    let topFark=0;
    ayG.forEach(g=>{
      const profil=profiller.find(p=>p.user_id===g.user_id);
      const urun=urunler.find(u=>u.user_id===g.user_id&&u.sira===g.urun_sira);
      const{sayima,fark}=calcEntry({acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez});
      topFark+=fark;
      row=xlsxRow(ws,row,[profil?.sube_adi||'',urun?.ad||'',urun?.birim||'',g.gun,g.tarih,n(g.acilis),n(g.gelen),n(g.gelen_iade),n(g.transfer),n(g.kapanis),sayima,n(g.mallara_gore),n(g.zayi),n(g.odenmez),fark]);
    });
    row=xlsxRow(ws,row,['','','','','','','','','','','','','','TOPLAM FARK',r(topFark)],true);
    ws['!cols']=basliklar.map((_,i)=>({wch:[16,22,8,6,12,10,10,8,10,10,12,12,8,10,10][i]||10}));
    XLSX.utils.book_append_sheet(wb,ws,monthLabel(ay).replace(/\s/g,'_').slice(0,31));
  });
  XLSX.writeFile(wb,'BRGR_Tum_Veriler_'+new Date().toISOString().slice(0,10)+'.xlsx');
  toast('T√ºm veriler Excel olarak indirildi ‚úì');
}
let prodChartInstance=null;
function renderIzeka(p){const birim=p.birim||'Adet';const sonGirisler=p.entries.filter(e=>n(e.mallara)>0||n(e.kapanis)>0).slice(-14);if(!sonGirisler.length)return '';const mallaraList=sonGirisler.filter(e=>n(e.mallara)>0);const ortMallara=mallaraList.length?r(mallaraList.reduce((s,e)=>s+n(e.mallara),0)/mallaraList.length):null;const sonKapanis=p.entries.length?n(p.entries[p.entries.length-1].kapanis||''):null;const gunYeter=ortMallara&&ortMallara>0&&sonKapanis!==null?Math.floor(sonKapanis/ortMallara):null;const toplamFire=r(p.entries.reduce((s,e)=>s+Math.min(0,calcEntry(e).fark),0));const fireMaliyet=toplamFire<0&&p.birimFiyat>0?r(Math.abs(toplamFire)*p.birimFiyat):null;const gunRenk=gunYeter===null?'#aaa':gunYeter<=1?'#e74c3c':gunYeter<=3?'#e67e22':'#27ae60';let html=`<div style="background:#fff;border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,0.06)"><div style="font-size:11px;font-weight:700;color:#999;text-transform:uppercase;margin-bottom:10px">üß† ƒ∞≈ü Zekasƒ±</div><div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:10px">`;if(ortMallara!==null)html+=`<div style="background:#f8f8f8;border-radius:8px;padding:10px"><div style="font-size:10px;color:#999;margin-bottom:4px">Ort. G√ºnl√ºk Satƒ±≈ü (son ${mallaraList.length} g√ºn)</div><div style="font-size:20px;font-weight:800;color:#333">${ortMallara} <span style="font-size:11px;font-weight:400">${birim}</span></div></div>`;if(gunYeter!==null)html+=`<div style="background:#f8f8f8;border-radius:8px;padding:10px;border-left:3px solid ${gunRenk}"><div style="font-size:10px;color:#999;margin-bottom:4px">Mevcut Stok Yeter</div><div style="font-size:20px;font-weight:800;color:${gunRenk}">${gunYeter} g√ºn</div></div>`;if(ortMallara!==null)html+=`<div style="background:#e8f4fd;border-radius:8px;padding:10px"><div style="font-size:10px;color:#2980b9;margin-bottom:4px">Yarƒ±n Tahmini Kullanƒ±m</div><div style="font-size:20px;font-weight:800;color:#2980b9">${ortMallara} <span style="font-size:11px;font-weight:400">${birim}</span></div></div>`;html+=`<div style="background:#f8f8f8;border-radius:8px;padding:10px;border-left:3px solid ${toplamFire<0?'#e74c3c':'#27ae60'}"><div style="font-size:10px;color:#999;margin-bottom:4px">Toplam Fire</div><div style="font-size:20px;font-weight:800;color:${toplamFire<0?'#e74c3c':'#27ae60'}">${toplamFire} <span style="font-size:11px;font-weight:400">${birim}</span></div>${fireMaliyet!==null?`<div style="font-size:12px;color:#e74c3c;font-weight:700;margin-top:4px">‚âà ${fireMaliyet}‚Ç∫ kayƒ±p</div>`:''}</div>`;html+=`</div>`;if(gunYeter!==null&&gunYeter<=3)html+=`<div style="background:#fdf2e9;border-radius:8px;padding:10px;margin-bottom:8px;display:flex;align-items:center;gap:10px"><span style="font-size:20px">‚ö†Ô∏è</span><div><div style="font-size:12px;font-weight:700;color:#e67e22">Sƒ∞PARƒ∞≈û VER!</div><div style="font-size:11px;color:#aaa">${gunYeter<=0?'Stok t√ºkendi!':gunYeter+' g√ºn kaldƒ± ‚Äî hemen sipari≈ü ver'}</div></div></div>`;if(p.minStok!==null&&sonKapanis!==null&&sonKapanis<p.minStok)html+=`<div style="background:#fdf2e9;border-radius:8px;padding:10px;margin-bottom:8px;display:flex;align-items:center;gap:10px"><span>‚ö†Ô∏è</span><span style="font-size:12px;color:#e67e22;font-weight:700">Min stok uyarƒ±sƒ±! Mevcut: ${sonKapanis} ‚Äî Min: ${p.minStok} ${birim}</span></div>`;html+=`</div>`;return html;}
function renderChart(p,filtered){const chartEntries=filtered.filter(e=>e.tarih).slice(-30);if(chartEntries.length<2)return '';return `<div style="background:#fff;border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,0.06)"><div style="font-size:11px;font-weight:700;color:#999;text-transform:uppercase;margin-bottom:10px">üìà Trend Grafiƒüi (son ${chartEntries.length} g√ºn)</div><canvas id="prod-chart" style="max-height:180px"></canvas></div>`;}
function initChart(p,filtered){const ctx=document.getElementById('prod-chart');if(!ctx)return;if(prodChartInstance){prodChartInstance.destroy();prodChartInstance=null;}const chartEntries=filtered.filter(e=>e.tarih).slice(-30);if(chartEntries.length<2)return;const labels=chartEntries.map(e=>e.tarih.slice(5));const kapanisData=chartEntries.map(e=>e.kapanis!==''?n(e.kapanis):null);const mallara=chartEntries.map(e=>e.mallara!==''?n(e.mallara):null);prodChartInstance=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Kapanƒ±≈ü',data:kapanisData,borderColor:'#e8590c',backgroundColor:'rgba(232,89,12,0.08)',tension:0.3,pointRadius:3,fill:true},{label:'Satƒ±lan',data:mallara,borderColor:'#3498db',backgroundColor:'rgba(52,152,219,0.08)',tension:0.3,pointRadius:3,fill:false}]},options:{responsive:true,plugins:{legend:{labels:{font:{size:11},boxWidth:12}}},scales:{y:{beginAtZero:false,ticks:{font:{size:10}}},x:{ticks:{font:{size:10},maxRotation:45}}}}});}
let adminSecAy='tumu';
function adminAcUrun(userId,sira,secAy){adminSecAy=secAy||'tumu';const profil=adminData.profiller.find(p=>p.user_id===userId);const urun=adminData.urunler.find(u=>u.user_id===userId&&u.sira===sira);const tumGirdiler=adminData.girdiler.filter(g=>g.user_id===userId&&g.urun_sira===sira);const birim=urun?.birim||'Adet';const months=[...new Set(tumGirdiler.filter(g=>g.tarih).map(g=>g.tarih.slice(0,7)))].sort().reverse();const girdiler=adminSecAy==='tumu'?tumGirdiler:tumGirdiler.filter(g=>g.tarih&&g.tarih.startsWith(adminSecAy));const ayLabel=adminSecAy==='tumu'?'T√ºm√º':monthLabel(adminSecAy);let html=`<div class="admin-panel"><div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap"><button onclick="adminAcSube('${userId}')" style="background:var(--dark);color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;font-size:13px;font-weight:700">‚Üê Geri</button><h2 style="margin:0;font-size:14px">üè™ ${profil?.sube_adi} ‚Ä∫ ${urun?.ad}</h2></div><div style="background:#f8f8f8;border-radius:10px;padding:10px 14px;margin-bottom:12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap"><span style="font-size:11px;font-weight:700;color:#999;text-transform:uppercase">Ay Filtresi</span><select onchange="adminAcUrun('${userId}',${sira},this.value)" style="padding:7px 12px;border:2px solid #eee;border-radius:8px;font-size:13px;font-weight:700;outline:none"><option value="tumu" ${adminSecAy==='tumu'?'selected':''}>T√ºm√º</option>${months.map(m=>`<option value="${m}" ${m===adminSecAy?'selected':''}>${monthLabel(m)}</option>`).join('')}</select><button id="admin-csv-btn" style="padding:7px 14px;background:var(--orange);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">CSV ƒ∞ndir</button><button onclick="window.print()" style="padding:7px 14px;background:var(--dark);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">Yazdƒ±r</button><span style="font-size:12px;color:#aaa">${girdiler.length} giri≈ü</span></div>`;if(!tumGirdiler.length){html+=`<div class="empty"><div class="ico">üìã</div><p>Bu √ºr√ºn i√ßin hen√ºz giri≈ü yok.</p></div>`;}else if(!girdiler.length){html+=`<div class="empty"><div class="ico">üìÖ</div><p>${ayLabel} i√ßin giri≈ü yok.</p></div>`;}else{let toplamFark=0,posC=0,negC=0;girdiler.forEach(g=>{const f=calcEntry({acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez}).fark;toplamFark+=f;if(f>0)posC++;else if(f<0)negC++;});toplamFark=r(toplamFark);const fc=toplamFark>0?'green':toplamFark<0?'red':'';html+=`<div class="stats-row" style="margin-bottom:12px"><div class="stat-card orange"><div class="sl">${ayLabel} G√ºn</div><div class="sv">${girdiler.length}</div></div><div class="stat-card ${fc}"><div class="sl">${ayLabel} Fark</div><div class="sv">${toplamFark>0?'+':''}${toplamFark}</div></div><div class="stat-card"><div class="sl">+ / - G√ºn</div><div class="sv" style="font-size:16px"><span style="color:#27ae60">+${posC}</span> / <span style="color:#e74c3c">${negC}</span></div></div></div><div class="table-card"><div class="table-scroll"><table><thead><tr><th>G√ºn</th><th>Tarih</th><th>A√ßƒ±lƒ±≈ü<br>(${birim})</th><th>Gelen</th><th>G.ƒ∞ade</th><th>Transfer</th><th>Kapanƒ±≈ü<br>(${birim})</th><th>Sayƒ±ma G√∂re<br>Kullanƒ±lan</th><th>Mallara G√∂re<br>Satƒ±lan</th><th>Zayi</th><th>√ñdenmez</th><th>FARK</th></tr></thead><tbody>`;girdiler.forEach(g=>{const e={acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez};const{sayima,fark}=calcEntry(e);const fc2=fark>0?'fp':fark<0?'fn':'fz';html+=`<tr><td>${g.gun||''}</td><td>${g.tarih||''}</td><td>${g.acilis||''}</td><td>${g.gelen||''}</td><td>${g.gelen_iade||''}</td><td>${g.transfer||''}</td><td>${g.kapanis||''}</td><td class="calc">${sayima}</td><td>${g.mallara_gore||''}</td><td>${g.zayi||''}</td><td>${g.odenmez||''}</td><td class="${fc2}">${fark>0?'+':''}${fark}</td></tr>`;});html+=`</tbody></table></div></div>`;}html+=`</div>`;document.getElementById('page-content').innerHTML=html;const csvBtn=document.getElementById('admin-csv-btn');if(csvBtn)csvBtn.onclick=()=>adminExportCSV(userId,sira,adminSecAy);}
function adminExportCSV(userId,sira,secAy){const profil=adminData.profiller.find(p=>p.user_id===userId);const urun=adminData.urunler.find(u=>u.user_id===userId&&u.sira===sira);const tumGirdiler=adminData.girdiler.filter(g=>g.user_id===userId&&g.urun_sira===sira);const girdiler=secAy==='tumu'?tumGirdiler:tumGirdiler.filter(g=>g.tarih&&g.tarih.startsWith(secAy));if(!girdiler.length){toast('Bu d√∂nemde giri≈ü yok');return;}const ayLabel=secAy==='tumu'?'T√ºm_Aylar':monthLabel(secAy).replace(/\s/g,'_');const esc=v=>{const s=String(v??'');return(s.includes(';')||s.includes('"'))?'"'+s.replace(/"/g,'""')+'"':s;};const cols=['Sube','Urun','Gun','Tarih','Acilis','Gelen','Gelen_Iade','Transfer','Kapanis','Sayima_Gore_Kullanilan','Mallara_Gore_Satilan','Zayi','Odenmez','FARK'];let csv=cols.join(';')+'\n';girdiler.forEach(g=>{const{sayima,fark}=calcEntry({acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez});csv+=[profil?.sube_adi,urun?.ad,g.gun,g.tarih,g.acilis||0,g.gelen||0,g.gelen_iade||0,g.transfer||0,g.kapanis||0,sayima,g.mallara_gore||0,g.zayi||0,g.odenmez||0,fark].map(esc).join(';')+'\n';});const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}));a.download=((profil?.sube_adi||'')+'_'+(urun?.ad||'')+'_'+ayLabel).replace(/[\s\/\\:*?"<>|]/g,'_')+'.csv';a.click();toast('Excel dosyasƒ± indirildi ‚úì');}
let faturaAnalizSonucu=[];
async function adminSubeAdiDegistir(userId,mevcutAd){const yeni=prompt('Yeni ≈üube adƒ±:',mevcutAd);if(!yeni||!yeni.trim()||yeni.trim()===mevcutAd)return;const{error}=await sb.from('sube_profiller').update({sube_adi:yeni.trim()}).eq('user_id',userId);if(error){toast('Hata: '+error.message,4000);return;}const profil=adminData.profiller.find(p=>p.user_id===userId);if(profil)profil.sube_adi=yeni.trim();renderAdminAnaSayfa();toast('≈ûube adƒ± g√ºncellendi ‚úì');}
async function adminSubeSil(userId,subeAdi){if(!confirm('"'+subeAdi+'" ≈üubesini silmek istediƒüinizden emin misiniz?\n\nT√úM VERƒ∞LER (kayƒ±tlar, √ºr√ºnler) Sƒ∞Lƒ∞NECEK!'))return;const[r1,r2,r3]=await Promise.all([sb.from('gunluk_girdiler').delete().eq('user_id',userId),sb.from('urunler').delete().eq('user_id',userId),sb.from('sube_profiller').delete().eq('user_id',userId)]);if(r1.error||r2.error||r3.error){toast('Silme hatasƒ±',4000);return;}adminData.profiller=adminData.profiller.filter(p=>p.user_id!==userId);adminData.urunler=adminData.urunler.filter(u=>u.user_id!==userId);adminData.girdiler=adminData.girdiler.filter(g=>g.user_id!==userId);renderAdminAnaSayfa();toast(subeAdi+' silindi ‚úì');}
async function renderAdminUrunler(){const pc=document.getElementById('page-content');pc.innerHTML='<div class="empty"><div class="ico">‚è≥</div><p>√úr√ºnler y√ºkleniyor...</p></div>';const{data:profiller}=await sb.from('sube_profiller').select('*');if(!profiller||!profiller.length){pc.innerHTML='<div class="empty"><p>≈ûube bulunamadƒ±</p></div>';return;}// √ñrnek ≈üubenin √ºr√ºnlerini al
const{data:urunler}=await sb.from('urunler').select('*').eq('user_id',profiller[0].user_id).order('sira');const pc2=document.getElementById('page-content');let html=`<div class="admin-panel"><h2>‚≠ê Admin Paneli <span class="admin-badge">T√úM ≈ûUBELER</span></h2><div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap"><button onclick="renderAdminAnaSayfa()" style="padding:8px 14px;background:var(--orange);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">üè™ ≈ûubeler</button><button onclick="renderAdminUrunler()" style="padding:8px 14px;background:#e67e22;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">üì¶ √úr√ºnler</button><button onclick="renderAdminAylikRapor()" style="padding:8px 14px;background:var(--dark);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">üìä Aylƒ±k Rapor</button><button onclick="renderAdminKarsilastirma()" style="padding:8px 14px;background:#0891b2;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">üìà Kar≈üƒ±la≈ütƒ±rma</button><button onclick="adminTumExcel()" style="padding:8px 14px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">üì• Excel ƒ∞ndir</button><button onclick="renderAdminYonetimi()" style="padding:8px 14px;background:#8e44ad;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">üëë Admin Y√∂netimi</button></div>`;html+=`<div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:14px"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px"><div><div style="font-size:16px;font-weight:800">üì¶ √úr√ºn Listesi</div><div style="font-size:11px;color:#aaa;margin-top:2px">${(urunler||[]).length} √ºr√ºn ‚Ä¢ Yeni √ºr√ºn eklenince t√ºm ≈üubelere gider</div></div><button onclick="adminYeniUrunEkle()" style="padding:10px 18px;background:var(--orange);color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer">+ Yeni √úr√ºn Ekle</button></div><div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:13px"><thead><tr style="background:#f8f8f8"><th style="padding:10px;text-align:left;border-bottom:2px solid #eee">Sƒ±ra</th><th style="padding:10px;text-align:left;border-bottom:2px solid #eee">√úr√ºn Adƒ±</th><th style="padding:10px;text-align:left;border-bottom:2px solid #eee">Birim</th><th style="padding:10px;text-align:center;border-bottom:2px solid #eee">≈ûube Sayƒ±sƒ±</th></tr></thead><tbody>${(urunler||[]).map(u=>`<tr style="border-bottom:1px solid #f0f0f0"><td style="padding:10px;color:#aaa;font-size:12px">${u.sira+1}</td><td style="padding:10px;font-weight:700">${u.ad}</td><td style="padding:10px"><span style="background:#f0f0f0;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700">${u.birim||'Adet'}</span></td><td style="padding:10px;text-align:center"><span style="background:#e8f5e9;color:#27ae60;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700">${profiller.length} ≈üube</span></td></tr>`).join('')}</tbody></table></div></div></div>`;pc2.innerHTML=html;}
async function adminYeniUrunEkle(){const ad=prompt('Yeni √ºr√ºn adƒ± (t√ºm ≈üubelere eklenecek):');if(!ad||!ad.trim())return;const birim=prompt('Birimi (Adet / Kg / Lt / Paket / Kutu):','Adet')||'Adet';const{data:profiller}=await sb.from('sube_profiller').select('user_id');if(!profiller||!profiller.length){toast('≈ûube bulunamadƒ±');return;}// Her ≈üube i√ßin en y√ºksek sƒ±rayƒ± bul ve ekle
let basarili=0;for(const p of profiller){const{data:mevcutlar}=await sb.from('urunler').select('sira').eq('user_id',p.user_id).order('sira',{ascending:false}).limit(1);const yeniSira=(mevcutlar&&mevcutlar.length)?mevcutlar[0].sira+1:0;const{error}=await sb.from('urunler').insert({user_id:p.user_id,sira:yeniSira,ad:ad.trim(),birim,koli:'',adet_koli:''});if(!error)basarili++;}toast(`‚úÖ "${ad.trim()}" ${basarili} ≈üubeye eklendi!`,4000);renderAdminUrunler();}
function renderAdminYonetimi(){const profiller=adminData.profiller;const admins=profiller.filter(p=>p.rol==='admin');const subeler=profiller.filter(p=>p.rol!=='admin');let html='<div class="admin-panel">';html+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px"><button onclick="renderAdminAnaSayfa()" style="padding:8px 14px;background:var(--dark);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">‚Üê Geri</button><h3 style="margin:0;font-size:16px">üëë Admin Y√∂netimi</h3></div>';html+='<div style="background:#f3e8ff;border:1px solid #c084fc;border-radius:10px;padding:10px 14px;margin-bottom:16px;font-size:12px;color:#7e22ce">Admin olan kullanƒ±cƒ±lar t√ºm ≈üubelerin verilerini g√∂rebilir, raporlarƒ±nƒ± indirebilir. Dikkatli kullanƒ±n.</div>';html+='<div style="font-size:11px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Adminler ('+admins.length+')</div>';html+='<div style="border:1px solid #eee;border-radius:10px;overflow:hidden;margin-bottom:20px">';if(!admins.length){html+='<div style="padding:14px;text-align:center;color:#aaa;font-size:13px">Hen√ºz admin yok</div>';}admins.forEach(p=>{const isSelf=p.user_id===currentUser.id;html+='<div style="display:flex;align-items:center;padding:12px 14px;border-bottom:1px solid #f0f0f0;gap:10px;background:#fff9f0"><span style="font-size:22px">üëë</span><div style="flex:1"><div style="font-size:13px;font-weight:700;color:#333">'+p.sube_adi+'</div><div style="font-size:11px;color:#aaa">'+(p.email||'e-posta yok')+'</div></div><span style="background:#e85d04;color:#fff;font-size:10px;padding:3px 8px;border-radius:10px;font-weight:700">ADMƒ∞N</span>'+(isSelf?'<span style="font-size:10px;color:#aaa;padding:0 6px">(sen)</span>':'<button onclick="adminRolDegistir(\''+p.user_id+'\',\'sube\')" style="padding:6px 12px;background:#fee2e2;color:#dc2626;border:1px solid #fca5a5;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">Kaldƒ±r</button>')+'</div>';});html+='</div>';html+='<div style="font-size:11px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">≈ûubeler ('+subeler.length+')</div>';html+='<div style="border:1px solid #eee;border-radius:10px;overflow:hidden">';if(!subeler.length){html+='<div style="padding:14px;text-align:center;color:#aaa;font-size:13px">T√ºm kullanƒ±cƒ±lar admin</div>';}subeler.forEach(p=>{html+='<div style="display:flex;align-items:center;padding:12px 14px;border-bottom:1px solid #f0f0f0;gap:10px;background:#fff"><span style="font-size:22px">üè™</span><div style="flex:1"><div style="font-size:13px;font-weight:700;color:#333">'+p.sube_adi+'</div><div style="font-size:11px;color:#aaa">'+(p.email||'e-posta yok')+'</div></div><span style="background:#eee;color:#999;font-size:10px;padding:3px 8px;border-radius:10px;font-weight:700">≈ûUBE</span><button onclick="adminRolDegistir(\''+p.user_id+'\',\'admin\')" style="padding:6px 12px;background:#f3e8ff;color:#7e22ce;border:1px solid #c084fc;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">üëë Admin Yap</button></div>';});html+='</div></div>';document.getElementById('page-content').innerHTML=html;}
async function adminRolDegistir(userId,yeniRol){const profil=adminData.profiller.find(p=>p.user_id===userId);const onay=yeniRol==='admin'?'"'+profil?.sube_adi+'" kullanƒ±cƒ±sƒ±nƒ± ADMƒ∞N yapmak istediƒüinizden emin misiniz?\n\nT√ºm ≈üubelerin verilerini g√∂rebilecek.':'"'+profil?.sube_adi+'" kullanƒ±cƒ±sƒ±nƒ±n ADMƒ∞N yetkisini kaldƒ±rmak istediƒüinizden emin misiniz?';if(!confirm(onay))return;const{error}=await sb.from('sube_profiller').update({rol:yeniRol}).eq('user_id',userId);if(error){toast('Hata: '+error.message,4000);return;}if(profil)profil.rol=yeniRol;renderAdminYonetimi();toast(yeniRol==='admin'?profil.sube_adi+' artƒ±k Admin ‚úì':profil.sube_adi+' artƒ±k ≈ûube kullanƒ±cƒ±sƒ± ‚úì');}
function renderAdminKarsilastirma(){const buAy=new Date().toISOString().slice(0,7);const branches=adminData.profiller.map(p=>{const pg=adminData.girdiler.filter(g=>g.user_id===p.user_id);const buAyG=pg.filter(g=>g.tarih&&g.tarih.startsWith(buAy));const toEntry=g=>({acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez});const topFark=r(pg.reduce((s,g)=>s+calcEntry(toEntry(g)).fark,0));const buAyFark=r(buAyG.reduce((s,g)=>s+calcEntry(toEntry(g)).fark,0));const topFire=r(pg.reduce((s,g)=>s+Math.min(0,calcEntry(toEntry(g)).fark),0));return{sube_adi:p.sube_adi,topFark,buAyFark,topFire,kayit:pg.length};});const maxAbs=Math.max(1,...branches.map(b=>Math.abs(b.topFark)));let html='<div class="admin-panel">';html+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px"><button onclick="renderAdminAnaSayfa()" style="padding:8px 14px;background:var(--dark);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">‚Üê Geri</button><h3 style="margin:0;font-size:16px">üìà ≈ûubeler Kar≈üƒ±la≈ütƒ±rma</h3></div>';html+='<div style="font-size:11px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">Toplam Fark (t√ºm zamanlar)</div>';html+='<div style="background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,0.06)">';[...branches].sort((a,b)=>b.topFark-a.topFark).forEach(b=>{const pct=Math.round((Math.abs(b.topFark)/maxAbs)*100);const c=b.topFark>0?'#27ae60':b.topFark<0?'#e74c3c':'#aaa';html+='<div style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:12px;font-weight:700;color:#333">üè™ '+b.sube_adi+'</span><span style="font-size:13px;font-weight:800;color:'+c+'">'+(b.topFark>0?'+':'')+b.topFark+'</span></div><div style="height:14px;background:#f0f0f0;border-radius:7px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:'+c+';border-radius:7px;transition:width 0.8s ease"></div></div></div>';});html+='</div>';html+='<div style="font-size:11px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">Bu Ay Fark ('+monthLabel(buAy)+')</div>';const maxAy=Math.max(1,...branches.map(b=>Math.abs(b.buAyFark)));html+='<div style="background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,0.06)">';[...branches].sort((a,b)=>b.buAyFark-a.buAyFark).forEach(b=>{const pct=Math.round((Math.abs(b.buAyFark)/maxAy)*100);const c=b.buAyFark>0?'#27ae60':b.buAyFark<0?'#e74c3c':'#aaa';html+='<div style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:12px;font-weight:700;color:#333">üè™ '+b.sube_adi+'</span><span style="font-size:13px;font-weight:800;color:'+c+'">'+(b.buAyFark>0?'+':'')+b.buAyFark+'</span></div><div style="height:14px;background:#f0f0f0;border-radius:7px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:'+c+';border-radius:7px;transition:width 0.8s ease"></div></div></div>';});html+='</div>';html+='<div style="font-size:11px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">Toplam Fire Miktarƒ±</div>';const maxFire=Math.max(1,...branches.map(b=>Math.abs(b.topFire)));html+='<div style="background:#fff;border-radius:12px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,0.06)">';[...branches].sort((a,b)=>a.topFire-b.topFire).forEach(b=>{const pct=Math.round((Math.abs(b.topFire)/maxFire)*100);html+='<div style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:12px;font-weight:700;color:#333">üè™ '+b.sube_adi+'</span><span style="font-size:13px;font-weight:800;color:#e74c3c">'+b.topFire+' ('+b.kayit+' kayƒ±t)</span></div><div style="height:14px;background:#f0f0f0;border-radius:7px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:#e74c3c;border-radius:7px"></div></div></div>';});html+='</div></div>';document.getElementById('page-content').innerHTML=html;}
function renderMailOtomasyon(){let html='<div class="admin-panel">';html+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px"><button onclick="renderAdminAnaSayfa()" style="padding:8px 14px;background:var(--dark);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">‚Üê Geri</button><h3 style="margin:0;font-size:16px">üìß Mail Otomasyonu</h3></div>';html+='<div style="background:#e0f2fe;border:1px solid #7dd3fc;border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:13px;color:#0c4a6e"><strong>Nasƒ±l √ßalƒ±≈üƒ±r?</strong><br>Google Apps Script, Gmail\'deki ariapos raporlarƒ±nƒ± her gece otomatik okuyup sisteme ekler. Kurulum <strong>bir kez</strong> yapƒ±lƒ±r, sonra tamamen otomatik √ßalƒ±≈üƒ±r.</div>';html+='<div style="font-size:13px;font-weight:700;color:#333;margin-bottom:8px">üìã Kurulum Adƒ±mlarƒ±:</div>';html+='<div style="background:#fff;border-radius:10px;padding:14px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,0.06);font-size:13px;line-height:1.8"><div style="margin-bottom:6px">1Ô∏è‚É£ <a href="https://script.google.com" target="_blank" style="color:#0891b2;font-weight:700">script.google.com</a> adresine git</div><div style="margin-bottom:6px">2Ô∏è‚É£ <strong>Yeni Proje</strong> olu≈ütur</div><div style="margin-bottom:6px">3Ô∏è‚É£ A≈üaƒüƒ±daki kodu yapƒ±≈ütƒ±r</div><div style="margin-bottom:6px">4Ô∏è‚É£ √ústteki <strong>√áalƒ±≈ütƒ±r</strong> butonuna bas (izin ver)</div><div>5Ô∏è‚É£ <strong>Tetikleyiciler</strong> ‚Üí Her gece saat 23:30 i√ßin zamanlayƒ±cƒ± ekle</div></div>';const code=`// Ercan BRGR - Ariapos Mail Otomasyonu
const SUPA_URL = '${document.querySelector&&'https://gqhfxpczgxksbfybfesz.supabase.co'}';
const SUPA_KEY = 'SUPABASE_ANON_KEY_BURAYA';
const KULLANICI_EMAIL = 'SUBE_MAIL_ADRESI_BURAYA'; // hangi ≈üubenin maili

function ariaposMailOku() {
  const threads = GmailApp.search('from:rapor11@ariapos.com is:unread', 0, 10);
  threads.forEach(thread => {
    const msgs = thread.getMessages();
    msgs.forEach(msg => {
      const body = msg.getPlainBody();
      const tarih = msg.getDate().toISOString().split('T')[0];
      const satirlar = body.split('\\n');
      const parsed = parseSatirlar(satirlar, tarih);
      if (parsed.length > 0) {
        supabaseGonder(parsed);
        msg.markRead();
      }
    });
  });
}

function parseSatirlar(satirlar, tarih) {
  // Satƒ±r formatƒ±: URUN ADI   ADET   FIYAT
  const kayitlar = [];
  satirlar.forEach(s => {
    const m = s.match(/^(.+?)\\s{2,}(\\d+)\\s+([\\d.,]+)/);
    if (m) kayitlar.push({ urun: m[1].trim(), adet: parseInt(m[2]), tarih });
  });
  return kayitlar;
}

function supabaseGonder(kayitlar) {
  const url = SUPA_URL + '/rest/v1/rpc/mail_rapor_ekle';
  const options = {
    method: 'POST',
    headers: { 'apikey': SUPA_KEY, 'Content-Type': 'application/json' },
    payload: JSON.stringify({ kayitlar, email: KULLANICI_EMAIL })
  };
  UrlFetchApp.fetch(url, options);
}`;html+='<div style="font-size:11px;font-weight:700;color:#999;text-transform:uppercase;margin-bottom:6px">Apps Script Kodu:</div>';html+='<div style="position:relative"><button onclick="navigator.clipboard.writeText(document.getElementById(\'apps-script-code\').textContent).then(()=>toast(\'Kopyalandƒ± ‚úì\'))" style="position:absolute;top:8px;right:8px;padding:4px 10px;background:#0891b2;color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;z-index:1">üìã Kopyala</button>';html+='<pre id="apps-script-code" style="background:#1a1a2e;color:#a5f3fc;border-radius:10px;padding:16px;font-size:11px;overflow-x:auto;white-space:pre-wrap;margin:0;line-height:1.6">'+code.replace(/</g,'&lt;')+'</pre></div>';html+='<div style="background:#fef9c3;border-radius:8px;padding:10px 14px;margin-top:12px;font-size:12px;color:#854d0e">‚ö†Ô∏è <strong>SUPA_KEY</strong> ve <strong>KULLANICI_EMAIL</strong> alanlarƒ±nƒ± doldurmayƒ± unutma.</div>';html+='</div>';document.getElementById('page-content').innerHTML=html;}
async function faturaFotoOku(input){
  const file=input.files[0];
  if(!file)return;
  const status=document.getElementById('fatura-ocr-status');
  status.innerHTML='‚è≥ Fotoƒüraf okunuyor...';
  status.style.color='#e67e22';
  try{
    const{data:{text}}=await Tesseract.recognize(file,'tur+eng',{
      logger:m=>{if(m.status==='recognizing text'){status.innerHTML=`‚è≥ %${Math.round(m.progress*100)} okunuyor...`;}}
    });
    document.getElementById('fatura-text').value=text;
    status.innerHTML='‚úÖ Metin okundu ‚Äî analiz ediliyor...';
    status.style.color='#27ae60';
    analizFatura();
  }catch(e){
    status.innerHTML='‚ùå Okuma ba≈üarƒ±sƒ±z, metni elle yapƒ±≈ütƒ±rƒ±n';
    status.style.color='#e74c3c';
  }
}
let satisAnalizSonucu={};
let satisRaporTarih=null;
function openSatisModal(){document.getElementById('satis-modal').classList.add('show');document.getElementById('analiz-sonuc').innerHTML='';document.getElementById('satis-text').value='';satisAnalizSonucu={};satisRaporTarih=null;}
function closeSatisModal(){document.getElementById('satis-modal').classList.remove('show');}
function parseSatisLines(text){const items=[];let cat='';text.split('\n').forEach(line=>{if(/^\s*\*/.test(line)){cat=line.replace(/[* ]/g,'').toUpperCase();return;}const m=line.match(/^(.+?)\s{2,}(\d+)\s+([\d.,]+)/);if(m){const adet=parseInt(m[2]);const tutar=parseFloat(m[3].replace('.','').replace(',','.'));const birimFiyat=adet>0?tutar/adet:0;items.push({ad:m[1].trim().toUpperCase(),adet,kat:cat,birimFiyat});}});return items;}
function parseOzetToplam(text){let toplam=0;const lines=text.split('\n');let ozetBasladi=false;lines.forEach(line=>{if(/Ozet Urun Tip|√ñzet √úr√ºn Tip/i.test(line)){ozetBasladi=true;return;}if(ozetBasladi){const m=line.match(/:\s*(\d+)/);if(m)toplam+=parseInt(m[1]);}});return toplam;}
function gunAdiFromTarih(tarih){if(!tarih)return '';const d=new Date(tarih);return ['Paz','Pzt','Sal','√áar','Per','Cum','Cmt'][d.getDay()]||'';}
function extractPieces(ad){const m=ad.match(/(\d+)'?[Llƒ∞iuU]/);return m?parseInt(m[1]):1;}
function menuBilgi(item){const{ad,kat}=item;if(/IKILI/.test(kat)||/2 ?LI/.test(ad))return{bc:2,pat:2,kutu:2,litre:0};if(/UCLU/.test(kat))return{bc:3,pat:3,kutu:0,litre:1};if(/DORTLU/.test(kat))return{bc:4,pat:4,kutu:0,litre:2};if(/MENU/.test(kat)||/MEN[U√ú]?$/.test(ad)||/PAKET|RAMAZAN/.test(ad))return{bc:1,pat:1,kutu:1,litre:0};return{bc:1,pat:0,kutu:0,litre:0};}
let satisRaporTarih=null;
function analizEt(){const text=document.getElementById('satis-text').value.trim();if(!text){toast('Rapor metnini yapƒ±≈ütƒ±rƒ±n');return;}satisRaporTarih=parseTarihFromText(text);const lines=parseSatisLines(text);if(!lines.length){document.getElementById('analiz-sonuc').innerHTML='<div style="color:#e74c3c;font-size:13px;padding:10px">√úr√ºn bulunamadƒ±.</div>';return;}const totals={};let etBurger=0,tumBurger=0,smokyBurger=0;const add=(sira,val,birim='Kg')=>{if(!totals[sira])totals[sira]={val:0,birim};totals[sira].val=r(totals[sira].val+val);totals[sira].birim=birim;};lines.forEach(item=>{const{ad,adet}=item;const mb=menuBilgi(item);const isDouble=/DOUBLE/.test(ad)&&!/2 ?LI/.test(ad);let bSira=-1,bGr=0,isTavuk=false,isMiniEkmek=false;if(/RAMAZAN CORBALI/.test(ad)){bSira=7;bGr=110;isTavuk=true;}
else if(/JUNIOR.*TAVUK|TAVUK.*JUNIOR/.test(ad)){bSira=5;bGr=65;isTavuk=true;isMiniEkmek=true;mb.pat=mb.pat||1;mb.kutu=mb.kutu||1;}
else if(/JUNIOR|MINI ET/.test(ad)){bSira=0;bGr=50;isMiniEkmek=true;mb.pat=mb.pat||1;mb.kutu=mb.kutu||1;}
else if(/LEZZET/.test(ad)){if(item.birimFiyat>220){bSira=1;bGr=85;}else{bSira=6;bGr=120;isTavuk=true;}mb.pat=mb.pat||1;mb.kutu=mb.kutu||1;}
else if(/JOKE|ALGIDA JOKER|KAMPANYA.*JOKE/.test(ad)){bSira=1;bGr=85;}
else if(/SUPPER|SUPER|MISS CRISPY/.test(ad)){bSira=2;bGr=120;}
else if(/TASTY|RAMAZAN(?!.*CORBALI)/.test(ad)){bSira=3;bGr=150;}
else if(/SPECIAL|BIG SPECIAL/.test(ad)){bSira=4;bGr=150;}
else if(/TENDERS/.test(ad)){bSira=7;bGr=110;isTavuk=true;}
else if(/MINI TAVUK/.test(ad)){bSira=5;bGr=65;isTavuk=true;}
else if(/CHICKEN|CHEDDAR|RED ZONE/.test(ad)){bSira=6;bGr=120;isTavuk=true;}
else if(/CITIR|√áITIR/.test(ad)){add(11,adet*160/1000);return;}if(bSira>=0){const etAdet=isDouble?2:1;add(bSira,adet*mb.bc*etAdet*bGr/1000);add(isMiniEkmek?17:16,adet*mb.bc,'Adet');if(!isTavuk)etBurger+=adet*mb.bc;tumBurger+=adet*mb.bc;if(mb.pat>0)add(8,adet*mb.pat*130/1000);if(mb.kutu>0)add(18,adet*mb.kutu,'Adet');if(mb.litre>0)add(20,adet*mb.litre,'Adet');if(/SMOKY/.test(ad))smokyBurger+=adet*mb.bc;return;}if(/PATATES/.test(ad))add(8,adet*130/1000);else if(/NUGGET/.test(ad))add(9,extractPieces(ad)*adet*24/1000);else if(/SOGAN|SOƒûAN|ONION/.test(ad))add(10,extractPieces(ad)*adet*14/1000);else if(/STICK/.test(ad))add(12,extractPieces(ad)*adet,'Adet');else if(/SODA/.test(ad))add(19,adet,'Adet');else if(/1 ?LT/.test(ad))add(20,adet,'Adet');else if(/SU|COLA|FUSE|ICE|AYRAN|MEYVE|SPRITE/.test(ad)&&!/SODA|1 ?LT/.test(ad))add(18,adet,'Adet');});if(etBurger>0)add(13,r(etBurger*20/1000));if(smokyBurger>0)add(14,r(smokyBurger*3*13/1000));
// √ñzet b√∂l√ºm√ºnden toplam burger sayƒ±sƒ±nƒ± al, mini ekmek √ßƒ±kar = 80gr ekmek
const ozetToplam=parseOzetToplam(text);const miniEkmekAdet=totals[17]?totals[17].val:0;if(ozetToplam>0){totals[16]={val:ozetToplam-miniEkmekAdet,birim:'Adet'};}else if(totals[16]){totals[16].val=r(totals[16].val-miniEkmekAdet);}satisAnalizSonucu=totals;const siraNamMap={};appData.products.forEach((p,idx)=>{siraNamMap[idx]=p;});const tarihLabel=satisRaporTarih?`<span style="background:#eafaf1;color:#27ae60;padding:3px 10px;border-radius:8px;font-weight:700">üìÖ ${satisRaporTarih}</span>`:`<span style="background:#fff3cd;color:#856404;padding:3px 10px;border-radius:8px;font-weight:700">‚ö†Ô∏è Tarih bulunamadƒ± ‚Äî bug√ºn kullanƒ±lacak</span>`;let html=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap">${tarihLabel}<span style="font-size:11px;color:#999">${lines.length} satƒ±r ‚Ä¢ ${tumBurger} burger</span></div><div style="border:1px solid #eee;border-radius:10px;overflow:hidden;margin-bottom:10px">`;let hasAny=false;Object.entries(totals).forEach(([sira,{val,birim}])=>{const p=siraNamMap[parseInt(sira)];if(!p||!val)return;html+=`<div style="display:flex;align-items:center;padding:9px 12px;border-bottom:1px solid #f5f5f5;gap:10px"><span style="flex:1;font-size:13px;font-weight:600;color:#333">${p.name}</span><input type="number" id="srv-${sira}" value="${val}" step="0.001" style="width:80px;padding:6px 8px;border:2px solid #eee;border-radius:6px;text-align:center;font-size:13px;font-weight:700;outline:none" onfocus="this.style.borderColor='#e85d04'" onblur="this.style.borderColor='#eee'"><span style="font-size:11px;color:#aaa;min-width:28px">${birim}</span></div>`;hasAny=true;});html+=`</div>`;if(hasAny){html+=`<div style="font-size:11px;color:#aaa;margin-bottom:8px">Deƒüerleri kontrol edip onaylayƒ±n ‚Äî her √ºr√ºne yeni giri≈ü a√ßƒ±lƒ±r</div><button onclick="uygulaRapor()" style="width:100%;padding:13px;background:#27ae60;color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer">‚úÖ Kaydet ve Giri≈üleri Olu≈ütur</button>`;}else{html+=`<div style="text-align:center;padding:16px;color:#aaa;font-size:13px">E≈üle≈üen √ºr√ºn bulunamadƒ±.</div>`;}document.getElementById('analiz-sonuc').innerHTML=html;}
async function uygulaRapor(){const totals=satisAnalizSonucu;if(!Object.keys(totals).length)return;const siraNamMap={};appData.products.forEach((p,idx)=>{siraNamMap[idx]=p;});const tarih=satisRaporTarih||new Date().toISOString().slice(0,10);const gunAdi=gunAdiFromTarih(tarih)||['Paz','Pzt','Sal','√áar','Per','Cum','Cmt'][new Date().getDay()];let updated=0,created=0;for(const[sira]of Object.entries(totals)){const inputEl=document.getElementById(`srv-${sira}`);const finalVal=inputEl?parseFloat(inputEl.value):0;if(!finalVal)continue;const p=siraNamMap[parseInt(sira)];if(!p)continue;const mevcutIdx=p.entries.findIndex(e=>e.tarih===tarih);if(mevcutIdx>=0){p.entries[mevcutIdx].mallara=String(finalVal);const e=p.entries[mevcutIdx];if(e.dbId){await sb.from('gunluk_girdiler').update({mallara_gore:String(finalVal)}).eq('id',e.dbId);}updated++;}else{const oncekiKapanis=p.entries.length?p.entries[p.entries.length-1].kapanis||'':'';const newEntry={gun:String(p.entries.length+1),tarih,acilis:oncekiKapanis,gelen:'',gelenIade:'',transfer:'',kapanis:'',mallara:String(finalVal),zayi:'',odenmez:''};p.entries.push(newEntry);const row={user_id:currentUser.id,urun_sira:parseInt(sira),gun:String(p.entries.length),tarih,acilis:oncekiKapanis||null,gelen:null,gelen_iade:null,transfer:null,kapanis:null,mallara_gore:String(finalVal),zayi:null,odenmez:null};const res=await sb.from('gunluk_girdiler').insert(row).select().single();if(res.data)p.entries[p.entries.length-1].dbId=res.data.id;created++;}}toast(`‚úÖ ${created} yeni giri≈ü (${tarih}), ${updated} g√ºncellendi`,3500);closeSatisModal();selectedMonth=tarih.slice(0,7);renderPage();}
if('serviceWorker'in navigator&&location.protocol!=='file:'){navigator.serviceWorker.register('sw.js').catch(()=>{});}
let deferredPrompt;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;document.getElementById('install-bar').classList.add('show');});
function installApp(){if(deferredPrompt){deferredPrompt.prompt();deferredPrompt.userChoice.then(()=>{deferredPrompt=null;document.getElementById('install-bar').classList.remove('show');});}}
window.addEventListener('load',async()=>{showScreen('auth-screen');const{data:{session}}=await sb.auth.getSession();if(session){await onSignedIn(session.user);}else{showScreen('auth-screen');}sb.auth.onAuthStateChange(async(event,session)=>{if(event==='SIGNED_OUT')showScreen('auth-screen');});});
</script>
</body>
</html>
