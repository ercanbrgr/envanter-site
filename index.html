<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ercan BRGR - Envanter</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e85d04">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BRGR Envanter">
<link rel="apple-touch-icon" href="icon.svg">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--orange:#e85d04;--dark:#1a1a2e;--mid:#16213e;--deep:#0f3460}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Segoe UI',Arial,sans-serif;background:#f0f2f5;min-height:100vh}
#auth-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,var(--dark) 0%,var(--deep) 100%);padding:20px}
.auth-card{background:#fff;border-radius:20px;padding:36px 28px;width:100%;max-width:380px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
.auth-logo{font-size:44px;font-weight:900;color:var(--orange);letter-spacing:3px;margin-bottom:4px}
.auth-sub{font-size:11px;color:#aaa;margin-bottom:24px;letter-spacing:1px;text-transform:uppercase}
.auth-tabs{display:flex;gap:0;margin-bottom:20px;border:2px solid #eee;border-radius:10px;overflow:hidden}
.auth-tab{flex:1;padding:10px;font-size:13px;font-weight:700;border:none;background:#f8f8f8;cursor:pointer;color:#888;transition:all 0.2s}
.auth-tab.active{background:var(--orange);color:#fff}
.auth-field{margin-bottom:14px;text-align:left}
.auth-field label{font-size:11px;font-weight:700;color:#888;text-transform:uppercase;display:block;margin-bottom:5px}
.auth-field input{width:100%;padding:13px 14px;border:2px solid #eee;border-radius:10px;font-size:15px;outline:none;transition:border-color 0.2s}
.auth-field input:focus{border-color:var(--orange)}
.auth-btn{width:100%;padding:14px;background:var(--orange);color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;transition:background 0.2s;margin-top:4px}
.auth-btn:hover{background:#c44d02}
.auth-btn:disabled{background:#ccc;cursor:not-allowed}
.auth-err{color:#e74c3c;font-size:12px;min-height:18px;margin-top:6px;text-align:center}
.auth-note{font-size:11px;color:#aaa;margin-top:12px;line-height:1.5}
#sube-screen{display:none;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,var(--dark) 0%,var(--deep) 100%);padding:20px}
.sube-card{background:#fff;border-radius:20px;padding:36px 28px;width:100%;max-width:380px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
#loading-screen{display:none;align-items:center;justify-content:center;flex-direction:column;min-height:100vh;background:linear-gradient(135deg,var(--dark) 0%,var(--deep) 100%);gap:16px}
.spinner{width:40px;height:40px;border:4px solid rgba(255,255,255,0.2);border-top-color:var(--orange);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{color:#fff;font-size:14px;opacity:0.7}
#app{display:none;min-height:100vh;flex-direction:column}
#topbar{background:var(--dark);color:#fff;padding:12px 16px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
#menu-btn{background:none;border:none;color:#fff;font-size:22px;cursor:pointer;padding:4px 8px;border-radius:6px;line-height:1}
#menu-btn:hover{background:rgba(255,255,255,0.1)}
#topbar-title{flex:1;font-size:15px;font-weight:700;color:#fff;cursor:pointer;min-width:0}
#topbar-title span{display:block;font-size:10px;color:var(--orange);font-weight:400}
#topbar-birim{background:rgba(255,255,255,0.1);border:none;color:#fff;padding:6px 10px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;outline:none}
#topbar-birim option{color:var(--dark);background:#fff}
.top-btn{padding:7px 12px;border-radius:8px;border:none;cursor:pointer;font-size:12px;font-weight:700;white-space:nowrap}
.top-btn-add{background:var(--orange);color:#fff}
.top-btn-add:hover{background:#c44d02}
.top-btn-menu{background:rgba(255,255,255,0.1);color:#fff}
#topbar-user{font-size:10px;color:#ffb380;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:80px}
#sync-indicator{font-size:18px;cursor:default;transition:opacity 0.3s}
#drawer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200}
#drawer-overlay.open{display:block}
#drawer{position:fixed;left:-280px;top:0;bottom:0;width:280px;background:var(--dark);z-index:201;transition:left 0.3s ease;display:flex;flex-direction:column;overflow:hidden}
#drawer.open{left:0}
#drawer-header{background:var(--orange);padding:20px 16px;display:flex;align-items:center;justify-content:space-between}
#drawer-header .brand{font-size:20px;font-weight:900;color:#fff;letter-spacing:2px}
#drawer-close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer}
#drawer-search{padding:12px;background:var(--mid)}
#drawer-search input{width:100%;padding:8px 12px;border-radius:8px;border:none;background:var(--deep);color:#fff;font-size:13px;outline:none}
#drawer-search input::placeholder{color:#888}
#product-list{flex:1;overflow-y:auto;padding:6px 0}
#product-list::-webkit-scrollbar{width:3px}
#product-list::-webkit-scrollbar-thumb{background:var(--orange);border-radius:3px}
.product-item{padding:12px 16px;cursor:pointer;font-size:13px;border-left:3px solid transparent;display:flex;align-items:center;gap:8px;color:#ccc;transition:all 0.15s}
.product-item:hover,.product-item.active{background:var(--deep);border-left-color:var(--orange);color:#fff}
.product-item .num{font-size:10px;color:#666;min-width:20px}
.product-item .pname{flex:1;font-size:13px}
.product-item .badge{font-size:10px;background:var(--orange);color:#fff;border-radius:10px;padding:1px 7px}
.drawer-footer{padding:12px 16px;border-top:1px solid var(--deep);display:flex;flex-direction:column;gap:8px}
.drawer-footer-info{font-size:11px;color:#666;word-break:break-all}
.drawer-btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-size:12px;font-weight:700;width:100%;text-align:center}
.drawer-btn-orange{background:var(--orange);color:#fff}
.drawer-btn-gray{background:rgba(255,255,255,0.1);color:#aaa}
.drawer-btn-red{background:#c0392b;color:#fff}
.admin-badge{background:#f39c12;color:#fff;font-size:9px;font-weight:900;padding:2px 6px;border-radius:8px;letter-spacing:1px;text-transform:uppercase}
#content{flex:1;padding:12px;overflow-x:hidden}
.stats-row{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:12px}
@media(min-width:600px){.stats-row{grid-template-columns:repeat(4,1fr)}}
.stat-card{background:#fff;border-radius:12px;padding:12px 14px;border-left:4px solid var(--orange);box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.stat-card .sl{font-size:10px;color:#999;font-weight:600;text-transform:uppercase}
.stat-card .sv{font-size:22px;font-weight:800;color:var(--dark)}
.stat-card.green{border-left-color:#2ecc71}.stat-card.green .sv{color:#27ae60}
.stat-card.red{border-left-color:#e74c3c}.stat-card.red .sv{color:#e74c3c}
.stat-card.orange .sv{color:var(--orange)}
.add-card{background:#fff;border-radius:12px;padding:16px;margin-bottom:12px;border-top:3px solid var(--orange);box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.add-card h3{font-size:14px;color:var(--dark);margin-bottom:14px;font-weight:700}
.form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(min-width:500px){.form-grid{grid-template-columns:repeat(3,1fr)}}
@media(min-width:768px){.form-grid{grid-template-columns:repeat(5,1fr)}}
.ff{display:flex;flex-direction:column;gap:4px}
.ff label{font-size:10px;font-weight:700;color:#999;text-transform:uppercase}
.ff input,.ff select{padding:10px;border:2px solid #eee;border-radius:8px;font-size:14px;outline:none;transition:border-color 0.15s;width:100%}
.ff input:focus{border-color:var(--orange)}
.ff input.calc{background:#f8f8f8;font-weight:700;border-color:#e0e0e0;cursor:default}
.ff input.fpos{background:#eafaf1;color:#27ae60;font-weight:800;border-color:#a9dfbf}
.ff input.fneg{background:#fdf2f2;color:#e74c3c;font-weight:800;border-color:#f5b7b1}
.form-actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.btn{padding:10px 18px;border-radius:8px;border:none;cursor:pointer;font-size:13px;font-weight:700;transition:all 0.15s}
.btn-primary{background:var(--orange);color:#fff}
.btn-primary:hover{background:#c44d02}
.btn-outline{background:transparent;border:2px solid var(--orange);color:var(--orange)}
.btn-outline:hover{background:var(--orange);color:#fff}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-danger{background:#e74c3c;color:#fff}
.table-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;font-size:12px;min-width:700px}
thead tr{background:var(--dark);color:#fff}
thead th{padding:10px 8px;text-align:center;font-size:11px;font-weight:600;white-space:nowrap;border-right:1px solid var(--deep)}
tbody tr{border-bottom:1px solid #f5f5f5;transition:background 0.1s}
tbody tr:hover{background:#fef9f5}
tbody td{padding:6px 6px;text-align:center;border-right:1px solid #f5f5f5}
tbody td input{width:100%;border:1px solid transparent;border-radius:4px;padding:5px 4px;text-align:center;font-size:12px;background:transparent;outline:none}
tbody td input:focus{border-color:var(--orange);background:#fff8f2}
td.calc{background:#f8f8f8;font-weight:700}
td.fp{background:#eafaf1;color:#27ae60;font-weight:800}
td.fn{background:#fdf2f2;color:#e74c3c;font-weight:800}
td.fz{background:#f5f5f5;color:#999;font-weight:700}
.del-btn{background:none;border:none;cursor:pointer;color:#ddd;font-size:13px;padding:3px 7px;border-radius:4px}
.del-btn:hover{color:#e74c3c;background:#fdf2f2}
.empty{text-align:center;padding:48px 20px;color:#bbb}
.empty .ico{font-size:48px;margin-bottom:12px}
.empty p{font-size:14px}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:300;align-items:center;justify-content:center;padding:20px}
.overlay.show{display:flex}
.modal{background:#fff;border-radius:16px;padding:24px;width:100%;max-width:340px;box-shadow:0 10px 40px rgba(0,0,0,0.2)}
.modal h3{font-size:16px;margin-bottom:16px;color:var(--dark)}
.modal input{width:100%;padding:12px;border:2px solid #eee;border-radius:8px;font-size:15px;outline:none;margin-bottom:14px}
.modal input:focus{border-color:var(--orange)}
.modal-actions{display:flex;gap:8px;justify-content:flex-end}
.admin-panel{background:#fff;border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.admin-panel h2{font-size:16px;color:var(--dark);margin-bottom:14px;font-weight:800;display:flex;align-items:center;gap:8px}
.sube-card-admin{border:1px solid #eee;border-radius:10px;padding:14px;margin-bottom:10px;cursor:pointer;transition:border-color 0.2s}
.sube-card-admin:hover{border-color:var(--orange)}
.sube-card-admin h3{font-size:14px;font-weight:700;color:var(--dark);margin-bottom:4px}
.sube-stats{display:flex;gap:8px;flex-wrap:wrap}
.sube-stat{background:#f8f8f8;border-radius:6px;padding:6px 10px;font-size:11px;font-weight:700;color:#555}
.sube-stat.s-green{background:#eafaf1;color:#27ae60}
.sube-stat.s-red{background:#fdf2f2;color:#e74c3c}
#bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #eee;padding:8px 16px;box-shadow:0 -2px 10px rgba(0,0,0,0.08);z-index:100}
@media(max-width:599px){#bottom-nav{display:flex;gap:8px;justify-content:center}}
#content{padding-bottom:80px}
@media(min-width:600px){#content{padding-bottom:12px}}
#install-bar{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--orange);color:#fff;padding:12px 16px;align-items:center;justify-content:space-between;z-index:500;font-size:13px;box-shadow:0 -2px 10px rgba(0,0,0,0.2)}
#install-bar.show{display:flex}
#toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:rgba(30,30,30,0.95);color:#fff;padding:10px 20px;border-radius:20px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:opacity 0.3s;pointer-events:none;white-space:nowrap}
#toast.show{opacity:1}
@media print{
  #auth-screen,#sube-screen,#loading-screen,#topbar,#drawer,#drawer-overlay,#bottom-nav,#install-bar,.add-card,.del-btn,.top-btn{display:none!important}
  .stats-row{display:none}
  #app{display:block!important}
  .table-card{box-shadow:none}
}
</style>
</head>
<body>
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">BRGR</div>
    <div class="auth-sub">Ercan BRGR Envanter</div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-giris" onclick="switchTab('giris')">GiriÅŸ Yap</button>
      <button class="auth-tab" id="tab-kayit" onclick="switchTab('kayit')">KayÄ±t Ol</button>
    </div>
    <div id="form-giris">
      <div class="auth-field"><label>E-posta</label><input type="email" id="giris-email" placeholder="ornek@mail.com" autocomplete="email" inputmode="email"></div>
      <div class="auth-field"><label>Åifre</label><input type="password" id="giris-sifre" placeholder="Åifreniz" autocomplete="current-password" onkeydown="if(event.key==='Enter')doGiris()"></div>
      <div class="auth-err" id="giris-err"></div>
      <button class="auth-btn" id="giris-btn" onclick="doGiris()">GiriÅŸ Yap</button>
      <div style="text-align:center;margin-top:10px"><button onclick="doSifreSifirla()" style="background:none;border:none;color:var(--orange);font-size:13px;cursor:pointer;text-decoration:underline">Åifremi Unuttum</button></div>
      <div class="auth-note">Verileriniz buluta kaydedilir. Telefon deÄŸiÅŸtirseniz bile verileriniz gÃ¼vende.</div>
    </div>
    <div id="form-kayit" style="display:none">
      <div class="auth-field"><label>E-posta</label><input type="email" id="kayit-email" placeholder="ornek@mail.com" autocomplete="email" inputmode="email"></div>
      <div class="auth-field"><label>Åifre (en az 6 karakter)</label><input type="password" id="kayit-sifre" placeholder="Åifre belirleyin" autocomplete="new-password"></div>
      <div class="auth-field"><label>Åifre Tekrar</label><input type="password" id="kayit-sifre2" placeholder="Åifreyi tekrar girin" autocomplete="new-password" onkeydown="if(event.key==='Enter')doKayit()"></div>
      <div class="auth-err" id="kayit-err"></div>
      <button class="auth-btn" id="kayit-btn" onclick="doKayit()">KayÄ±t Ol</button>
      <div class="auth-note">Her ÅŸube kendi mail adresi ile kaydolur. Siler ve yeniden yÃ¼klese bile verileri kaybolmaz.</div>
    </div>
  </div>
</div>

<div id="sube-screen">
  <div class="sube-card">
    <div class="auth-logo">BRGR</div>
    <div class="auth-sub">Ercan BRGR Envanter</div>
    <div style="font-size:16px;font-weight:700;color:#333;margin-bottom:20px">Åubenizi OluÅŸturun</div>
    <div class="auth-field" style="text-align:left">
      <label>Åube AdÄ±</label>
      <input type="text" id="sube-input" placeholder="Ã–rn: KadÄ±kÃ¶y Åubesi" style="padding:13px 14px;border:2px solid #eee;border-radius:10px;font-size:15px;outline:none;width:100%" onfocus="this.style.borderColor='#e85d04'" onblur="this.style.borderColor='#eee'" onkeydown="if(event.key==='Enter')saveSube()">
      <div style="font-size:11px;color:#aaa;margin-top:6px">Bu isim uygulamanÄ±n Ã¼st kÄ±smÄ±nda gÃ¶rÃ¼nÃ¼r</div>
    </div>
    <div class="auth-err" id="sube-err"></div>
    <button onclick="saveSube()" style="width:100%;padding:14px;background:#e85d04;color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;margin-top:8px">BaÅŸla â†’</button>
  </div>
</div>

<div id="loading-screen"><div class="spinner"></div><div class="loading-text">YÃ¼kleniyor...</div></div>

<div id="app">
  <div id="topbar">
    <button id="menu-btn" onclick="toggleDrawer()">&#9776;</button>
    <div id="topbar-title" onclick="openRenameModal()">
      <span id="product-name-display">ÃœrÃ¼n SeÃ§in</span>
      <span id="topbar-sub" style="font-size:10px;color:#ffb380">Ada tÄ±klayarak deÄŸiÅŸtir</span>
    </div>
    <div id="topbar-user" title="Oturum bilgisi"></div>
    <span id="sync-indicator" title="Senkronizasyon durumu">â˜ï¸</span>
    <select id="topbar-birim" onchange="saveBirim()" title="Birim">
      <option value="Adet">Adet</option><option value="Kg">Kg</option>
      <option value="Lt">Lt</option><option value="Paket">Paket</option><option value="Kutu">Kutu</option>
    </select>
    <button class="top-btn top-btn-add" onclick="toggleAddForm()">+ Ekle</button>
    <button class="top-btn top-btn-menu" onclick="window.print()" title="YazdÄ±r">ğŸ–¨</button>
  </div>
  <div id="drawer-overlay" onclick="closeDrawer()"></div>
  <div id="drawer">
    <div id="drawer-header"><div class="brand">BRGR ENVANTERÄ°</div><button id="drawer-close" onclick="closeDrawer()">&#10005;</button></div>
    <div id="drawer-search"><input type="text" id="search-input" placeholder="ÃœrÃ¼n ara..." oninput="filterProducts()"></div>
    <div id="product-list"></div>
    <div class="drawer-footer">
      <div class="drawer-footer-info" id="drawer-user-info"></div>
      <div class="drawer-footer-info" id="drawer-sube-info" style="color:var(--orange);font-weight:700"></div>
      <button class="drawer-btn drawer-btn-orange" onclick="openSubeModal()">Åube AdÄ±nÄ± DeÄŸiÅŸtir</button>
      <button class="drawer-btn drawer-btn-orange" onclick="addNewProduct()" style="background:#27ae60">+ Yeni ÃœrÃ¼n Ekle</button>
      <button class="drawer-btn" style="background:#3498db;color:#fff" onclick="openSatisModal();closeDrawer()">ğŸ“Š SatÄ±ÅŸ Raporu YÃ¼kle</button>
      <button class="drawer-btn" style="background:#8e44ad;color:#fff" onclick="openFaturaModal();closeDrawer()">ğŸ§¾ Fatura / Ä°rsaliye YÃ¼kle</button>
      <button class="drawer-btn drawer-btn-gray" onclick="exportData()">CSV Ä°ndir</button>
      <button class="drawer-btn drawer-btn-red" onclick="doSignOut()">Ã‡Ä±kÄ±ÅŸ Yap</button>
    </div>
  </div>
  <div id="content"><div id="page-content"></div></div>
  <div id="bottom-nav">
    <button class="btn btn-primary" style="flex:1" onclick="toggleAddForm()">+ GÃ¼n Ekle</button>
    <button class="btn btn-outline" onclick="exportData()">CSV</button>
    <button class="btn" style="background:#f0f0f0;color:#333" onclick="window.print()">YazdÄ±r</button>
  </div>
</div>

<div class="overlay" id="satis-modal">
  <div class="modal" style="max-width:560px;max-height:92vh;overflow-y:auto;padding:20px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <h3 style="margin:0;font-size:16px">ğŸ“Š SatÄ±ÅŸ Raporu Analizi</h3>
      <button onclick="closeSatisModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#aaa;line-height:1">âœ•</button>
    </div>
    <div style="font-size:12px;color:#aaa;margin-bottom:10px">POS raporunun tÃ¼m metnini aÅŸaÄŸÄ±ya yapÄ±ÅŸtÄ±rÄ±n</div>
    <textarea id="satis-text" rows="9" style="width:100%;padding:10px;border:2px solid #eee;border-radius:8px;font-size:11px;font-family:monospace;resize:vertical;outline:none;margin-bottom:10px" placeholder="JOKER ALEV ALEV BU      1        370,00&#10;TASTY CHEESE BURGE      2        940,00&#10;..." onfocus="this.style.borderColor='#e85d04'" onblur="this.style.borderColor='#eee'"></textarea>
    <button onclick="analizEt()" style="width:100%;padding:12px;background:var(--orange);color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;margin-bottom:12px">Analiz Et â†’</button>
    <div id="analiz-sonuc"></div>
  </div>
</div>

<!-- FATURA MODAL -->
<div class="overlay" id="fatura-modal">
  <div class="modal" style="max-width:580px;max-height:92vh;overflow-y:auto;padding:20px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <h3 style="margin:0;font-size:16px">ğŸ§¾ Fatura / Ä°rsaliye YÃ¼kle</h3>
      <button onclick="closeFaturaModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#aaa;line-height:1">âœ•</button>
    </div>
    <div style="font-size:12px;color:#aaa;margin-bottom:10px">Fatura veya e-Ä°rsaliye metnini yapÄ±ÅŸtÄ±rÄ±n. ÃœrÃ¼nleri algÄ±layÄ±p "Gelen" hanesine ekleyeceÄŸiz.</div>
    <textarea id="fatura-text" rows="8" style="width:100%;padding:10px;border:2px solid #eee;border-radius:8px;font-size:11px;font-family:monospace;resize:vertical;outline:none;margin-bottom:10px" placeholder="Fatura veya e-Ä°rsaliye metnini buraya yapÄ±ÅŸtÄ±rÄ±n..." onfocus="this.style.borderColor='#8e44ad'" onblur="this.style.borderColor='#eee'"></textarea>
    <button onclick="analizFatura()" style="width:100%;padding:12px;background:#8e44ad;color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;margin-bottom:12px">Analiz Et â†’</button>
    <div id="fatura-sonuc"></div>
  </div>
</div>

<div class="overlay" id="rename-modal">
  <div class="modal">
    <h3>ÃœrÃ¼n AdÄ±nÄ± DeÄŸiÅŸtir</h3>
    <input type="text" id="rename-input" placeholder="Yeni Ã¼rÃ¼n adÄ±">
    <div class="modal-actions">
      <button class="btn btn-outline btn-sm" onclick="closeRenameModal()">Ä°ptal</button>
      <button class="btn btn-primary btn-sm" onclick="confirmRename()">Kaydet</button>
    </div>
  </div>
</div>

<div id="install-bar">
  <span>Bu uygulamayÄ± telefona yÃ¼kleyin!</span>
  <div style="display:flex;gap:8px">
    <button onclick="installApp()" style="background:#fff;color:var(--orange);border:none;padding:8px 14px;border-radius:6px;font-weight:700;cursor:pointer">YÃ¼kle</button>
    <button onclick="document.getElementById('install-bar').classList.remove('show')" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.5);padding:8px 10px;border-radius:6px;cursor:pointer">âœ•</button>
  </div>
</div>
<div id="toast"></div>

<script>
const SUPA_URL='https://gqhfxpczgxksbfybfesz.supabase.co';
const SUPA_KEY='sb_publishable_0L6Pcm4GYzaEyIQ8Dup-6A_LqT-Z-FS';
const ADMIN_EMAIL='brgrercan@gmail.com';
const {createClient}=supabase;
const sb=createClient(SUPA_URL,SUPA_KEY);
let currentUser=null,isAdmin=false,appData={products:[]},currentProduct=0,showAddForm=false,syncTimeout=null;
const DEFAULT_PRODUCTS=[
  {name:'Mini Et Burger',birim:'Kg'},{name:'Joker Burger',birim:'Kg'},
  {name:'Super Burger',birim:'Kg'},{name:'Tasty Burger',birim:'Kg'},
  {name:'Special',birim:'Kg'},{name:'Mini Tavuk',birim:'Kg'},
  {name:'Tavuk Burger',birim:'Kg'},{name:'Tenders',birim:'Kg'},
  {name:'Patates',birim:'Kg'},{name:'Nugget',birim:'Kg'},
  {name:'SoÄŸan HalkasÄ±',birim:'Kg'},{name:'Ã‡Ä±tÄ±r Tavuk',birim:'Kg'},
  {name:'Stick Peynir',birim:'Adet'},{name:'Karamelize SoÄŸan',birim:'Kg'},
  {name:'FÃ¼me',birim:'Kg'},{name:'KÄ±zartma YaÄŸÄ±',birim:'Lt'},
  {name:'80 gr Ekmek',birim:'Adet'},{name:'Mini Ekmek',birim:'Adet'},
  {name:'Kutu Ä°Ã§ecekler',birim:'Adet'},{name:'Soda Grubu',birim:'Adet'},
  {name:'1 Litrelik Ä°Ã§ecekler',birim:'Adet'},{name:'ÃœrÃ¼n 22',birim:'Adet'},
  {name:'ÃœrÃ¼n 23',birim:'Adet'},{name:'ÃœrÃ¼n 24',birim:'Adet'},{name:'ÃœrÃ¼n 25',birim:'Adet'}
];
function toast(msg,dur=2500){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),dur);}
function switchTab(tab){document.getElementById('tab-giris').classList.toggle('active',tab==='giris');document.getElementById('tab-kayit').classList.toggle('active',tab==='kayit');document.getElementById('form-giris').style.display=tab==='giris'?'':'none';document.getElementById('form-kayit').style.display=tab==='kayit'?'':'none';}
async function doGiris(){const email=document.getElementById('giris-email').value.trim(),pass=document.getElementById('giris-sifre').value,errEl=document.getElementById('giris-err'),btn=document.getElementById('giris-btn');if(!email||!pass){errEl.textContent='E-posta ve ÅŸifre girin';return;}btn.disabled=true;btn.textContent='GiriÅŸ yapÄ±lÄ±yor...';errEl.textContent='';const{data,error}=await sb.auth.signInWithPassword({email,password:pass});btn.disabled=false;btn.textContent='GiriÅŸ Yap';if(error){let msg='GiriÅŸ baÅŸarÄ±sÄ±z';if(error.message.includes('Invalid login'))msg='E-posta veya ÅŸifre hatalÄ±';else if(error.message.includes('Email not confirmed'))msg='E-postanÄ±zÄ± onaylayÄ±n';errEl.textContent=msg;return;}await onSignedIn(data.user);}
async function doKayit(){const email=document.getElementById('kayit-email').value.trim(),pass=document.getElementById('kayit-sifre').value,pass2=document.getElementById('kayit-sifre2').value,errEl=document.getElementById('kayit-err'),btn=document.getElementById('kayit-btn');if(!email||!pass){errEl.textContent='E-posta ve ÅŸifre girin';return;}if(pass.length<6){errEl.textContent='Åifre en az 6 karakter olmalÄ±';return;}if(pass!==pass2){errEl.textContent='Åifreler eÅŸleÅŸmiyor';return;}btn.disabled=true;btn.textContent='KayÄ±t olunuyor...';errEl.textContent='';const{data,error}=await sb.auth.signUp({email,password:pass});btn.disabled=false;btn.textContent='KayÄ±t Ol';if(error){let msg='KayÄ±t baÅŸarÄ±sÄ±z';if(error.message.includes('already registered'))msg='Bu e-posta zaten kayÄ±tlÄ±, giriÅŸ yapÄ±n';else if(error.message.includes('invalid'))msg='GeÃ§erli bir e-posta girin';errEl.textContent=msg;return;}if(data.user&&!data.session){errEl.style.color='#27ae60';errEl.textContent='Onay e-postasÄ± gÃ¶nderildi! Gelen kutunuzu kontrol edin.';return;}await onSignedIn(data.user);}
async function doSifreSifirla(){const email=document.getElementById('giris-email').value.trim();if(!email){document.getElementById('giris-err').textContent='Ã–nce e-posta adresinizi girin';return;}const{error}=await sb.auth.resetPasswordForEmail(email,{redirectTo:'https://ercanbrgr.github.io/envanter-site'});if(error){document.getElementById('giris-err').textContent='Hata: '+error.message;return;}document.getElementById('giris-err').style.color='#27ae60';document.getElementById('giris-err').textContent='Åifre sÄ±fÄ±rlama linki e-postanÄ±za gÃ¶nderildi!';}
async function doSignOut(){if(!confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz?'))return;await sb.auth.signOut();currentUser=null;isAdmin=false;appData={products:[]};showScreen('auth-screen');}
function showScreen(id){['auth-screen','sube-screen','loading-screen','app'].forEach(s=>{const el=document.getElementById(s);if(s==='app'){el.style.display=s===id?'flex':'none';if(s===id)el.style.flexDirection='column';}else{el.style.display=s===id?'flex':'none';}});}
async function onSignedIn(user){currentUser=user;isAdmin=(user.email===ADMIN_EMAIL);showScreen('loading-screen');const profil=await loadProfil();if(!profil){showScreen('sube-screen');setTimeout(()=>document.getElementById('sube-input').focus(),300);return;}await loadAllData();openApp();}
async function loadProfil(){const{data}=await sb.from('sube_profiller').select('*').eq('user_id',currentUser.id).single();return data;}
async function saveSube(){const sube=document.getElementById('sube-input').value.trim();if(!sube){document.getElementById('sube-err').textContent='Åube adÄ± girin';return;}document.getElementById('sube-err').textContent='';const{error}=await sb.from('sube_profiller').upsert({user_id:currentUser.id,sube_adi:sube});if(error){document.getElementById('sube-err').textContent='Kaydedilemedi: '+error.message;return;}await initDefaultProducts();await loadAllData();openApp();}
async function addNewProduct(){const ad=prompt('Yeni Ã¼rÃ¼n adÄ±:');if(!ad||!ad.trim())return;const birim=prompt('Birimi (Adet / Kg / Lt / Paket / Kutu):','Adet')||'Adet';const sira=appData.products.length;const{data,error}=await sb.from('urunler').insert({user_id:currentUser.id,sira,ad:ad.trim(),birim,koli:'',adet_koli:''}).select().single();if(error){toast('Eklenemedi: '+error.message,4000);return;}appData.products.push({id:data.id,sira,name:ad.trim(),birim,koli:'',adet:'',entries:[]});currentProduct=appData.products.length-1;showAddForm=false;renderSidebar();renderPage();closeDrawer();toast('ÃœrÃ¼n eklendi: '+ad.trim());}
async function openSubeModal(){const profil=await loadProfil();const yeni=prompt('Yeni ÅŸube adÄ±:',profil?.sube_adi||'');if(yeni&&yeni.trim()){await sb.from('sube_profiller').upsert({user_id:currentUser.id,sube_adi:yeni.trim()});document.getElementById('topbar-user').textContent=yeni.trim();document.getElementById('drawer-sube-info').textContent=yeni.trim();toast('Åube adÄ± gÃ¼ncellendi');}}
async function loadAllData(){const{data:urunler}=await sb.from('urunler').select('*').eq('user_id',currentUser.id).order('sira');const{data:girdiler}=await sb.from('gunluk_girdiler').select('*').eq('user_id',currentUser.id).order('tarih',{ascending:true});appData.products=(urunler||[]).map(u=>({id:u.id,sira:u.sira,name:u.ad,birim:u.birim||'Adet',koli:u.koli||'',adet:u.adet_koli||'',entries:(girdiler||[]).filter(g=>g.urun_sira===u.sira).map(g=>({dbId:g.id,gun:g.gun||'',tarih:g.tarih||'',acilis:g.acilis||'',gelen:g.gelen||'',gelenIade:g.gelen_iade||'',transfer:g.transfer||'',kapanis:g.kapanis||'',mallara:g.mallara_gore||'',zayi:g.zayi||'',odenmez:g.odenmez||''}))}))}
async function initDefaultProducts(){const inserts=DEFAULT_PRODUCTS.map((p,i)=>({user_id:currentUser.id,sira:i,ad:p.name,birim:p.birim,koli:'',adet_koli:''}));await sb.from('urunler').upsert(inserts,{onConflict:'user_id,sira'});}
async function openApp(){showScreen('app');const profil=await loadProfil();const subeAdi=profil?.sube_adi||currentUser.email;document.getElementById('topbar-user').textContent=subeAdi;document.getElementById('drawer-user-info').textContent=currentUser.email;document.getElementById('drawer-sube-info').textContent=subeAdi;setSyncIcon('ok');if(isAdmin){document.getElementById('topbar-user').innerHTML=subeAdi+' <span class="admin-badge">ADMÄ°N</span>';}renderSidebar();if(isAdmin)renderAdminPanel();else renderPage();}
function setSyncIcon(state){const el=document.getElementById('sync-indicator');if(state==='ok')el.textContent='â˜ï¸';else if(state==='saving')el.textContent='ğŸ”„';else if(state==='err')el.textContent='âš ï¸';}
function toggleDrawer(){document.getElementById('drawer').classList.toggle('open');document.getElementById('drawer-overlay').classList.toggle('open');}
function closeDrawer(){document.getElementById('drawer').classList.remove('open');document.getElementById('drawer-overlay').classList.remove('open');}
function renderSidebar(filter=''){const list=document.getElementById('product-list');list.innerHTML='';if(isAdmin){const div=document.createElement('div');div.className='product-item'+(currentProduct===-1?' active':'');div.innerHTML='<span class="num">â­</span><span class="pname">Admin Paneli</span>';div.onclick=()=>{currentProduct=-1;showAddForm=false;renderAdminPanel();closeDrawer();};list.appendChild(div);}appData.products.forEach((p,i)=>{if(filter&&!p.name.toLowerCase().includes(filter.toLowerCase()))return;const div=document.createElement('div');div.className='product-item'+(i===currentProduct?' active':'');div.innerHTML=`<span class="num">${i+1}</span><span class="pname">${p.name}</span>${p.entries.length?`<span class="badge">${p.entries.length}</span>`:''}`;div.onclick=()=>{currentProduct=i;showAddForm=false;renderSidebar(document.getElementById('search-input').value);renderPage();closeDrawer();};list.appendChild(div);});}
function filterProducts(){renderSidebar(document.getElementById('search-input').value);}
function n(v){return parseFloat(String(v).replace(',','.'))||0;}
function r(v){return Math.round(v*100)/100;}
function calcEntry(e){const a=n(e.acilis),g=n(e.gelen),gi=n(e.gelenIade),t=n(e.transfer),k=n(e.kapanis),m=n(e.mallara),z=n(e.zayi),o=n(e.odenmez);const sayima=r(a+g-gi-t-k);return{sayima,fark:r(m-sayima+z+o)};}
function getStats(entries){if(!entries.length)return{last:'-',totalFark:0,posCount:0,negCount:0};let totalFark=0,posCount=0,negCount=0;entries.forEach(e=>{const{fark}=calcEntry(e);totalFark+=fark;if(fark>0)posCount++;else if(fark<0)negCount++;});const last=entries[entries.length-1];return{last:last.kapanis!==''?last.kapanis:'-',totalFark:r(totalFark),posCount,negCount};}
let selectedMonth=new Date().toISOString().slice(0,7);
function getMonthOptions(entries){const months=new Set();entries.forEach(e=>{if(e.tarih&&e.tarih.length>=7)months.add(e.tarih.slice(0,7));});return[...months].sort().reverse();}
function monthLabel(ym){if(!ym)return'TÃ¼mÃ¼';const[y,m]=ym.split('-');const adlar=['','Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];return adlar[parseInt(m)]+' '+y;}
function changeMonth(val){selectedMonth=val;renderPage();}
function renderPage(){if(!appData.products.length){document.getElementById('page-content').innerHTML='<div class="empty"><div class="ico">â³</div><p>Veriler yÃ¼kleniyor...</p></div>';return;}const p=appData.products[currentProduct];if(!p)return;const birim=p.birim||'Adet';document.getElementById('product-name-display').textContent=p.name;document.getElementById('topbar-sub').textContent=`${birim} â€¢ Ada tÄ±kla deÄŸiÅŸtir`;const birimEl=document.getElementById('topbar-birim');if(birimEl)birimEl.value=birim;const months=getMonthOptions(p.entries);if(months.length&&!months.includes(selectedMonth))selectedMonth=months[0]||selectedMonth;const filtered=selectedMonth==='tumu'?p.entries:p.entries.filter(e=>e.tarih&&e.tarih.startsWith(selectedMonth));const stats=getStats(filtered);const fc=stats.totalFark>0?'green':stats.totalFark<0?'red':'';let monthBar=`<div style="background:#fff;border-radius:12px;padding:10px 14px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,0.06);display:flex;align-items:center;gap:10px;flex-wrap:wrap"><span style="font-size:11px;font-weight:700;color:#999;text-transform:uppercase">Ay Filtresi</span><select onchange="changeMonth(this.value)" style="padding:7px 12px;border:2px solid #eee;border-radius:8px;font-size:13px;font-weight:700;outline:none;color:#333"><option value="tumu" ${selectedMonth==='tumu'?'selected':''}>TÃ¼mÃ¼</option>${months.map(m=>`<option value="${m}" ${m===selectedMonth?'selected':''}>${monthLabel(m)}</option>`).join('')}</select><span style="font-size:12px;color:#aaa">${filtered.length} giriÅŸ</span></div>`;let html=monthBar;if(showAddForm){const last=p.entries.length?p.entries[p.entries.length-1]:null;const nextAcilis=last&&last.kapanis!==''?last.kapanis:'';html+=`<div class="add-card" id="add-form"><h3>Yeni GÃ¼n Ekle</h3><div class="form-grid"><div class="ff"><label>GÃ¼n</label><input type="number" id="f-gun" value="${p.entries.length+1}" inputmode="numeric"></div><div class="ff"><label>Tarih</label><input type="date" id="f-tarih" value="${new Date().toISOString().split('T')[0]}"></div><div class="ff"><label>AÃ§Ä±lÄ±ÅŸ (${birim})</label><input type="number" id="f-acilis" value="${nextAcilis}" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div><div class="ff"><label>Gelen (${birim})</label><input type="number" id="f-gelen" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div><div class="ff"><label>Gelen Ä°ade</label><input type="number" id="f-gelenIade" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div><div class="ff"><label>Transfer</label><input type="number" id="f-transfer" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div><div class="ff"><label>KapanÄ±ÅŸ (${birim})</label><input type="number" id="f-kapanis" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div><div class="ff"><label>SayÄ±ma GÃ¶re KullanÄ±lan</label><input type="number" id="f-sayima" class="calc" readonly placeholder="Otomatik"></div><div class="ff"><label>Mallara GÃ¶re SatÄ±lan</label><input type="number" id="f-mallara" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div><div class="ff"><label>Zayi</label><input type="number" id="f-zayi" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div><div class="ff"><label>Ã–denmez</label><input type="number" id="f-odenmez" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div><div class="ff"><label>FARK +/-</label><input type="number" id="f-fark" class="calc" readonly placeholder="Otomatik"></div></div><div class="form-actions"><button class="btn btn-primary" onclick="addEntry()">Kaydet</button><button class="btn btn-outline" onclick="toggleAddForm()">Ä°ptal</button></div></div>`;}const ayLabel=selectedMonth==='tumu'?'TÃ¼mÃ¼':monthLabel(selectedMonth);html+=`<div class="stats-row"><div class="stat-card"><div class="sl">Son KapanÄ±ÅŸ</div><div class="sv">${stats.last}</div></div><div class="stat-card orange"><div class="sl">${ayLabel} GÃ¼n</div><div class="sv">${filtered.length}</div></div><div class="stat-card ${fc}"><div class="sl">${ayLabel} Fark</div><div class="sv">${stats.totalFark>0?'+':''}${stats.totalFark}</div></div><div class="stat-card"><div class="sl">+ / - GÃ¼n</div><div class="sv" style="font-size:16px"><span style="color:#27ae60">+${stats.posCount}</span> / <span style="color:#e74c3c">${stats.negCount}</span></div></div></div>`;if(!p.entries.length){html+=`<div class="empty"><div class="ico">ğŸ“‹</div><p>HenÃ¼z giriÅŸ yok.<br><strong>+ Ekle</strong> butonuna basÄ±n.</p></div>`;}else if(!filtered.length){html+=`<div class="empty"><div class="ico">ğŸ“…</div><p>${ayLabel} iÃ§in giriÅŸ yok.</p></div>`;}else{html+=`<div class="table-card"><div class="table-scroll"><table><thead><tr><th>#</th><th>GÃ¼n</th><th>Tarih</th><th>AÃ§Ä±lÄ±ÅŸ<br>(${birim})</th><th>Gelen<br>(${birim})</th><th>G.Ä°ade</th><th>Transfer</th><th>KapanÄ±ÅŸ<br>(${birim})</th><th>SayÄ±ma GÃ¶re<br>KullanÄ±lan</th><th>Mallara GÃ¶re<br>SatÄ±lan</th><th>Zayi</th><th>Ã–denmez</th><th>FARK +/-</th></tr></thead><tbody>`;filtered.forEach(e=>{const idx=p.entries.indexOf(e);const{sayima,fark}=calcEntry(e);const fc2=fark>0?'fp':fark<0?'fn':'fz';const hasData=e.acilis!==''||e.kapanis!=='';html+=`<tr><td><button class="del-btn" onclick="deleteEntry(${idx})">âœ•</button></td><td><input type="number" value="${e.gun||''}" onchange="updateEntry(${idx},'gun',this.value)" inputmode="numeric"></td><td><input type="date" value="${e.tarih||''}" onchange="updateEntry(${idx},'tarih',this.value)" style="width:130px"></td><td><input type="number" value="${e.acilis||''}" onchange="updateEntry(${idx},'acilis',this.value)" step="0.01" inputmode="decimal"></td><td><input type="number" value="${e.gelen||''}" onchange="updateEntry(${idx},'gelen',this.value)" step="0.01" inputmode="decimal"></td><td><input type="number" value="${e.gelenIade||''}" onchange="updateEntry(${idx},'gelenIade',this.value)" step="0.01" inputmode="decimal"></td><td><input type="number" value="${e.transfer||''}" onchange="updateEntry(${idx},'transfer',this.value)" step="0.01" inputmode="decimal"></td><td><input type="number" value="${e.kapanis||''}" onchange="updateEntry(${idx},'kapanis',this.value)" step="0.01" inputmode="decimal"></td><td class="calc">${hasData?sayima:''}</td><td><input type="number" value="${e.mallara||''}" onchange="updateEntry(${idx},'mallara',this.value)" step="0.01" inputmode="decimal"></td><td><input type="number" value="${e.zayi||''}" onchange="updateEntry(${idx},'zayi',this.value)" step="0.01" inputmode="decimal"></td><td><input type="number" value="${e.odenmez||''}" onchange="updateEntry(${idx},'odenmez',this.value)" step="0.01" inputmode="decimal"></td><td class="${fc2}">${hasData?(fark>0?'+':'')+fark:''}</td></tr>`;});html+=`</tbody></table></div></div>`;}document.getElementById('page-content').innerHTML=html;}
function liveCalc(){const g=id=>n(document.getElementById(id)?.value);const sayima=r(g('f-acilis')+g('f-gelen')-g('f-gelenIade')-g('f-transfer')-g('f-kapanis'));const fark=r(g('f-mallara')-sayima+g('f-zayi')+g('f-odenmez'));const se=document.getElementById('f-sayima'),fe=document.getElementById('f-fark');if(se)se.value=sayima;if(fe){fe.value=(fark>0?'+':'')+fark;fe.className='calc '+(fark>0?'fpos':fark<0?'fneg':'');}}
function scheduleSave(idx){setSyncIcon('saving');clearTimeout(syncTimeout);syncTimeout=setTimeout(()=>syncEntry(idx),800);}
async function syncEntry(idx){const p=appData.products[currentProduct];const e=p.entries[idx];const row={user_id:currentUser.id,urun_sira:p.sira,gun:e.gun||'',tarih:e.tarih||null,acilis:e.acilis||'',gelen:e.gelen||'',gelen_iade:e.gelenIade||'',transfer:e.transfer||'',kapanis:e.kapanis||'',mallara_gore:e.mallara||'',zayi:e.zayi||'',odenmez:e.odenmez||''};let res;if(e.dbId){res=await sb.from('gunluk_girdiler').update(row).eq('id',e.dbId);}else{res=await sb.from('gunluk_girdiler').insert(row).select().single();if(res.data)e.dbId=res.data.id;}if(res.error){setSyncIcon('err');toast('KayÄ±t hatasÄ±: '+res.error.message,4000);}else{setSyncIcon('ok');}}
async function syncBirim(sira,birim){await sb.from('urunler').update({birim}).eq('user_id',currentUser.id).eq('sira',sira);}
async function syncProductName(sira,ad){await sb.from('urunler').update({ad}).eq('user_id',currentUser.id).eq('sira',sira);}
function toggleAddForm(){showAddForm=!showAddForm;renderPage();if(showAddForm){setTimeout(()=>{const el=document.getElementById('add-form');if(el)el.scrollIntoView({behavior:'smooth'})},50);}}
async function addEntry(){const v=x=>document.getElementById(x)?.value||'';const p=appData.products[currentProduct];const entry={gun:v('f-gun'),tarih:v('f-tarih'),acilis:v('f-acilis'),gelen:v('f-gelen'),gelenIade:v('f-gelenIade'),transfer:v('f-transfer'),kapanis:v('f-kapanis'),mallara:v('f-mallara'),zayi:v('f-zayi'),odenmez:v('f-odenmez')};p.entries.push(entry);showAddForm=false;renderSidebar(document.getElementById('search-input').value);renderPage();await syncEntry(p.entries.length-1);toast('Kaydedildi â˜ï¸');}
async function updateEntry(idx,field,val){appData.products[currentProduct].entries[idx][field]=val;renderPage();scheduleSave(idx);}
async function deleteEntry(idx){if(!confirm('Bu giriÅŸi silmek istediÄŸinize emin misiniz?'))return;const p=appData.products[currentProduct];const e=p.entries[idx];if(e.dbId){const{error}=await sb.from('gunluk_girdiler').delete().eq('id',e.dbId);if(error){toast('Silme hatasÄ±');return;}}p.entries.splice(idx,1);renderSidebar(document.getElementById('search-input').value);renderPage();toast('Silindi');}
async function saveBirim(){const p=appData.products[currentProduct];p.birim=document.getElementById('topbar-birim').value;renderPage();await syncBirim(p.sira,p.birim);}
function openRenameModal(){document.getElementById('rename-input').value=appData.products[currentProduct].name;document.getElementById('rename-modal').classList.add('show');setTimeout(()=>document.getElementById('rename-input').focus(),100);}
function closeRenameModal(){document.getElementById('rename-modal').classList.remove('show');}
async function confirmRename(){const v=document.getElementById('rename-input').value.trim();if(v){const p=appData.products[currentProduct];p.name=v;renderSidebar();renderPage();await syncProductName(p.sira,v);toast('ÃœrÃ¼n adÄ± gÃ¼ncellendi');}closeRenameModal();}
document.getElementById('rename-input').addEventListener('keydown',e=>{if(e.key==='Enter')confirmRename();if(e.key==='Escape')closeRenameModal();});
function exportData(){const p=appData.products[currentProduct];if(!p)return;const doFilter=selectedMonth&&selectedMonth!=='tumu';const entries=doFilter?p.entries.filter(e=>e.tarih&&e.tarih.startsWith(selectedMonth)):p.entries;if(!entries.length){toast('Bu dÃ¶nemde giriÅŸ yok');return;}const ayLabel=doFilter?monthLabel(selectedMonth):'TÃ¼m_Aylar';const esc=v=>{const s=String(v??'');return(s.includes(',')||s.includes('"'))?'"'+s.replace(/"/g,'""')+'"':s;};const cols=['Gun','Tarih','Acilis','Gelen','Gelen_Iade','Transfer','Kapanis','Sayima_Gore_Kullanilan','Mallara_Gore_Satilan','Zayi','Odenmez','FARK'];let csv=cols.join(';')+'\n';entries.forEach(e=>{const{sayima,fark}=calcEntry(e);csv+=[e.gun,e.tarih,e.acilis||0,e.gelen||0,e.gelenIade||0,e.transfer||0,e.kapanis||0,sayima,e.mallara||0,e.zayi||0,e.odenmez||0,fark].map(esc).join(';')+'\n';});const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}));a.download=(p.name+'_'+ayLabel).replace(/[\s\/\\:*?"<>|]/g,'_')+'.csv';a.click();toast('Excel dosyasÄ± indirildi âœ“');}
let adminData={profiller:[],urunler:[],girdiler:[]},adminSecilenSube=null,adminSecilenUrun=null;
async function renderAdminPanel(){currentProduct=-1;document.getElementById('product-name-display').textContent='Admin Paneli';document.getElementById('topbar-sub').textContent='TÃ¼m ÅŸubeler';document.getElementById('page-content').innerHTML='<div class="empty"><div class="ico">â³</div><p>Åubeler yÃ¼kleniyor...</p></div>';const{data:profiller,error}=await sb.from('sube_profiller').select('*');if(error){document.getElementById('page-content').innerHTML='<div class="empty"><p>Veri yÃ¼klenemedi: '+error.message+'</p></div>';return;}if(!profiller||!profiller.length){document.getElementById('page-content').innerHTML='<div class="empty"><div class="ico">ğŸª</div><p>HenÃ¼z kayÄ±tlÄ± ÅŸube yok.</p></div>';return;}const{data:tumGirdiler,error:ge}=await sb.from('gunluk_girdiler').select('*');const{data:tumUrunler,error:ue}=await sb.from('urunler').select('*').order('sira');if(ge){toast('Girdiler yÃ¼klenemedi: '+ge.message,5000);}if(ue){toast('ÃœrÃ¼nler yÃ¼klenemedi: '+ue.message,5000);}adminData={profiller,urunler:tumUrunler||[],girdiler:tumGirdiler||[]};adminSecilenSube=null;adminSecilenUrun=null;renderAdminAnaSayfa();}
function renderAdminAnaSayfa(){const{profiller,urunler,girdiler}=adminData;let html=`<div class="admin-panel"><h2>â­ Admin Paneli <span class="admin-badge">TÃœM ÅUBELER</span></h2><div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap"><button onclick="renderAdminAnaSayfa()" style="padding:8px 14px;background:var(--orange);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">ğŸª Åubeler</button><button onclick="renderAdminAylikRapor()" style="padding:8px 14px;background:var(--dark);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">ğŸ“Š AylÄ±k Rapor</button><button onclick="adminTumCSV()" style="padding:8px 14px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">ğŸ“¥ TÃ¼m Veriyi Ä°ndir</button></div><div style="font-size:12px;color:#999;margin-bottom:12px">${profiller.length} ÅŸube kayÄ±tlÄ± â€” ÅŸubeye tÄ±klayÄ±n</div>`;profiller.forEach(p=>{const pUrunler=urunler.filter(u=>u.user_id===p.user_id);const pGirdiler=girdiler.filter(g=>g.user_id===p.user_id);let toplamFark=0;pGirdiler.forEach(g=>{const e={acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez};toplamFark+=calcEntry(e).fark;});toplamFark=r(toplamFark);const fc=toplamFark>0?'s-green':toplamFark<0?'s-red':'';html+=`<div class="sube-card-admin" onclick="adminAcSube('${p.user_id}')"><h3>ğŸª ${p.sube_adi} <span style="font-size:11px;color:#aaa;font-weight:400">â†’ tÄ±kla</span></h3><div class="sube-stats"><div class="sube-stat">${pUrunler.length} Ã¼rÃ¼n</div><div class="sube-stat">${pGirdiler.length} giriÅŸ</div><div class="sube-stat ${fc}">${toplamFark>0?'+':''}${toplamFark} fark</div></div></div>`;});html+=`</div>`;document.getElementById('page-content').innerHTML=html;}
function adminAcSube(userId){adminSecilenSube=userId;adminSecilenUrun=null;const profil=adminData.profiller.find(p=>p.user_id===userId);const urunler=adminData.urunler.filter(u=>u.user_id===userId);const girdiler=adminData.girdiler.filter(g=>g.user_id===userId);let html=`<div class="admin-panel"><div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><button onclick="renderAdminAnaSayfa()" style="background:var(--dark);color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;font-size:13px;font-weight:700">â† Geri</button><h2 style="margin:0">ğŸª ${profil?.sube_adi||'Åube'}</h2></div><div style="font-size:12px;color:#999;margin-bottom:12px">${urunler.length} Ã¼rÃ¼n â€” bir Ã¼rÃ¼ne tÄ±klayarak giriÅŸleri gÃ¶rÃ¼n</div>`;urunler.forEach(u=>{const uGirdiler=girdiler.filter(g=>g.urun_sira===u.sira);let toplamFark=0;uGirdiler.forEach(g=>{const e={acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez};toplamFark+=calcEntry(e).fark;});toplamFark=r(toplamFark);const fc=toplamFark>0?'s-green':toplamFark<0?'s-red':'';html+=`<div class="sube-card-admin" onclick="adminAcUrun('${userId}',${u.sira})"><h3>${u.sira+1}. ${u.ad} <span style="font-size:10px;color:#aaa">(${u.birim})</span></h3><div class="sube-stats"><div class="sube-stat">${uGirdiler.length} gÃ¼n</div><div class="sube-stat ${fc}">${toplamFark>0?'+':''}${toplamFark} toplam fark</div></div></div>`;});html+=`</div>`;document.getElementById('page-content').innerHTML=html;}
function renderAdminAylikRapor(){const{profiller,urunler,girdiler}=adminData;const months=[...new Set(girdiler.filter(g=>g.tarih).map(g=>g.tarih.slice(0,7)))].sort().reverse();let html=`<div class="admin-panel"><div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap"><button onclick="renderAdminAnaSayfa()" style="padding:8px 14px;background:var(--dark);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">â† Geri</button><h2 style="margin:0;align-self:center">ğŸ“Š AylÄ±k Rapor</h2></div>`;if(!months.length){html+=`<div class="empty"><div class="ico">ğŸ“…</div><p>HenÃ¼z tarihli giriÅŸ yok.</p></div>`;}else{months.forEach(ay=>{const ayGirdiler=girdiler.filter(g=>g.tarih&&g.tarih.startsWith(ay));let toplamFark=0,toplamSatilan=0,toplamSayima=0;ayGirdiler.forEach(g=>{const e={acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez};const{sayima,fark}=calcEntry(e);toplamFark+=fark;toplamSatilan+=n(g.mallara_gore);toplamSayima+=sayima;});toplamFark=r(toplamFark);toplamSatilan=r(toplamSatilan);toplamSayima=r(toplamSayima);const subeSet=new Set(ayGirdiler.map(g=>g.user_id));const fc=toplamFark>0?'s-green':toplamFark<0?'s-red':'';html+=`<div class="sube-card-admin" style="cursor:default"><h3>ğŸ“… ${monthLabel(ay)}</h3><div class="sube-stats"><div class="sube-stat">${subeSet.size} ÅŸube aktif</div><div class="sube-stat">${ayGirdiler.length} giriÅŸ</div><div class="sube-stat">SatÄ±lan: ${toplamSatilan}</div><div class="sube-stat">SayÄ±ma: ${toplamSayima}</div><div class="sube-stat ${fc}">${toplamFark>0?'+':''}${toplamFark} fark</div></div><div style="margin-top:8px"><button onclick="adminAyCSV('${ay}')" style="padding:5px 12px;background:var(--orange);color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">Excel Ä°ndir</button></div></div>`;});}html+=`</div>`;document.getElementById('page-content').innerHTML=html;}
function adminAyCSV(ay){const{profiller,urunler,girdiler}=adminData;const ayGirdiler=girdiler.filter(g=>g.tarih&&g.tarih.startsWith(ay));if(!ayGirdiler.length){toast('Bu ayda giriÅŸ yok');return;}const esc=v=>{const s=String(v??'');return(s.includes(';')||s.includes('"'))?'"'+s.replace(/"/g,'""')+'"':s;};const cols=['Sube','Urun','Gun','Tarih','Acilis','Gelen','Gelen_Iade','Transfer','Kapanis','Sayima_Kullanilan','Mallara_Satilan','Zayi','Odenmez','FARK'];let csv=cols.join(';')+'\n';ayGirdiler.forEach(g=>{const profil=profiller.find(p=>p.user_id===g.user_id);const urun=urunler.find(u=>u.user_id===g.user_id&&u.sira===g.urun_sira);const{sayima,fark}=calcEntry({acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez});csv+=[profil?.sube_adi,urun?.ad,g.gun,g.tarih,g.acilis||0,g.gelen||0,g.gelen_iade||0,g.transfer||0,g.kapanis||0,sayima,g.mallara_gore||0,g.zayi||0,g.odenmez||0,fark].map(esc).join(';')+'\n';});const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}));a.download='Tum_Subeler_'+monthLabel(ay).replace(/\s/g,'_')+'.csv';a.click();toast('Excel indirildi âœ“');}
function adminTumCSV(){const{profiller,urunler,girdiler}=adminData;if(!girdiler.length){toast('Veri yok');return;}const esc=v=>{const s=String(v??'');return(s.includes(';')||s.includes('"'))?'"'+s.replace(/"/g,'""')+'"':s;};const cols=['Sube','Urun','Gun','Tarih','Acilis','Gelen','Gelen_Iade','Transfer','Kapanis','Sayima_Kullanilan','Mallara_Satilan','Zayi','Odenmez','FARK'];let csv=cols.join(';')+'\n';girdiler.forEach(g=>{const profil=profiller.find(p=>p.user_id===g.user_id);const urun=urunler.find(u=>u.user_id===g.user_id&&u.sira===g.urun_sira);const{sayima,fark}=calcEntry({acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez});csv+=[profil?.sube_adi,urun?.ad,g.gun,g.tarih,g.acilis||0,g.gelen||0,g.gelen_iade||0,g.transfer||0,g.kapanis||0,sayima,g.mallara_gore||0,g.zayi||0,g.odenmez||0,fark].map(esc).join(';')+'\n';});const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}));a.download='BRGR_Tum_Veriler_'+new Date().toISOString().slice(0,10)+'.csv';a.click();toast('TÃ¼m veriler indirildi âœ“');}
let adminSecAy='tumu';
function adminAcUrun(userId,sira,secAy){adminSecAy=secAy||'tumu';const profil=adminData.profiller.find(p=>p.user_id===userId);const urun=adminData.urunler.find(u=>u.user_id===userId&&u.sira===sira);const tumGirdiler=adminData.girdiler.filter(g=>g.user_id===userId&&g.urun_sira===sira);const birim=urun?.birim||'Adet';const months=[...new Set(tumGirdiler.filter(g=>g.tarih).map(g=>g.tarih.slice(0,7)))].sort().reverse();const girdiler=adminSecAy==='tumu'?tumGirdiler:tumGirdiler.filter(g=>g.tarih&&g.tarih.startsWith(adminSecAy));const ayLabel=adminSecAy==='tumu'?'TÃ¼mÃ¼':monthLabel(adminSecAy);let html=`<div class="admin-panel"><div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap"><button onclick="adminAcSube('${userId}')" style="background:var(--dark);color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;font-size:13px;font-weight:700">â† Geri</button><h2 style="margin:0;font-size:14px">ğŸª ${profil?.sube_adi} â€º ${urun?.ad}</h2></div><div style="background:#f8f8f8;border-radius:10px;padding:10px 14px;margin-bottom:12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap"><span style="font-size:11px;font-weight:700;color:#999;text-transform:uppercase">Ay Filtresi</span><select onchange="adminAcUrun('${userId}',${sira},this.value)" style="padding:7px 12px;border:2px solid #eee;border-radius:8px;font-size:13px;font-weight:700;outline:none"><option value="tumu" ${adminSecAy==='tumu'?'selected':''}>TÃ¼mÃ¼</option>${months.map(m=>`<option value="${m}" ${m===adminSecAy?'selected':''}>${monthLabel(m)}</option>`).join('')}</select><button id="admin-csv-btn" style="padding:7px 14px;background:var(--orange);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">CSV Ä°ndir</button><button onclick="window.print()" style="padding:7px 14px;background:var(--dark);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">YazdÄ±r</button><span style="font-size:12px;color:#aaa">${girdiler.length} giriÅŸ</span></div>`;if(!tumGirdiler.length){html+=`<div class="empty"><div class="ico">ğŸ“‹</div><p>Bu Ã¼rÃ¼n iÃ§in henÃ¼z giriÅŸ yok.</p></div>`;}else if(!girdiler.length){html+=`<div class="empty"><div class="ico">ğŸ“…</div><p>${ayLabel} iÃ§in giriÅŸ yok.</p></div>`;}else{let toplamFark=0,posC=0,negC=0;girdiler.forEach(g=>{const f=calcEntry({acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez}).fark;toplamFark+=f;if(f>0)posC++;else if(f<0)negC++;});toplamFark=r(toplamFark);const fc=toplamFark>0?'green':toplamFark<0?'red':'';html+=`<div class="stats-row" style="margin-bottom:12px"><div class="stat-card orange"><div class="sl">${ayLabel} GÃ¼n</div><div class="sv">${girdiler.length}</div></div><div class="stat-card ${fc}"><div class="sl">${ayLabel} Fark</div><div class="sv">${toplamFark>0?'+':''}${toplamFark}</div></div><div class="stat-card"><div class="sl">+ / - GÃ¼n</div><div class="sv" style="font-size:16px"><span style="color:#27ae60">+${posC}</span> / <span style="color:#e74c3c">${negC}</span></div></div></div><div class="table-card"><div class="table-scroll"><table><thead><tr><th>GÃ¼n</th><th>Tarih</th><th>AÃ§Ä±lÄ±ÅŸ<br>(${birim})</th><th>Gelen</th><th>G.Ä°ade</th><th>Transfer</th><th>KapanÄ±ÅŸ<br>(${birim})</th><th>SayÄ±ma GÃ¶re<br>KullanÄ±lan</th><th>Mallara GÃ¶re<br>SatÄ±lan</th><th>Zayi</th><th>Ã–denmez</th><th>FARK</th></tr></thead><tbody>`;girdiler.forEach(g=>{const e={acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez};const{sayima,fark}=calcEntry(e);const fc2=fark>0?'fp':fark<0?'fn':'fz';html+=`<tr><td>${g.gun||''}</td><td>${g.tarih||''}</td><td>${g.acilis||''}</td><td>${g.gelen||''}</td><td>${g.gelen_iade||''}</td><td>${g.transfer||''}</td><td>${g.kapanis||''}</td><td class="calc">${sayima}</td><td>${g.mallara_gore||''}</td><td>${g.zayi||''}</td><td>${g.odenmez||''}</td><td class="${fc2}">${fark>0?'+':''}${fark}</td></tr>`;});html+=`</tbody></table></div></div>`;}html+=`</div>`;document.getElementById('page-content').innerHTML=html;const csvBtn=document.getElementById('admin-csv-btn');if(csvBtn)csvBtn.onclick=()=>adminExportCSV(userId,sira,adminSecAy);}
function adminExportCSV(userId,sira,secAy){const profil=adminData.profiller.find(p=>p.user_id===userId);const urun=adminData.urunler.find(u=>u.user_id===userId&&u.sira===sira);const tumGirdiler=adminData.girdiler.filter(g=>g.user_id===userId&&g.urun_sira===sira);const girdiler=secAy==='tumu'?tumGirdiler:tumGirdiler.filter(g=>g.tarih&&g.tarih.startsWith(secAy));if(!girdiler.length){toast('Bu dÃ¶nemde giriÅŸ yok');return;}const ayLabel=secAy==='tumu'?'TÃ¼m_Aylar':monthLabel(secAy).replace(/\s/g,'_');const esc=v=>{const s=String(v??'');return(s.includes(';')||s.includes('"'))?'"'+s.replace(/"/g,'""')+'"':s;};const cols=['Sube','Urun','Gun','Tarih','Acilis','Gelen','Gelen_Iade','Transfer','Kapanis','Sayima_Gore_Kullanilan','Mallara_Gore_Satilan','Zayi','Odenmez','FARK'];let csv=cols.join(';')+'\n';girdiler.forEach(g=>{const{sayima,fark}=calcEntry({acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez});csv+=[profil?.sube_adi,urun?.ad,g.gun,g.tarih,g.acilis||0,g.gelen||0,g.gelen_iade||0,g.transfer||0,g.kapanis||0,sayima,g.mallara_gore||0,g.zayi||0,g.odenmez||0,fark].map(esc).join(';')+'\n';});const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}));a.download=((profil?.sube_adi||'')+'_'+(urun?.ad||'')+'_'+ayLabel).replace(/[\s\/\\:*?"<>|]/g,'_')+'.csv';a.click();toast('Excel dosyasÄ± indirildi âœ“');}
let faturaAnalizSonucu=[];
function openFaturaModal(){document.getElementById('fatura-modal').classList.add('show');document.getElementById('fatura-sonuc').innerHTML='';document.getElementById('fatura-text').value='';}
function closeFaturaModal(){document.getElementById('fatura-modal').classList.remove('show');}
function parseFaturaLines(text){
  const results=[];
  const lines=text.split('\n');
  const tarihM=text.match(/(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{4})/);
  const tarih=tarihM?`${tarihM[3]}-${tarihM[2].padStart(2,'0')}-${tarihM[1].padStart(2,'0')}`:new Date().toISOString().slice(0,10);
  lines.forEach(line=>{
    const l=line.trim();
    if(!l||l.length<5)return;
    // Nevada e-Ä°rsaliye: "1  25.01EC.E18.0002  BURGER KÃ–FTESÄ° 120GR (1 Koli = 20,5 KG)  20,5"
    const nevM=l.match(/^\d+\s+[\w.]+\s+(.+?)\s+([\d.,]+)\s*$/);
    if(nevM){const miktar=parseFloat(nevM[2].replace(',','.'));if(miktar>0){const birim=/kg|kilo/i.test(nevM[1])?'Kg':/lt|litre/i.test(nevM[1])?'Lt':'Adet';results.push({ad:nevM[1].trim().toUpperCase(),miktar,birim,tarih});return;}}
    // ObaÅŸak e-Ä°rsaliye: "1  ST477  MÄ°NÄ° JOKER 85 GRAM  144 Adet"
    const obasM=l.match(/^\d+\s+[A-Z]+\d+\s+(.+?)\s+(\d+)\s+Adet\s*$/i);
    if(obasM){const miktar=parseInt(obasM[2]);if(miktar>0){results.push({ad:obasM[1].trim().toUpperCase(),miktar,birim:'Adet',tarih});return;}}
    // UludaÄŸ e-Ä°rsaliye: "BARKOD  ÃœRÃœNKODU  LÄ°MONATA 33CL PET 24TV  1,00  Koli  885,95 ..."
    const uldM=l.match(/^[A-Z0-9]+\s+[A-Z0-9]+\s+(.+?)\s+([\d.,]+)\s+Koli\b/i);
    if(uldM){
      const ad=uldM[1].trim().toUpperCase();
      const koli=parseFloat(uldM[2].replace(',','.'));
      let ici=24;
      const tvM=ad.match(/(\d+)TV/i);if(tvM)ici=parseInt(tvM[1]);
      const bsM=ad.match(/(\d+)BSX(\d+)/i);if(bsM)ici=parseInt(bsM[1])*parseInt(bsM[2]);
      const miktar=Math.round(koli*ici);
      results.push({ad,miktar,birim:'Adet',tarih});return;
    }
    // Coca-Cola e-Ä°rsaliye: "AÃ‡IKLAMA  7  Koli  24  168" â†’ son sayÄ± = toplam adet
    const colaM=l.match(/^(.+?)\s{2,}(\d+)\s+Koli\s+(\d+)\s+(\d+)\s*$/i);
    if(colaM){const miktar=parseInt(colaM[4]);results.push({ad:colaM[1].trim().toUpperCase(),miktar,birim:'Adet',tarih});return;}
    // Eski Cola format (toplam sÃ¼tunu yok): "ÃœRÃœN ADI   7   Koli   12"
    const colaM2=l.match(/^(.+?)\s{2,}(\d+)\s+Koli\s+(\d+)/i);
    if(colaM2){const miktar=parseInt(colaM2[2])*parseInt(colaM2[3]);results.push({ad:colaM2[1].trim().toUpperCase(),miktar,birim:'Adet',tarih});return;}
    // ObaÅŸak format: "ÃœRÃœN ADI   120 Adet" veya "ÃœRÃœN ADI   15 Kg"
    const obM=l.match(/^(.+?)\s{2,}(\d+(?:[.,]\d+)?)\s*(Adet|Kg|Lt|kg|lt|adet)/i);
    if(obM){const miktar=parseFloat(obM[2].replace(',','.'));results.push({ad:obM[1].trim().toUpperCase(),miktar,birim:obM[3],tarih});return;}
    // Genel: sayÄ± + birim aynÄ± satÄ±rda
    const genM=l.match(/^(.{5,40}?)\s+(\d+(?:[.,]\d+)?)\s*(adet|kg|lt|koli)?$/i);
    if(genM&&parseFloat(genM[2])>0){results.push({ad:genM[1].trim().toUpperCase(),miktar:parseFloat(genM[2].replace(',','.')),birim:genM[3]||'Adet',tarih});}
  });
  return{items:results,tarih};
}
function autoMapFatura(ad){
  const a=ad.toUpperCase();
  // Et / KÃ¶fte
  if(/KÃ–FTE.*MÄ°NÄ°|MÄ°NÄ°.*KÃ–FTE|KÃ–FTE.*50|50.*KÃ–FTE|MÄ°NÄ°.*50GR|50GR.*MÄ°NÄ°/.test(a))return 0;
  if(/KÃ–FTE.*JOKER|JOKER.*KÃ–FTE|KÃ–FTE.*85|85.*KÃ–FTE/.test(a))return 1;
  if(/KÃ–FTE.*120|120.*KÃ–FTE|BURGER KÃ–FTE/.test(a)&&!/85|JOKER|150|SPECIAL|SPECÄ°AL/.test(a))return 2;
  if(/SPECIAL.*150|SPECÄ°AL.*150|KÃ–FTE.*SPECIAL|KÃ–FTE.*SPECÄ°AL/.test(a))return 4;
  if(/KÃ–FTE.*150|150.*KÃ–FTE|DANA KÃ–FTE/.test(a)&&!/85|120|SPECIAL|SPECÄ°AL/.test(a))return 3;
  if(/KÃ–FTE|KIYMA|DANA/.test(a)&&!/JOKER|85|120|150|SPECIAL/.test(a))return 1;
  // Tavuk
  if(/TAVUK.*TENDER|TENDERS|TENDER.*TAVUK/.test(a))return 7;
  if(/MINI TAVUK|MÄ°NÄ° TAVUK/.test(a))return 5;
  if(/TAVUK BURGER|BURGER.*TAVUK/.test(a))return 6;
  // Ekmek â€” ObaÅŸak
  if(/MÄ°NÄ° EKMEK|MINI EKMEK|MÄ°NÄ° BUN|MINI BUN|SLIDER BUN|DOÄAL MÄ°NÄ°|DOGAL MINI/.test(a))return 17;
  if(/HAMBURGER EKMEK|BURGER BUN|80.?GR.*EKMEK|EKMEK.*80|MÄ°NÄ° JOKER.*85|JOKER.*85.*GRAM|85.*GRAM/.test(a))return 16;
  // Patates / DondurulmuÅŸ
  if(/PATATES|POM|MC.?CAIN|DONDURULMUÅ PATATES|FROZEN.*POTATO/.test(a))return 8;
  // FÃ¼me
  if(/FÃœME|FUME|DÄ°LÄ°MLÄ°.*DANA|DANA.*DÄ°LÄ°MLÄ°|SUCUK|PASTIRMA/.test(a))return 14;
  // Nugget
  if(/NUGGET/.test(a))return 9;
  // SoÄŸan HalkasÄ±
  if(/SOGAN HALKA|SOÄAN HALKA|ONION RING/.test(a))return 10;
  // Stick Peynir
  if(/STÄ°CK.*PEYNÄ°R|STICK.*PEYNIR|PEYNIR.*STÄ°CK/.test(a))return 12;
  // KÄ±zartma YaÄŸÄ±
  if(/FRITÃ–Z|FRITEUSE|FRITOZ|KIZARTMA.*YAÄ|YAÄ.*KIZARTMA|FRÄ°TÃ–Z/.test(a))return 15;
  // Ä°Ã§ecekler â€” CC kutu (330ml, 300ml RB, ÅŸiÅŸe) â†’ kutu iÃ§ecekler
  if(/CC.*PET.*1[Ll]|CC PET 1|COCA.*COLA.*1[Ll]|1[Ll].*COLA|PET.*1L/.test(a))return 20;
  if(/CC\b|COLA|FANTA|FUSE|SPRITE|SCHWEPPES|CAPPY|COCA.COLA|RB300|KUTU.*330|330.*KUTU/.test(a)&&!/1[.,]?5|2[.,]?5/.test(a))return 18;
  // UludaÄŸ iÃ§ecekleri
  if(/MADEN SUYU|FRUTTI|FRUTTÄ°|KAYNAK SUYU|PRE\.KAY|EFS\.PORT|PORTAKAL.*100|SU.*40CL/.test(a))return 19;
  if(/LÄ°MONATA.*33|LÄ°MONATA.*33|EFS.*GAZOZ.*33|EFS.*PORT.*33|GAZOZ.*33CL/.test(a))return 18;
  if(/LÄ°MONATA.*100|EFS.*GAZOZ.*100|EFS.*PORT.*100|LÄ°MONATA.*1L/.test(a))return 20;
  if(/SODA|GAZOZ|MEYVELÄ° SODA|MEYVELI/.test(a))return 19;
  if(/SU\b|DAMLA/.test(a)&&!/SODA/.test(a))return 19;
  return -1;
}
function analizFatura(){
  const text=document.getElementById('fatura-text').value.trim();
  if(!text){toast('Fatura metnini yapÄ±ÅŸtÄ±rÄ±n');return;}
  const{items,tarih}=parseFaturaLines(text);
  if(!items.length){document.getElementById('fatura-sonuc').innerHTML='<div style="color:#e74c3c;font-size:13px;padding:10px">ÃœrÃ¼n bulunamadÄ±. Metni kontrol edin.</div>';return;}
  faturaAnalizSonucu={items,tarih};
  const urunSecenekleri=`<option value="-1">-- Atla --</option>`+appData.products.map((p,i)=>`<option value="${i}">${i+1}. ${p.name} (${p.birim})</option>`).join('');
  let html=`<div style="background:#f0eaf6;border-radius:8px;padding:8px 12px;margin-bottom:10px;font-size:12px;font-weight:700;color:#8e44ad">ğŸ“… Tarih: ${tarih} â€” ${items.length} Ã¼rÃ¼n algÄ±landÄ±</div><div style="border:1px solid #eee;border-radius:10px;overflow:hidden;margin-bottom:10px">`;
  items.forEach((item,i)=>{
    const autoSira=autoMapFatura(item.ad);
    html+=`<div style="padding:10px 12px;border-bottom:1px solid #f5f5f5">
      <div style="font-size:12px;font-weight:700;color:#333;margin-bottom:6px">${item.ad}</div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <input type="number" id="fmik-${i}" value="${item.miktar}" step="0.01" style="width:80px;padding:6px 8px;border:2px solid #eee;border-radius:6px;font-size:13px;font-weight:700;outline:none;text-align:center">
        <span style="font-size:11px;color:#aaa">${item.birim}</span>
        <span style="font-size:11px;color:#999">â†’</span>
        <select id="fmap-${i}" style="flex:1;min-width:160px;padding:6px 8px;border:2px solid ${autoSira>=0?'#8e44ad':'#eee'};border-radius:6px;font-size:12px;outline:none">${urunSecenekleri}</select>
      </div>
    </div>`;
    setTimeout(()=>{const s=document.getElementById(`fmap-${i}`);if(s)s.value=String(autoSira);},50);
  });
  html+=`</div><button onclick="uygulaFatura()" style="width:100%;padding:13px;background:#8e44ad;color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer">âœ… Gelen Hanesine Ekle</button>`;
  document.getElementById('fatura-sonuc').innerHTML=html;
  items.forEach((_,i)=>{const s=document.getElementById(`fmap-${i}`);const a=autoMapFatura(items[i].ad);if(s)s.value=String(a);});
}
async function uygulaFatura(){
  const{items,tarih}=faturaAnalizSonucu;
  if(!items||!items.length)return;
  let eklendi=0;
  for(let i=0;i<items.length;i++){
    const sira=parseInt(document.getElementById(`fmap-${i}`)?.value??'-1');
    if(sira<0)continue;
    const miktar=parseFloat(document.getElementById(`fmik-${i}`)?.value||'0');
    if(!miktar)continue;
    const p=appData.products[sira];
    if(!p)continue;
    const mevcutIdx=p.entries.findIndex(e=>e.tarih===tarih);
    if(mevcutIdx>=0){
      const eskiGelen=parseFloat(p.entries[mevcutIdx].gelen||'0');
      p.entries[mevcutIdx].gelen=String(Math.round((eskiGelen+miktar)*100)/100);
      if(p.entries[mevcutIdx].dbId){await sb.from('gunluk_girdiler').update({gelen:p.entries[mevcutIdx].gelen}).eq('id',p.entries[mevcutIdx].dbId);}
    }else{
      const oncekiKapanis=p.entries.length?p.entries[p.entries.length-1].kapanis||'':'';
      const newEntry={gun:String(p.entries.length+1),tarih,acilis:oncekiKapanis,gelen:String(miktar),gelenIade:'',transfer:'',kapanis:'',mallara:'',zayi:'',odenmez:''};
      p.entries.push(newEntry);
      const row={user_id:currentUser.id,urun_sira:sira,gun:String(p.entries.length),tarih,acilis:oncekiKapanis||null,gelen:String(miktar),gelen_iade:null,transfer:null,kapanis:null,mallara_gore:null,zayi:null,odenmez:null};
      const res=await sb.from('gunluk_girdiler').insert(row).select().single();
      if(res.data)p.entries[p.entries.length-1].dbId=res.data.id;
    }
    eklendi++;
  }
  toast(`âœ… ${eklendi} Ã¼rÃ¼n "Gelen" hanesine eklendi (${tarih})`,3500);
  closeFaturaModal();
  selectedMonth=tarih.slice(0,7);
  renderPage();
}
let satisAnalizSonucu={};
function openSatisModal(){document.getElementById('satis-modal').classList.add('show');document.getElementById('analiz-sonuc').innerHTML='';document.getElementById('satis-text').value='';satisAnalizSonucu={};satisRaporTarih=null;}
function closeSatisModal(){document.getElementById('satis-modal').classList.remove('show');}
function parseSatisLines(text){const items=[];let cat='';text.split('\n').forEach(line=>{if(/^\s*\*/.test(line)){cat=line.replace(/[* ]/g,'').toUpperCase();return;}const m=line.match(/^(.+?)\s{2,}(\d+)\s+([\d.,]+)/);if(m){const adet=parseInt(m[2]);const tutar=parseFloat(m[3].replace('.','').replace(',','.'));const birimFiyat=adet>0?tutar/adet:0;items.push({ad:m[1].trim().toUpperCase(),adet,kat:cat,birimFiyat});}});return items;}
function parseOzetToplam(text){let toplam=0;const lines=text.split('\n');let ozetBasladi=false;lines.forEach(line=>{if(/Ozet Urun Tip|Ã–zet ÃœrÃ¼n Tip/i.test(line)){ozetBasladi=true;return;}if(ozetBasladi){const m=line.match(/:\s*(\d+)/);if(m)toplam+=parseInt(m[1]);}});return toplam;}
function gunAdiFromTarih(tarih){if(!tarih)return '';const d=new Date(tarih);return ['Paz','Pzt','Sal','Ã‡ar','Per','Cum','Cmt'][d.getDay()]||'';}
function extractPieces(ad){const m=ad.match(/(\d+)'?[LlÄ°iuU]/);return m?parseInt(m[1]):1;}
function menuBilgi(item){const{ad,kat}=item;if(/IKILI/.test(kat)||/2 ?LI/.test(ad))return{bc:2,pat:2,kutu:2,litre:0};if(/UCLU/.test(kat))return{bc:3,pat:3,kutu:0,litre:1};if(/DORTLU/.test(kat))return{bc:4,pat:4,kutu:0,litre:2};if(/MENU/.test(kat)||/MEN[UÃœ]?$/.test(ad)||/PAKET|RAMAZAN/.test(ad))return{bc:1,pat:1,kutu:1,litre:0};return{bc:1,pat:0,kutu:0,litre:0};}
let satisRaporTarih=null;
function analizEt(){const text=document.getElementById('satis-text').value.trim();if(!text){toast('Rapor metnini yapÄ±ÅŸtÄ±rÄ±n');return;}satisRaporTarih=parseTarihFromText(text);const lines=parseSatisLines(text);if(!lines.length){document.getElementById('analiz-sonuc').innerHTML='<div style="color:#e74c3c;font-size:13px;padding:10px">ÃœrÃ¼n bulunamadÄ±.</div>';return;}const totals={};let etBurger=0,tumBurger=0,smokyBurger=0;const add=(sira,val,birim='Kg')=>{if(!totals[sira])totals[sira]={val:0,birim};totals[sira].val=r(totals[sira].val+val);totals[sira].birim=birim;};lines.forEach(item=>{const{ad,adet}=item;const mb=menuBilgi(item);const isDouble=/DOUBLE/.test(ad)&&!/2 ?LI/.test(ad);let bSira=-1,bGr=0,isTavuk=false,isMiniEkmek=false;if(/RAMAZAN CORBALI/.test(ad)){bSira=7;bGr=110;isTavuk=true;}
else if(/JUNIOR.*TAVUK|TAVUK.*JUNIOR/.test(ad)){bSira=5;bGr=65;isTavuk=true;isMiniEkmek=true;mb.pat=mb.pat||1;mb.kutu=mb.kutu||1;}
else if(/JUNIOR|MINI ET/.test(ad)){bSira=0;bGr=50;isMiniEkmek=true;mb.pat=mb.pat||1;mb.kutu=mb.kutu||1;}
else if(/LEZZET/.test(ad)){if(item.birimFiyat>220){bSira=1;bGr=85;}else{bSira=6;bGr=120;isTavuk=true;}mb.pat=mb.pat||1;mb.kutu=mb.kutu||1;}
else if(/JOKE/.test(ad)){bSira=1;bGr=85;}
else if(/SUPPER|SUPER/.test(ad)){bSira=2;bGr=120;}
else if(/TASTY|RAMAZAN/.test(ad)){bSira=3;bGr=150;}
else if(/SPECIAL|RED ZONE/.test(ad)){bSira=4;bGr=150;}
else if(/TENDERS/.test(ad)){bSira=7;bGr=110;isTavuk=true;}
else if(/MINI TAVUK/.test(ad)){bSira=5;bGr=65;isTavuk=true;}
else if(/CHICKEN|CHEDDAR/.test(ad)){bSira=6;bGr=120;isTavuk=true;}
else if(/CITIR|Ã‡ITIR/.test(ad)){add(11,adet*160/1000);return;}if(bSira>=0){const etAdet=isDouble?2:1;add(bSira,adet*mb.bc*etAdet*bGr/1000);add(isMiniEkmek?17:16,adet*mb.bc,'Adet');if(!isTavuk)etBurger+=adet*mb.bc;tumBurger+=adet*mb.bc;if(mb.pat>0)add(8,adet*mb.pat*130/1000);if(mb.kutu>0)add(18,adet*mb.kutu,'Adet');if(mb.litre>0)add(20,adet*mb.litre,'Adet');if(/SMOKY/.test(ad))smokyBurger+=adet*mb.bc;return;}if(/PATATES/.test(ad))add(8,adet*130/1000);else if(/NUGGET/.test(ad))add(9,extractPieces(ad)*adet*24/1000);else if(/SOGAN|SOÄAN|ONION/.test(ad))add(10,extractPieces(ad)*adet*14/1000);else if(/STICK/.test(ad))add(12,extractPieces(ad)*adet,'Adet');else if(/SODA/.test(ad))add(19,adet,'Adet');else if(/1 ?LT/.test(ad))add(20,adet,'Adet');else if(/SU|COLA|FUSE|ICE|AYRAN|MEYVE|SPRITE/.test(ad)&&!/SODA|1 ?LT/.test(ad))add(18,adet,'Adet');});if(etBurger>0)add(13,r(etBurger*20/1000));if(smokyBurger>0)add(14,r(smokyBurger*3*13/1000));
// Ã–zet bÃ¶lÃ¼mÃ¼nden toplam burger sayÄ±sÄ±nÄ± al, mini ekmek Ã§Ä±kar = 80gr ekmek
const ozetToplam=parseOzetToplam(text);const miniEkmekAdet=totals[17]?totals[17].val:0;if(ozetToplam>0){totals[16]={val:ozetToplam-miniEkmekAdet,birim:'Adet'};}else if(totals[16]){totals[16].val=r(totals[16].val-miniEkmekAdet);}satisAnalizSonucu=totals;const siraNamMap={};appData.products.forEach((p,idx)=>{siraNamMap[idx]=p;});const tarihLabel=satisRaporTarih?`<span style="background:#eafaf1;color:#27ae60;padding:3px 10px;border-radius:8px;font-weight:700">ğŸ“… ${satisRaporTarih}</span>`:`<span style="background:#fff3cd;color:#856404;padding:3px 10px;border-radius:8px;font-weight:700">âš ï¸ Tarih bulunamadÄ± â€” bugÃ¼n kullanÄ±lacak</span>`;let html=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap">${tarihLabel}<span style="font-size:11px;color:#999">${lines.length} satÄ±r â€¢ ${tumBurger} burger</span></div><div style="border:1px solid #eee;border-radius:10px;overflow:hidden;margin-bottom:10px">`;let hasAny=false;Object.entries(totals).forEach(([sira,{val,birim}])=>{const p=siraNamMap[parseInt(sira)];if(!p||!val)return;html+=`<div style="display:flex;align-items:center;padding:9px 12px;border-bottom:1px solid #f5f5f5;gap:10px"><span style="flex:1;font-size:13px;font-weight:600;color:#333">${p.name}</span><input type="number" id="srv-${sira}" value="${val}" step="0.001" style="width:80px;padding:6px 8px;border:2px solid #eee;border-radius:6px;text-align:center;font-size:13px;font-weight:700;outline:none" onfocus="this.style.borderColor='#e85d04'" onblur="this.style.borderColor='#eee'"><span style="font-size:11px;color:#aaa;min-width:28px">${birim}</span></div>`;hasAny=true;});html+=`</div>`;if(hasAny){html+=`<div style="font-size:11px;color:#aaa;margin-bottom:8px">DeÄŸerleri kontrol edip onaylayÄ±n â€” her Ã¼rÃ¼ne yeni giriÅŸ aÃ§Ä±lÄ±r</div><button onclick="uygulaRapor()" style="width:100%;padding:13px;background:#27ae60;color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer">âœ… Kaydet ve GiriÅŸleri OluÅŸtur</button>`;}else{html+=`<div style="text-align:center;padding:16px;color:#aaa;font-size:13px">EÅŸleÅŸen Ã¼rÃ¼n bulunamadÄ±.</div>`;}document.getElementById('analiz-sonuc').innerHTML=html;}
async function uygulaRapor(){const totals=satisAnalizSonucu;if(!Object.keys(totals).length)return;const siraNamMap={};appData.products.forEach((p,idx)=>{siraNamMap[idx]=p;});const tarih=satisRaporTarih||new Date().toISOString().slice(0,10);const gunAdi=gunAdiFromTarih(tarih)||['Paz','Pzt','Sal','Ã‡ar','Per','Cum','Cmt'][new Date().getDay()];let updated=0,created=0;for(const[sira]of Object.entries(totals)){const inputEl=document.getElementById(`srv-${sira}`);const finalVal=inputEl?parseFloat(inputEl.value):0;if(!finalVal)continue;const p=siraNamMap[parseInt(sira)];if(!p)continue;const mevcutIdx=p.entries.findIndex(e=>e.tarih===tarih);if(mevcutIdx>=0){p.entries[mevcutIdx].mallara=String(finalVal);const e=p.entries[mevcutIdx];if(e.dbId){await sb.from('gunluk_girdiler').update({mallara_gore:String(finalVal)}).eq('id',e.dbId);}updated++;}else{const oncekiKapanis=p.entries.length?p.entries[p.entries.length-1].kapanis||'':'';const newEntry={gun:String(p.entries.length+1),tarih,acilis:oncekiKapanis,gelen:'',gelenIade:'',transfer:'',kapanis:'',mallara:String(finalVal),zayi:'',odenmez:''};p.entries.push(newEntry);const row={user_id:currentUser.id,urun_sira:parseInt(sira),gun:String(p.entries.length),tarih,acilis:oncekiKapanis||null,gelen:null,gelen_iade:null,transfer:null,kapanis:null,mallara_gore:String(finalVal),zayi:null,odenmez:null};const res=await sb.from('gunluk_girdiler').insert(row).select().single();if(res.data)p.entries[p.entries.length-1].dbId=res.data.id;created++;}}toast(`âœ… ${created} yeni giriÅŸ (${tarih}), ${updated} gÃ¼ncellendi`,3500);closeSatisModal();selectedMonth=tarih.slice(0,7);renderPage();}
if('serviceWorker'in navigator&&location.protocol!=='file:'){navigator.serviceWorker.register('sw.js').catch(()=>{});}
let deferredPrompt;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;document.getElementById('install-bar').classList.add('show');});
function installApp(){if(deferredPrompt){deferredPrompt.prompt();deferredPrompt.userChoice.then(()=>{deferredPrompt=null;document.getElementById('install-bar').classList.remove('show');});}}
window.addEventListener('load',async()=>{showScreen('loading-screen');const{data:{session}}=await sb.auth.getSession();if(session){await onSignedIn(session.user);}else{showScreen('auth-screen');}sb.auth.onAuthStateChange(async(event,session)=>{if(event==='SIGNED_OUT')showScreen('auth-screen');});});
</script>
</body>
</html>
