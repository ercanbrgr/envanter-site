<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ercan BRGR - Envanter</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e85d04">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BRGR Envanter">
<link rel="apple-touch-icon" href="icon.svg">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--orange:#e85d04;--dark:#1a1a2e;--mid:#16213e;--deep:#0f3460}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Segoe UI',Arial,sans-serif;background:#f0f2f5;min-height:100vh}

/* AUTH SCREEN */
#auth-screen{
  display:flex;align-items:center;justify-content:center;
  min-height:100vh;background:linear-gradient(135deg,var(--dark) 0%,var(--deep) 100%);
  padding:20px;
}
.auth-card{
  background:#fff;border-radius:20px;padding:36px 28px;width:100%;max-width:380px;
  text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);
}
.auth-logo{font-size:44px;font-weight:900;color:var(--orange);letter-spacing:3px;margin-bottom:4px}
.auth-sub{font-size:11px;color:#aaa;margin-bottom:24px;letter-spacing:1px;text-transform:uppercase}
.auth-tabs{display:flex;gap:0;margin-bottom:20px;border:2px solid #eee;border-radius:10px;overflow:hidden}
.auth-tab{flex:1;padding:10px;font-size:13px;font-weight:700;border:none;background:#f8f8f8;cursor:pointer;color:#888;transition:all 0.2s}
.auth-tab.active{background:var(--orange);color:#fff}
.auth-field{margin-bottom:14px;text-align:left}
.auth-field label{font-size:11px;font-weight:700;color:#888;text-transform:uppercase;display:block;margin-bottom:5px}
.auth-field input{
  width:100%;padding:13px 14px;border:2px solid #eee;border-radius:10px;
  font-size:15px;outline:none;transition:border-color 0.2s;
}
.auth-field input:focus{border-color:var(--orange)}
.auth-btn{
  width:100%;padding:14px;background:var(--orange);color:#fff;
  border:none;border-radius:10px;font-size:16px;font-weight:700;
  cursor:pointer;transition:background 0.2s;margin-top:4px;
}
.auth-btn:hover{background:#c44d02}
.auth-btn:disabled{background:#ccc;cursor:not-allowed}
.auth-err{color:#e74c3c;font-size:12px;min-height:18px;margin-top:6px;text-align:center}
.auth-note{font-size:11px;color:#aaa;margin-top:12px;line-height:1.5}

/* SUBE SCREEN */
#sube-screen{
  display:none;align-items:center;justify-content:center;
  min-height:100vh;background:linear-gradient(135deg,var(--dark) 0%,var(--deep) 100%);
  padding:20px;
}
.sube-card{
  background:#fff;border-radius:20px;padding:36px 28px;width:100%;max-width:380px;
  text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);
}

/* LOADING */
#loading-screen{
  display:none;align-items:center;justify-content:center;flex-direction:column;
  min-height:100vh;background:linear-gradient(135deg,var(--dark) 0%,var(--deep) 100%);
  gap:16px;
}
.spinner{width:40px;height:40px;border:4px solid rgba(255,255,255,0.2);border-top-color:var(--orange);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{color:#fff;font-size:14px;opacity:0.7}

/* APP */
#app{display:none;min-height:100vh;flex-direction:column}

/* TOP BAR */
#topbar{
  background:var(--dark);color:#fff;padding:12px 16px;
  display:flex;align-items:center;gap:10px;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,0.3);
}
#menu-btn{background:none;border:none;color:#fff;font-size:22px;cursor:pointer;padding:4px 8px;border-radius:6px;line-height:1}
#menu-btn:hover{background:rgba(255,255,255,0.1)}
#topbar-title{flex:1;font-size:15px;font-weight:700;color:#fff;cursor:pointer;min-width:0}
#topbar-title span{display:block;font-size:10px;color:var(--orange);font-weight:400}
#topbar-birim{background:rgba(255,255,255,0.1);border:none;color:#fff;padding:6px 10px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;outline:none}
#topbar-birim option{color:var(--dark);background:#fff}
.top-btn{padding:7px 12px;border-radius:8px;border:none;cursor:pointer;font-size:12px;font-weight:700;white-space:nowrap}
.top-btn-add{background:var(--orange);color:#fff}
.top-btn-add:hover{background:#c44d02}
.top-btn-menu{background:rgba(255,255,255,0.1);color:#fff}
#topbar-user{font-size:10px;color:#ffb380;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:80px}
#sync-indicator{font-size:18px;cursor:default;transition:opacity 0.3s}

/* DRAWER */
#drawer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200}
#drawer-overlay.open{display:block}
#drawer{position:fixed;left:-280px;top:0;bottom:0;width:280px;background:var(--dark);z-index:201;transition:left 0.3s ease;display:flex;flex-direction:column;overflow:hidden}
#drawer.open{left:0}
#drawer-header{background:var(--orange);padding:20px 16px;display:flex;align-items:center;justify-content:space-between}
#drawer-header .brand{font-size:20px;font-weight:900;color:#fff;letter-spacing:2px}
#drawer-close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer}
#drawer-search{padding:12px;background:var(--mid)}
#drawer-search input{width:100%;padding:8px 12px;border-radius:8px;border:none;background:var(--deep);color:#fff;font-size:13px;outline:none}
#drawer-search input::placeholder{color:#888}
#product-list{flex:1;overflow-y:auto;padding:6px 0}
#product-list::-webkit-scrollbar{width:3px}
#product-list::-webkit-scrollbar-thumb{background:var(--orange);border-radius:3px}
.product-item{padding:12px 16px;cursor:pointer;font-size:13px;border-left:3px solid transparent;display:flex;align-items:center;gap:8px;color:#ccc;transition:all 0.15s}
.product-item:hover,.product-item.active{background:var(--deep);border-left-color:var(--orange);color:#fff}
.product-item .num{font-size:10px;color:#666;min-width:20px}
.product-item .pname{flex:1;font-size:13px}
.product-item .badge{font-size:10px;background:var(--orange);color:#fff;border-radius:10px;padding:1px 7px}
.drawer-footer{padding:12px 16px;border-top:1px solid var(--deep);display:flex;flex-direction:column;gap:8px}
.drawer-footer-info{font-size:11px;color:#666;word-break:break-all}
.drawer-btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-size:12px;font-weight:700;width:100%;text-align:center}
.drawer-btn-orange{background:var(--orange);color:#fff}
.drawer-btn-gray{background:rgba(255,255,255,0.1);color:#aaa}
.drawer-btn-red{background:#c0392b;color:#fff}

/* ADMIN BADGE */
.admin-badge{background:#f39c12;color:#fff;font-size:9px;font-weight:900;padding:2px 6px;border-radius:8px;letter-spacing:1px;text-transform:uppercase}

/* CONTENT */
#content{flex:1;padding:12px;overflow-x:hidden}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:12px}
@media(min-width:600px){.stats-row{grid-template-columns:repeat(4,1fr)}}
.stat-card{background:#fff;border-radius:12px;padding:12px 14px;border-left:4px solid var(--orange);box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.stat-card .sl{font-size:10px;color:#999;font-weight:600;text-transform:uppercase}
.stat-card .sv{font-size:22px;font-weight:800;color:var(--dark)}
.stat-card.green{border-left-color:#2ecc71}.stat-card.green .sv{color:#27ae60}
.stat-card.red{border-left-color:#e74c3c}.stat-card.red .sv{color:#e74c3c}
.stat-card.orange .sv{color:var(--orange)}

/* FORM */
.add-card{background:#fff;border-radius:12px;padding:16px;margin-bottom:12px;border-top:3px solid var(--orange);box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.add-card h3{font-size:14px;color:var(--dark);margin-bottom:14px;font-weight:700}
.form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(min-width:500px){.form-grid{grid-template-columns:repeat(3,1fr)}}
@media(min-width:768px){.form-grid{grid-template-columns:repeat(5,1fr)}}
.ff{display:flex;flex-direction:column;gap:4px}
.ff label{font-size:10px;font-weight:700;color:#999;text-transform:uppercase}
.ff input,.ff select{padding:10px;border:2px solid #eee;border-radius:8px;font-size:14px;outline:none;transition:border-color 0.15s;width:100%}
.ff input:focus{border-color:var(--orange)}
.ff input.calc{background:#f8f8f8;font-weight:700;border-color:#e0e0e0;cursor:default}
.ff input.fpos{background:#eafaf1;color:#27ae60;font-weight:800;border-color:#a9dfbf}
.ff input.fneg{background:#fdf2f2;color:#e74c3c;font-weight:800;border-color:#f5b7b1}
.form-actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.btn{padding:10px 18px;border-radius:8px;border:none;cursor:pointer;font-size:13px;font-weight:700;transition:all 0.15s}
.btn-primary{background:var(--orange);color:#fff}
.btn-primary:hover{background:#c44d02}
.btn-outline{background:transparent;border:2px solid var(--orange);color:var(--orange)}
.btn-outline:hover{background:var(--orange);color:#fff}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-danger{background:#e74c3c;color:#fff}

/* TABLE */
.table-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;font-size:12px;min-width:700px}
thead tr{background:var(--dark);color:#fff}
thead th{padding:10px 8px;text-align:center;font-size:11px;font-weight:600;white-space:nowrap;border-right:1px solid var(--deep)}
tbody tr{border-bottom:1px solid #f5f5f5;transition:background 0.1s}
tbody tr:hover{background:#fef9f5}
tbody td{padding:6px 6px;text-align:center;border-right:1px solid #f5f5f5}
tbody td input{width:100%;border:1px solid transparent;border-radius:4px;padding:5px 4px;text-align:center;font-size:12px;background:transparent;outline:none}
tbody td input:focus{border-color:var(--orange);background:#fff8f2}
td.calc{background:#f8f8f8;font-weight:700}
td.fp{background:#eafaf1;color:#27ae60;font-weight:800}
td.fn{background:#fdf2f2;color:#e74c3c;font-weight:800}
td.fz{background:#f5f5f5;color:#999;font-weight:700}
.del-btn{background:none;border:none;cursor:pointer;color:#ddd;font-size:13px;padding:3px 7px;border-radius:4px}
.del-btn:hover{color:#e74c3c;background:#fdf2f2}

/* EMPTY */
.empty{text-align:center;padding:48px 20px;color:#bbb}
.empty .ico{font-size:48px;margin-bottom:12px}
.empty p{font-size:14px}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:300;align-items:center;justify-content:center;padding:20px}
.overlay.show{display:flex}
.modal{background:#fff;border-radius:16px;padding:24px;width:100%;max-width:340px;box-shadow:0 10px 40px rgba(0,0,0,0.2)}
.modal h3{font-size:16px;margin-bottom:16px;color:var(--dark)}
.modal input{width:100%;padding:12px;border:2px solid #eee;border-radius:8px;font-size:15px;outline:none;margin-bottom:14px}
.modal input:focus{border-color:var(--orange)}
.modal-actions{display:flex;gap:8px;justify-content:flex-end}

/* ADMIN PANEL */
.admin-panel{background:#fff;border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.admin-panel h2{font-size:16px;color:var(--dark);margin-bottom:14px;font-weight:800;display:flex;align-items:center;gap:8px}
.sube-card-admin{border:1px solid #eee;border-radius:10px;padding:14px;margin-bottom:10px;cursor:pointer;transition:border-color 0.2s}
.sube-card-admin:hover{border-color:var(--orange)}
.sube-card-admin h3{font-size:14px;font-weight:700;color:var(--dark);margin-bottom:4px}
.sube-card-admin .sube-email{font-size:11px;color:#aaa;margin-bottom:8px}
.sube-stats{display:flex;gap:8px;flex-wrap:wrap}
.sube-stat{background:#f8f8f8;border-radius:6px;padding:6px 10px;font-size:11px;font-weight:700;color:#555}
.sube-stat.s-green{background:#eafaf1;color:#27ae60}
.sube-stat.s-red{background:#fdf2f2;color:#e74c3c}

/* BOTTOM NAV */
#bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #eee;padding:8px 16px;box-shadow:0 -2px 10px rgba(0,0,0,0.08);z-index:100}
@media(max-width:599px){#bottom-nav{display:flex;gap:8px;justify-content:center}}
#content{padding-bottom:80px}
@media(min-width:600px){#content{padding-bottom:12px}}

/* INSTALL BAR */
#install-bar{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--orange);color:#fff;padding:12px 16px;align-items:center;justify-content:space-between;z-index:500;font-size:13px;box-shadow:0 -2px 10px rgba(0,0,0,0.2)}
#install-bar.show{display:flex}

/* TOAST */
#toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:rgba(30,30,30,0.95);color:#fff;padding:10px 20px;border-radius:20px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:opacity 0.3s;pointer-events:none;white-space:nowrap}
#toast.show{opacity:1}

@media print{
  #auth-screen,#sube-screen,#loading-screen,#topbar,#drawer,#drawer-overlay,#bottom-nav,#install-bar,.add-card,.del-btn,.top-btn{display:none!important}
  .stats-row{display:none}
  #app{display:block!important}
  .table-card{box-shadow:none}
}
</style>
</head>
<body>

<!-- ===== AUTH SCREEN ===== -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">BRGR</div>
    <div class="auth-sub">Ercan BRGR Envanter</div>

    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-giris" onclick="switchTab('giris')">Giri≈ü Yap</button>
      <button class="auth-tab" id="tab-kayit" onclick="switchTab('kayit')">Kayƒ±t Ol</button>
    </div>

    <div id="form-giris">
      <div class="auth-field">
        <label>E-posta</label>
        <input type="email" id="giris-email" placeholder="ornek@mail.com" autocomplete="email" inputmode="email">
      </div>
      <div class="auth-field">
        <label>≈ûifre</label>
        <input type="password" id="giris-sifre" placeholder="≈ûifreniz" autocomplete="current-password" onkeydown="if(event.key==='Enter')doGiris()">
      </div>
      <div class="auth-err" id="giris-err"></div>
      <button class="auth-btn" id="giris-btn" onclick="doGiris()">Giri≈ü Yap</button>
      <div class="auth-note">Verileriniz buluta kaydedilir. Telefon deƒüi≈ütirseniz bile verileriniz g√ºvende.</div>
    </div>

    <div id="form-kayit" style="display:none">
      <div class="auth-field">
        <label>E-posta</label>
        <input type="email" id="kayit-email" placeholder="ornek@mail.com" autocomplete="email" inputmode="email">
      </div>
      <div class="auth-field">
        <label>≈ûifre (en az 6 karakter)</label>
        <input type="password" id="kayit-sifre" placeholder="≈ûifre belirleyin" autocomplete="new-password">
      </div>
      <div class="auth-field">
        <label>≈ûifre Tekrar</label>
        <input type="password" id="kayit-sifre2" placeholder="≈ûifreyi tekrar girin" autocomplete="new-password" onkeydown="if(event.key==='Enter')doKayit()">
      </div>
      <div class="auth-err" id="kayit-err"></div>
      <button class="auth-btn" id="kayit-btn" onclick="doKayit()">Kayƒ±t Ol</button>
      <div class="auth-note">Her ≈üube kendi mail adresi ile kaydolur. Siler ve yeniden y√ºklese bile verileri kaybolmaz.</div>
    </div>
  </div>
</div>

<!-- ===== ≈ûUBE KURULUM ===== -->
<div id="sube-screen">
  <div class="sube-card">
    <div class="auth-logo">BRGR</div>
    <div class="auth-sub">Ercan BRGR Envanter</div>
    <div style="font-size:16px;font-weight:700;color:#333;margin-bottom:20px">≈ûubenizi Olu≈üturun</div>
    <div class="auth-field" style="text-align:left">
      <label>≈ûube Adƒ±</label>
      <input type="text" id="sube-input" placeholder="√ñrn: Kadƒ±k√∂y ≈ûubesi" style="padding:13px 14px;border:2px solid #eee;border-radius:10px;font-size:15px;outline:none;width:100%;transition:border-color 0.2s" onfocus="this.style.borderColor='#e85d04'" onblur="this.style.borderColor='#eee'" onkeydown="if(event.key==='Enter')saveSube()">
      <div style="font-size:11px;color:#aaa;margin-top:6px">Bu isim uygulamanƒ±n √ºst kƒ±smƒ±nda g√∂r√ºn√ºr</div>
    </div>
    <div class="auth-err" id="sube-err"></div>
    <button onclick="saveSube()" style="width:100%;padding:14px;background:#e85d04;color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;margin-top:8px">Ba≈üla ‚Üí</button>
  </div>
</div>

<!-- ===== LOADING ===== -->
<div id="loading-screen">
  <div class="spinner"></div>
  <div class="loading-text">Y√ºkleniyor...</div>
</div>

<!-- ===== APP ===== -->
<div id="app">

  <div id="topbar">
    <button id="menu-btn" onclick="toggleDrawer()">&#9776;</button>
    <div id="topbar-title" onclick="openRenameModal()">
      <span id="product-name-display">√úr√ºn Se√ßin</span>
      <span id="topbar-sub" style="font-size:10px;color:#ffb380">Ada tƒ±klayarak deƒüi≈ütir</span>
    </div>
    <div id="topbar-user" title="Oturum bilgisi"></div>
    <span id="sync-indicator" title="Senkronizasyon durumu">‚òÅÔ∏è</span>
    <select id="topbar-birim" onchange="saveBirim()" title="Birim">
      <option value="Adet">Adet</option>
      <option value="Kg">Kg</option>
      <option value="Lt">Lt</option>
      <option value="Paket">Paket</option>
      <option value="Kutu">Kutu</option>
    </select>
    <button class="top-btn top-btn-add" onclick="toggleAddForm()">+ Ekle</button>
    <button class="top-btn top-btn-menu" onclick="window.print()" title="Yazdƒ±r">üñ®</button>
  </div>

  <div id="drawer-overlay" onclick="closeDrawer()"></div>

  <div id="drawer">
    <div id="drawer-header">
      <div class="brand">BRGR ENVANTERƒ∞</div>
      <button id="drawer-close" onclick="closeDrawer()">&#10005;</button>
    </div>
    <div id="drawer-search">
      <input type="text" id="search-input" placeholder="√úr√ºn ara..." oninput="filterProducts()">
    </div>
    <div id="product-list"></div>
    <div class="drawer-footer">
      <div class="drawer-footer-info" id="drawer-user-info"></div>
      <div class="drawer-footer-info" id="drawer-sube-info" style="color:var(--orange);font-weight:700"></div>
      <button class="drawer-btn drawer-btn-orange" onclick="openSubeModal()">≈ûube Adƒ±nƒ± Deƒüi≈ütir</button>
      <button class="drawer-btn drawer-btn-gray" onclick="exportData()">CSV ƒ∞ndir</button>
      <button class="drawer-btn drawer-btn-red" onclick="doSignOut()">√áƒ±kƒ±≈ü Yap</button>
    </div>
  </div>

  <div id="content">
    <div id="page-content"></div>
  </div>

  <div id="bottom-nav">
    <button class="btn btn-primary" style="flex:1" onclick="toggleAddForm()">+ G√ºn Ekle</button>
    <button class="btn btn-outline" onclick="exportData()">CSV</button>
    <button class="btn" style="background:#f0f0f0;color:#333" onclick="window.print()">Yazdƒ±r</button>
  </div>
</div>

<!-- RENAME MODAL -->
<div class="overlay" id="rename-modal">
  <div class="modal">
    <h3>√úr√ºn Adƒ±nƒ± Deƒüi≈ütir</h3>
    <input type="text" id="rename-input" placeholder="Yeni √ºr√ºn adƒ±">
    <div class="modal-actions">
      <button class="btn btn-outline btn-sm" onclick="closeRenameModal()">ƒ∞ptal</button>
      <button class="btn btn-primary btn-sm" onclick="confirmRename()">Kaydet</button>
    </div>
  </div>
</div>

<!-- INSTALL BAR -->
<div id="install-bar">
  <span>Bu uygulamayƒ± telefona y√ºkleyin!</span>
  <div style="display:flex;gap:8px">
    <button onclick="installApp()" style="background:#fff;color:var(--orange);border:none;padding:8px 14px;border-radius:6px;font-weight:700;cursor:pointer">Y√ºkle</button>
    <button onclick="document.getElementById('install-bar').classList.remove('show')" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.5);padding:8px 10px;border-radius:6px;cursor:pointer">‚úï</button>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// ============================================================
// SUPABASE BA≈ûLATMA
// ============================================================
const SUPA_URL = 'https://gqhfxpczgxksbfybfesz.supabase.co';
const SUPA_KEY = 'sb_publishable_0L6Pcm4GYzaEyIQ8Dup-6A_LqT-Z-FS';
const ADMIN_EMAIL = 'brgrercan@gmail.com';
const { createClient } = supabase;
const sb = createClient(SUPA_URL, SUPA_KEY);

// ============================================================
// DURUM
// ============================================================
let currentUser = null;
let isAdmin = false;
let appData = { products: [] };
let currentProduct = 0;
let showAddForm = false;
let syncTimeout = null;

const DEFAULT_PRODUCTS = [
  {name:'Mini Et Burger',birim:'Kg'},{name:'Joker Burger',birim:'Kg'},
  {name:'Super Burger',birim:'Kg'},{name:'Tasty Burger',birim:'Kg'},
  {name:'Special',birim:'Kg'},{name:'Mini Tavuk',birim:'Kg'},
  {name:'Tavuk Burger',birim:'Kg'},{name:'Tenders',birim:'Kg'},
  {name:'Patates',birim:'Kg'},{name:'Nugget',birim:'Kg'},
  {name:'Soƒüan Halkasƒ±',birim:'Kg'},{name:'√áƒ±tƒ±r Tavuk',birim:'Kg'},
  {name:'Stick Peynir',birim:'Adet'},{name:'Karamelize Soƒüan',birim:'Kg'},
  {name:'F√ºme',birim:'Kg'},{name:'Kƒ±zartma Yaƒüƒ±',birim:'Lt'},
  {name:'80 gr Ekmek',birim:'Adet'},{name:'Mini Ekmek',birim:'Adet'},
  {name:'Kutu ƒ∞√ßecekler',birim:'Adet'},{name:'Soda Grubu',birim:'Adet'},
  {name:'1 Litrelik ƒ∞√ßecekler',birim:'Adet'},{name:'√úr√ºn 22',birim:'Adet'},
  {name:'√úr√ºn 23',birim:'Adet'},{name:'√úr√ºn 24',birim:'Adet'},
  {name:'√úr√ºn 25',birim:'Adet'}
];

// ============================================================
// TOAST
// ============================================================
function toast(msg, dur=2500) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), dur);
}

// ============================================================
// AUTH UI
// ============================================================
function switchTab(tab) {
  document.getElementById('tab-giris').classList.toggle('active', tab==='giris');
  document.getElementById('tab-kayit').classList.toggle('active', tab==='kayit');
  document.getElementById('form-giris').style.display = tab==='giris' ? '' : 'none';
  document.getElementById('form-kayit').style.display = tab==='kayit' ? '' : 'none';
}

async function doGiris() {
  const email = document.getElementById('giris-email').value.trim();
  const pass = document.getElementById('giris-sifre').value;
  const errEl = document.getElementById('giris-err');
  const btn = document.getElementById('giris-btn');
  if (!email || !pass) { errEl.textContent='E-posta ve ≈üifre girin'; return; }
  btn.disabled = true; btn.textContent = 'Giri≈ü yapƒ±lƒ±yor...';
  errEl.textContent = '';
  const {data, error} = await sb.auth.signInWithPassword({email, password:pass});
  btn.disabled = false; btn.textContent = 'Giri≈ü Yap';
  if (error) {
    let msg = 'Giri≈ü ba≈üarƒ±sƒ±z';
    if (error.message.includes('Invalid login')) msg = 'E-posta veya ≈üifre hatalƒ±';
    else if (error.message.includes('Email not confirmed')) msg = 'E-postanƒ±zƒ± onaylayƒ±n';
    errEl.textContent = msg;
    return;
  }
  await onSignedIn(data.user);
}

async function doKayit() {
  const email = document.getElementById('kayit-email').value.trim();
  const pass = document.getElementById('kayit-sifre').value;
  const pass2 = document.getElementById('kayit-sifre2').value;
  const errEl = document.getElementById('kayit-err');
  const btn = document.getElementById('kayit-btn');
  if (!email || !pass) { errEl.textContent='E-posta ve ≈üifre girin'; return; }
  if (pass.length < 6) { errEl.textContent='≈ûifre en az 6 karakter olmalƒ±'; return; }
  if (pass !== pass2) { errEl.textContent='≈ûifreler e≈üle≈ümiyor'; return; }
  btn.disabled = true; btn.textContent = 'Kayƒ±t olunuyor...';
  errEl.textContent = '';
  const {data, error} = await sb.auth.signUp({email, password:pass});
  btn.disabled = false; btn.textContent = 'Kayƒ±t Ol';
  if (error) {
    let msg = 'Kayƒ±t ba≈üarƒ±sƒ±z';
    if (error.message.includes('already registered')) msg = 'Bu e-posta zaten kayƒ±tlƒ±, giri≈ü yapƒ±n';
    else if (error.message.includes('invalid')) msg = 'Ge√ßerli bir e-posta girin';
    errEl.textContent = msg;
    return;
  }
  if (data.user && !data.session) {
    errEl.style.color = '#27ae60';
    errEl.textContent = 'Onay e-postasƒ± g√∂nderildi! Gelen kutunuzu kontrol edin.';
    return;
  }
  await onSignedIn(data.user);
}

async function doSignOut() {
  if (!confirm('√áƒ±kƒ±≈ü yapmak istediƒüinize emin misiniz?')) return;
  await sb.auth.signOut();
  currentUser = null; isAdmin = false;
  appData = {products:[]};
  showScreen('auth-screen');
}

// ============================================================
// EKRAN Y√ñNETƒ∞Mƒ∞
// ============================================================
function showScreen(id) {
  ['auth-screen','sube-screen','loading-screen','app'].forEach(s => {
    const el = document.getElementById(s);
    if (s === 'app') {
      el.style.display = s===id ? 'flex' : 'none';
      if (s===id) el.style.flexDirection = 'column';
    } else {
      el.style.display = s===id ? 'flex' : 'none';
    }
  });
}

// ============================================================
// OTURUM A√áILDI
// ============================================================
async function onSignedIn(user) {
  currentUser = user;
  isAdmin = (user.email === ADMIN_EMAIL);
  showScreen('loading-screen');

  const profil = await loadProfil();
  if (!profil) {
    showScreen('sube-screen');
    setTimeout(() => document.getElementById('sube-input').focus(), 300);
    return;
  }

  await loadAllData();
  openApp();
}

// ============================================================
// ≈ûUBE PROFƒ∞Lƒ∞
// ============================================================
async function loadProfil() {
  const {data} = await sb.from('sube_profiller').select('*').eq('user_id', currentUser.id).single();
  return data;
}

async function saveSube() {
  const sube = document.getElementById('sube-input').value.trim();
  if (!sube) { document.getElementById('sube-err').textContent='≈ûube adƒ± girin'; return; }
  document.getElementById('sube-err').textContent = '';
  const {error} = await sb.from('sube_profiller').upsert({user_id:currentUser.id, sube_adi:sube});
  if (error) { document.getElementById('sube-err').textContent='Kaydedilemedi: '+error.message; return; }
  await initDefaultProducts();
  await loadAllData();
  openApp();
}

async function openSubeModal() {
  const profil = await loadProfil();
  const yeni = prompt('Yeni ≈üube adƒ±:', profil?.sube_adi || '');
  if (yeni && yeni.trim()) {
    await sb.from('sube_profiller').upsert({user_id:currentUser.id, sube_adi:yeni.trim()});
    document.getElementById('topbar-user').textContent = yeni.trim();
    document.getElementById('drawer-sube-info').textContent = yeni.trim();
    toast('≈ûube adƒ± g√ºncellendi');
  }
}

// ============================================================
// VERƒ∞ Y√úKLEME
// ============================================================
async function loadAllData() {
  const {data:urunler} = await sb.from('urunler')
    .select('*').eq('user_id', currentUser.id).order('sira');

  const {data:girdiler} = await sb.from('gunluk_girdiler')
    .select('*').eq('user_id', currentUser.id).order('tarih', {ascending:true});

  appData.products = (urunler || []).map(u => ({
    id: u.id,
    sira: u.sira,
    name: u.ad,
    birim: u.birim || 'Adet',
    koli: u.koli || '',
    adet: u.adet_koli || '',
    entries: (girdiler || [])
      .filter(g => g.urun_sira === u.sira)
      .map(g => ({
        dbId: g.id,
        gun: g.gun || '',
        tarih: g.tarih || '',
        acilis: g.acilis || '',
        gelen: g.gelen || '',
        gelenIade: g.gelen_iade || '',
        transfer: g.transfer || '',
        kapanis: g.kapanis || '',
        mallara: g.mallara_gore || '',
        zayi: g.zayi || '',
        odenmez: g.odenmez || ''
      }))
  }));
}

async function initDefaultProducts() {
  const inserts = DEFAULT_PRODUCTS.map((p,i) => ({
    user_id: currentUser.id,
    sira: i,
    ad: p.name,
    birim: p.birim,
    koli: '',
    adet_koli: ''
  }));
  await sb.from('urunler').upsert(inserts, {onConflict:'user_id,sira'});
}

// ============================================================
// APP A√áILI≈û
// ============================================================
async function openApp() {
  showScreen('app');
  const profil = await loadProfil();
  const subeAdi = profil?.sube_adi || currentUser.email;
  document.getElementById('topbar-user').textContent = subeAdi;
  document.getElementById('drawer-user-info').textContent = currentUser.email;
  document.getElementById('drawer-sube-info').textContent = subeAdi;
  setSyncIcon('ok');
  if (isAdmin) {
    document.getElementById('topbar-user').innerHTML = subeAdi + ' <span class="admin-badge">ADMƒ∞N</span>';
  }
  renderSidebar();
  if (isAdmin) renderAdminPanel(); else renderPage();
}

// ============================================================
// SYNC G√ñSTERGESI
// ============================================================
function setSyncIcon(state) {
  const el = document.getElementById('sync-indicator');
  if (state==='ok') el.textContent='‚òÅÔ∏è';
  else if (state==='saving') el.textContent='üîÑ';
  else if (state==='err') el.textContent='‚ö†Ô∏è';
}

// ============================================================
// DRAWER
// ============================================================
function toggleDrawer() {
  document.getElementById('drawer').classList.toggle('open');
  document.getElementById('drawer-overlay').classList.toggle('open');
}
function closeDrawer() {
  document.getElementById('drawer').classList.remove('open');
  document.getElementById('drawer-overlay').classList.remove('open');
}

function renderSidebar(filter='') {
  const list = document.getElementById('product-list');
  list.innerHTML = '';
  if (isAdmin) {
    const div = document.createElement('div');
    div.className = 'product-item' + (currentProduct===-1?' active':'');
    div.innerHTML = '<span class="num">‚≠ê</span><span class="pname">Admin Paneli</span>';
    div.onclick = () => { currentProduct=-1; showAddForm=false; renderAdminPanel(); closeDrawer(); };
    list.appendChild(div);
  }
  appData.products.forEach((p,i) => {
    if (filter && !p.name.toLowerCase().includes(filter.toLowerCase())) return;
    const div = document.createElement('div');
    div.className = 'product-item' + (i===currentProduct?' active':'');
    div.innerHTML = `<span class="num">${i+1}</span><span class="pname">${p.name}</span>${p.entries.length?`<span class="badge">${p.entries.length}</span>`:''}`;
    div.onclick = () => { currentProduct=i; showAddForm=false; renderSidebar(document.getElementById('search-input').value); renderPage(); closeDrawer(); };
    list.appendChild(div);
  });
}
function filterProducts() { renderSidebar(document.getElementById('search-input').value); }

// ============================================================
// HESAP
// ============================================================
function n(v){ return parseFloat(String(v).replace(',','.')) || 0; }
function r(v){ return Math.round(v*100)/100; }
function calcEntry(e) {
  const a=n(e.acilis),g=n(e.gelen),gi=n(e.gelenIade),
        t=n(e.transfer),k=n(e.kapanis),
        m=n(e.mallara),z=n(e.zayi),o=n(e.odenmez);
  const sayima = r(a+g-gi-t-k);
  return { sayima, fark: r(m-sayima+z+o) };
}

function getStats(entries) {
  if (!entries.length) return { last:'-', totalFark:0, posCount:0, negCount:0 };
  let totalFark=0, posCount=0, negCount=0;
  entries.forEach(e => {
    const {fark}=calcEntry(e);
    totalFark+=fark;
    if(fark>0)posCount++; else if(fark<0)negCount++;
  });
  const last=entries[entries.length-1];
  return { last:last.kapanis!==''?last.kapanis:'-', totalFark:r(totalFark), posCount, negCount };
}

// ============================================================
// RENDER PAGE
// ============================================================
function renderPage() {
  if (!appData.products.length) {
    document.getElementById('page-content').innerHTML = '<div class="empty"><div class="ico">‚è≥</div><p>Veriler y√ºkleniyor...</p></div>';
    return;
  }
  const p = appData.products[currentProduct];
  if (!p) return;
  const birim = p.birim || 'Adet';
  document.getElementById('product-name-display').textContent = p.name;
  document.getElementById('topbar-sub').textContent = `${birim} ‚Ä¢ Ada tƒ±kla deƒüi≈ütir`;
  const birimEl = document.getElementById('topbar-birim');
  if (birimEl) birimEl.value = birim;

  const stats = getStats(p.entries);
  const fc = stats.totalFark>0?'green':stats.totalFark<0?'red':'';
  let html = '';

  if (showAddForm) {
    const last = p.entries.length ? p.entries[p.entries.length-1] : null;
    const nextAcilis = last && last.kapanis!=='' ? last.kapanis : '';
    html += `<div class="add-card" id="add-form">
      <h3>Yeni G√ºn Ekle</h3>
      <div class="form-grid">
        <div class="ff"><label>G√ºn</label><input type="number" id="f-gun" value="${p.entries.length+1}" inputmode="numeric"></div>
        <div class="ff"><label>Tarih</label><input type="date" id="f-tarih" value="${new Date().toISOString().split('T')[0]}"></div>
        <div class="ff"><label>A√ßƒ±lƒ±≈ü (${birim})</label><input type="number" id="f-acilis" value="${nextAcilis}" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div>
        <div class="ff"><label>Gelen (${birim})</label><input type="number" id="f-gelen" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div>
        <div class="ff"><label>Gelen ƒ∞ade</label><input type="number" id="f-gelenIade" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div>
        <div class="ff"><label>Transfer</label><input type="number" id="f-transfer" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div>
        <div class="ff"><label>Kapanƒ±≈ü (${birim})</label><input type="number" id="f-kapanis" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div>
        <div class="ff"><label>Sayƒ±ma G√∂re Kullanƒ±lan</label><input type="number" id="f-sayima" class="calc" readonly placeholder="Otomatik"></div>
        <div class="ff"><label>Mallara G√∂re Satƒ±lan</label><input type="number" id="f-mallara" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div>
        <div class="ff"><label>Zayi</label><input type="number" id="f-zayi" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div>
        <div class="ff"><label>√ñdenmez</label><input type="number" id="f-odenmez" oninput="liveCalc()" step="0.01" placeholder="0" inputmode="decimal"></div>
        <div class="ff"><label>FARK +/-</label><input type="number" id="f-fark" class="calc" readonly placeholder="Otomatik"></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="addEntry()">Kaydet</button>
        <button class="btn btn-outline" onclick="toggleAddForm()">ƒ∞ptal</button>
      </div>
    </div>`;
  }

  html += `<div class="stats-row">
    <div class="stat-card"><div class="sl">Son Kapanƒ±≈ü</div><div class="sv">${stats.last}</div></div>
    <div class="stat-card orange"><div class="sl">Toplam G√ºn</div><div class="sv">${p.entries.length}</div></div>
    <div class="stat-card ${fc}"><div class="sl">Toplam Fark</div><div class="sv">${stats.totalFark>0?'+':''}${stats.totalFark}</div></div>
    <div class="stat-card"><div class="sl">+ / - G√ºn</div><div class="sv" style="font-size:16px"><span style="color:#27ae60">+${stats.posCount}</span> / <span style="color:#e74c3c">${stats.negCount}</span></div></div>
  </div>`;

  if (!p.entries.length) {
    html += `<div class="empty"><div class="ico">üìã</div><p>Hen√ºz giri≈ü yok.<br><strong>+ Ekle</strong> butonuna basƒ±n.</p></div>`;
  } else {
    html += `<div class="table-card"><div class="table-scroll"><table>
      <thead><tr>
        <th>#</th><th>G√ºn</th><th>Tarih</th>
        <th>A√ßƒ±lƒ±≈ü<br>(${birim})</th><th>Gelen<br>(${birim})</th>
        <th>G.ƒ∞ade</th><th>Transfer</th>
        <th>Kapanƒ±≈ü<br>(${birim})</th>
        <th>Sayƒ±ma G√∂re<br>Kullanƒ±lan</th>
        <th>Mallara G√∂re<br>Satƒ±lan</th>
        <th>Zayi</th><th>√ñdenmez</th>
        <th>FARK +/-</th>
      </tr></thead><tbody>`;
    p.entries.forEach((e,idx) => {
      const {sayima,fark}=calcEntry(e);
      const fc2=fark>0?'fp':fark<0?'fn':'fz';
      const hasData=e.acilis!==''||e.kapanis!=='';
      html+=`<tr>
        <td><button class="del-btn" onclick="deleteEntry(${idx})">‚úï</button></td>
        <td><input type="number" value="${e.gun||''}" onchange="updateEntry(${idx},'gun',this.value)" inputmode="numeric"></td>
        <td><input type="date" value="${e.tarih||''}" onchange="updateEntry(${idx},'tarih',this.value)" style="width:130px"></td>
        <td><input type="number" value="${e.acilis||''}" onchange="updateEntry(${idx},'acilis',this.value)" step="0.01" inputmode="decimal"></td>
        <td><input type="number" value="${e.gelen||''}" onchange="updateEntry(${idx},'gelen',this.value)" step="0.01" inputmode="decimal"></td>
        <td><input type="number" value="${e.gelenIade||''}" onchange="updateEntry(${idx},'gelenIade',this.value)" step="0.01" inputmode="decimal"></td>
        <td><input type="number" value="${e.transfer||''}" onchange="updateEntry(${idx},'transfer',this.value)" step="0.01" inputmode="decimal"></td>
        <td><input type="number" value="${e.kapanis||''}" onchange="updateEntry(${idx},'kapanis',this.value)" step="0.01" inputmode="decimal"></td>
        <td class="calc">${hasData?sayima:''}</td>
        <td><input type="number" value="${e.mallara||''}" onchange="updateEntry(${idx},'mallara',this.value)" step="0.01" inputmode="decimal"></td>
        <td><input type="number" value="${e.zayi||''}" onchange="updateEntry(${idx},'zayi',this.value)" step="0.01" inputmode="decimal"></td>
        <td><input type="number" value="${e.odenmez||''}" onchange="updateEntry(${idx},'odenmez',this.value)" step="0.01" inputmode="decimal"></td>
        <td class="${fc2}">${hasData?(fark>0?'+':'')+fark:''}</td>
      </tr>`;
    });
    html+=`</tbody></table></div></div>`;
  }

  document.getElementById('page-content').innerHTML = html;
}

// ============================================================
// LIVE CALC
// ============================================================
function liveCalc() {
  const g=id=>n(document.getElementById(id)?.value);
  const sayima=r(g('f-acilis')+g('f-gelen')-g('f-gelenIade')-g('f-transfer')-g('f-kapanis'));
  const fark=r(g('f-mallara')-sayima+g('f-zayi')+g('f-odenmez'));
  const se=document.getElementById('f-sayima'), fe=document.getElementById('f-fark');
  if(se) se.value=sayima;
  if(fe){ fe.value=(fark>0?'+':'')+fark; fe.className='calc '+(fark>0?'fpos':fark<0?'fneg':''); }
}

// ============================================================
// KAYDETME ‚Äî SUPABASE
// ============================================================
function scheduleSave(idx) {
  setSyncIcon('saving');
  clearTimeout(syncTimeout);
  syncTimeout = setTimeout(() => syncEntry(idx), 800);
}

async function syncEntry(idx) {
  const p = appData.products[currentProduct];
  const e = p.entries[idx];
  const row = {
    user_id: currentUser.id,
    urun_sira: p.sira,
    gun: e.gun || '',
    tarih: e.tarih || null,
    acilis: e.acilis || '',
    gelen: e.gelen || '',
    gelen_iade: e.gelenIade || '',
    transfer: e.transfer || '',
    kapanis: e.kapanis || '',
    mallara_gore: e.mallara || '',
    zayi: e.zayi || '',
    odenmez: e.odenmez || ''
  };
  let res;
  if (e.dbId) {
    res = await sb.from('gunluk_girdiler').update(row).eq('id', e.dbId);
  } else {
    res = await sb.from('gunluk_girdiler').insert(row).select().single();
    if (res.data) e.dbId = res.data.id;
  }
  if (res.error) { setSyncIcon('err'); toast('Kayƒ±t hatasƒ±: ' + res.error.message, 4000); }
  else { setSyncIcon('ok'); }
}

async function syncBirim(sira, birim) {
  await sb.from('urunler').update({birim}).eq('user_id', currentUser.id).eq('sira', sira);
}

async function syncProductName(sira, ad) {
  await sb.from('urunler').update({ad}).eq('user_id', currentUser.id).eq('sira', sira);
}

// ============================================================
// FORM KAYDET
// ============================================================
function toggleAddForm() {
  showAddForm=!showAddForm; renderPage();
  if(showAddForm){setTimeout(()=>{const el=document.getElementById('add-form');if(el)el.scrollIntoView({behavior:'smooth'})},50);}
}

async function addEntry() {
  const v=x=>document.getElementById(x)?.value||'';
  const p = appData.products[currentProduct];
  const entry = {
    gun:v('f-gun'),tarih:v('f-tarih'),acilis:v('f-acilis'),gelen:v('f-gelen'),
    gelenIade:v('f-gelenIade'),transfer:v('f-transfer'),kapanis:v('f-kapanis'),
    mallara:v('f-mallara'),zayi:v('f-zayi'),odenmez:v('f-odenmez')
  };
  p.entries.push(entry);
  showAddForm=false;
  renderSidebar(document.getElementById('search-input').value);
  renderPage();
  await syncEntry(p.entries.length-1);
  toast('Kaydedildi ‚òÅÔ∏è');
}

async function updateEntry(idx, field, val) {
  appData.products[currentProduct].entries[idx][field] = val;
  renderPage();
  scheduleSave(idx);
}

async function deleteEntry(idx) {
  if(!confirm('Bu giri≈üi silmek istediƒüinize emin misiniz?')) return;
  const p = appData.products[currentProduct];
  const e = p.entries[idx];
  if (e.dbId) {
    const {error} = await sb.from('gunluk_girdiler').delete().eq('id', e.dbId);
    if (error) { toast('Silme hatasƒ±'); return; }
  }
  p.entries.splice(idx,1);
  renderSidebar(document.getElementById('search-input').value);
  renderPage();
  toast('Silindi');
}

// ============================================================
// Bƒ∞Rƒ∞M & ƒ∞Sƒ∞M
// ============================================================
async function saveBirim() {
  const p = appData.products[currentProduct];
  p.birim = document.getElementById('topbar-birim').value;
  renderPage();
  await syncBirim(p.sira, p.birim);
}

function openRenameModal() {
  document.getElementById('rename-input').value = appData.products[currentProduct].name;
  document.getElementById('rename-modal').classList.add('show');
  setTimeout(() => document.getElementById('rename-input').focus(), 100);
}
function closeRenameModal() { document.getElementById('rename-modal').classList.remove('show'); }
async function confirmRename() {
  const v = document.getElementById('rename-input').value.trim();
  if (v) {
    const p = appData.products[currentProduct];
    p.name = v;
    renderSidebar(); renderPage();
    await syncProductName(p.sira, v);
    toast('√úr√ºn adƒ± g√ºncellendi');
  }
  closeRenameModal();
}
document.getElementById('rename-input').addEventListener('keydown', e => {
  if(e.key==='Enter') confirmRename();
  if(e.key==='Escape') closeRenameModal();
});

// ============================================================
// EXPORT CSV
// ============================================================
function exportData() {
  const p = appData.products[currentProduct];
  if (!p) return;
  let csv = 'G√ºn,Tarih,A√ßƒ±lƒ±≈ü,Gelen,Gelen ƒ∞ade,Transfer,Kapanƒ±≈ü,Sayƒ±ma G√∂re Kullanƒ±lan,Mallara G√∂re Satƒ±lan,Zayi,√ñdenmez,FARK+/-\n';
  p.entries.forEach(e => {
    const {sayima,fark}=calcEntry(e);
    csv+=[e.gun,e.tarih,e.acilis,e.gelen,e.gelenIade,e.transfer,e.kapanis,sayima,e.mallara,e.zayi,e.odenmez,fark].join(',')+'\n';
  });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}));
  a.download = p.name.replace(/\s+/g,'_')+'_envanter.csv'; a.click();
}

// ============================================================
// ADMIN PANELƒ∞
// ============================================================
async function renderAdminPanel() {
  currentProduct = -1;
  document.getElementById('product-name-display').textContent = 'Admin Paneli';
  document.getElementById('topbar-sub').textContent = 'T√ºm ≈üubeler';

  document.getElementById('page-content').innerHTML = '<div class="empty"><div class="ico">‚è≥</div><p>≈ûubeler y√ºkleniyor...</p></div>';

  const {data:profiller, error} = await sb.from('sube_profiller').select('*');
  if (error) {
    document.getElementById('page-content').innerHTML = '<div class="empty"><p>Veri y√ºklenemedi: '+error.message+'</p></div>';
    return;
  }

  if (!profiller || !profiller.length) {
    document.getElementById('page-content').innerHTML = '<div class="empty"><div class="ico">üè™</div><p>Hen√ºz kayƒ±tlƒ± ≈üube yok.</p></div>';
    return;
  }

  const {data:tumGirdiler} = await sb.from('gunluk_girdiler').select('user_id,mallara_gore,zayi,odenmez,acilis,gelen,gelen_iade,transfer,kapanis');
  const {data:tumUrunler} = await sb.from('urunler').select('user_id,sira,ad,birim');

  let html = `<div class="admin-panel">
    <h2>‚≠ê Admin Paneli <span class="admin-badge">T√úM ≈ûUBELER</span></h2>
    <div style="font-size:12px;color:#999;margin-bottom:12px">${profiller.length} ≈üube kayƒ±tlƒ±</div>`;

  profiller.forEach(p => {
    const urunler = (tumUrunler||[]).filter(u => u.user_id === p.user_id);
    const girdiler = (tumGirdiler||[]).filter(g => g.user_id === p.user_id);
    const toplamGiris = girdiler.length;
    let toplamFark = 0;
    girdiler.forEach(g => {
      const e = {acilis:g.acilis,gelen:g.gelen,gelenIade:g.gelen_iade,transfer:g.transfer,kapanis:g.kapanis,mallara:g.mallara_gore,zayi:g.zayi,odenmez:g.odenmez};
      const {fark}=calcEntry(e);
      toplamFark+=fark;
    });
    toplamFark = r(toplamFark);
    const fc = toplamFark>0?'s-green':toplamFark<0?'s-red':'';

    html += `<div class="sube-card-admin">
      <h3>${p.sube_adi}</h3>
      <div class="sube-email">${p.user_id.slice(0,8)}...</div>
      <div class="sube-stats">
        <div class="sube-stat">${urunler.length} √ºr√ºn</div>
        <div class="sube-stat">${toplamGiris} giri≈ü</div>
        <div class="sube-stat ${fc}">${toplamFark>0?'+':''}${toplamFark} toplam fark</div>
      </div>
    </div>`;
  });

  html += `</div>`;
  document.getElementById('page-content').innerHTML = html;
}

// ============================================================
// PWA
// ============================================================
if('serviceWorker' in navigator && location.protocol !== 'file:') {
  navigator.serviceWorker.register('sw.js').catch(()=>{});
}
let deferredPrompt;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault(); deferredPrompt=e;
  document.getElementById('install-bar').classList.add('show');
});
function installApp(){
  if(deferredPrompt){deferredPrompt.prompt();deferredPrompt.userChoice.then(()=>{deferredPrompt=null;document.getElementById('install-bar').classList.remove('show');});}
}

// ============================================================
// BA≈ûLANGI√á ‚Äî Oturum Kontrol√º
// ============================================================
window.addEventListener('load', async () => {
  showScreen('loading-screen');
  const {data:{session}} = await sb.auth.getSession();
  if (session) {
    await onSignedIn(session.user);
  } else {
    showScreen('auth-screen');
  }

  sb.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_OUT') showScreen('auth-screen');
  });
});
</script>
</body>
</html>
